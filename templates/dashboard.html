{% extends "base_signed_in.html" %}

{% block title %}Dashboard - Droply{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/duolingo-buttons.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/translations.js') }}"></script>
<script src="{{ url_for('static', filename='js/duolingo-interactions.js') }}"></script>
<style>
  /* Ensure dashboard page has consistent dark background matching homepage */
  body {
    background: #1f1f1f !important;
    background-image: 
      radial-gradient(circle at 20% 20%, rgba(16, 185, 129, 0.04) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
      linear-gradient(135deg, rgba(16, 185, 129, 0.01) 0%, rgba(99, 102, 241, 0.01) 100%) !important;
  }
  
  .main-content, .content-wrapper {
    background: #1f1f1f !important;
    background-image: 
      radial-gradient(circle at 20% 20%, rgba(16, 185, 129, 0.04) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
      linear-gradient(135deg, rgba(16, 185, 129, 0.01) 0%, rgba(99, 102, 241, 0.01) 100%) !important;
  }
  
  .dashboard-container {
    background: #1f1f1f !important;
    background-image: 
      radial-gradient(circle at 20% 20%, rgba(16, 185, 129, 0.04) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
      linear-gradient(135deg, rgba(16, 185, 129, 0.01) 0%, rgba(99, 102, 241, 0.01) 100%) !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Duolingo-Style Quick Actions -->
  <div class="duolingo-quick-actions">
    <a href="{{ url_for('discover') }}" class="duolingo-action find">
      <div class="duolingo-action-icon">üîç</div>
      <span class="duolingo-action-text" data-translate="dashboard.find_experts">Find</span>
    </a>
    <a href="{{ url_for('profile') }}" class="duolingo-action profile">
      <div class="duolingo-action-icon">üë§</div>
      <span class="duolingo-action-text" data-translate="dashboard.edit_profile">Profile</span>
    </a>
    <a href="{{ url_for('availability') }}" class="duolingo-action hours">
      <div class="duolingo-action-icon">‚è∞</div>
      <span class="duolingo-action-text" data-translate="dashboard.set_availability">Hours</span>
    </a>
    <a href="{{ url_for('bookings') }}" class="duolingo-action bookings">
      <div class="duolingo-action-icon">üìÖ</div>
      <span class="duolingo-action-text" data-translate="dashboard.view_bookings">Bookings</span>
    </a>
    {% if current_user.hourly_rate > 0 %}
    <a href="{{ url_for('payment_setup') }}" class="duolingo-action payment">
      <div class="duolingo-action-icon">üí≥</div>
      <span class="duolingo-action-text" data-translate="dashboard.payment_setup">Payment</span>
    </a>
    {% endif %}
  </div>
  
  <!-- Next Booking Highlight -->
  {% if next_booking %}
  <div class="next-booking">
    <div class="next-booking-content">
      <h6>üìÖ Next Session</h6>
      <div class="next-booking-info">
        <strong>{% if next_booking.provider_id == current_user.id %}{{ next_booking.user.full_name or next_booking.client_name }}{% else %}{{ next_booking.provider.full_name }}{% endif %}</strong><br>
        {{ next_booking.start_time.strftime('%B %d at %I:%M %p') }}{% if next_booking.payment_amount %} ‚Ä¢ ${{ "%.0f"|format(next_booking.payment_amount) }}{% endif %}
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number">{{ total_sessions }}</div>
      <div class="stat-label">Total Sessions</div>
      <div class="stat-change positive">+{{ recent_bookings }} this week</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${{ "%.0f"|format(total_earnings) }}</div>
      <div class="stat-label">Total Earnings</div>
      <div class="stat-change positive">${{ "%.0f"|format(this_week_earnings) }} this week</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ total_provider_bookings }}</div>
      <div class="stat-label">Sessions Given</div>
      <div class="stat-change positive">{{ provider_bookings|length }} upcoming</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ total_client_bookings }}</div>
      <div class="stat-label">Sessions Booked</div>
      <div class="stat-change positive">{{ client_bookings|length }} upcoming</div>
    </div>
  </div>
  
  <!-- Full Width Earnings Chart -->
  <div class="earnings-chart-card full-width">
    <div class="earnings-chart-header">
      <h6>üìà Earnings (Past 28 Days)</h6>
    </div>
    <div class="earnings-chart-body">
      <div class="chart-container">
        <canvas id="earningsChart" width="400" height="200"></canvas>
      </div>
      <div class="chart-summary">
        <div class="chart-stat">
          <span class="chart-stat-label">Total</span>
          <span class="chart-stat-value">${{ "%.0f"|format(total_earnings) }}</span>
        </div>
        <div class="chart-stat">
          <span class="chart-stat-label">This Week</span>
          <span class="chart-stat-value">${{ "%.0f"|format(this_week_earnings) }}</span>
        </div>
        <div class="chart-stat">
          <span class="chart-stat-label">Avg/Day</span>
          <span class="chart-stat-value">${{ "%.0f"|format(total_earnings / 28) }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // Initialize earnings chart
  const ctx = document.getElementById('earningsChart');
  if (ctx) {
    // Generate sample data for the past 28 days
    const labels = [];
    const earnings = [];
    const today = new Date();
    
    for (let i = 27; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      
      // Generate sample earnings data (you can replace this with real data from your backend)
      const baseEarnings = {{ total_earnings }} / 28;
      const randomVariation = (Math.random() - 0.5) * baseEarnings * 0.5;
      earnings.push(Math.max(0, baseEarnings + randomVariation));
    }
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Daily Earnings',
          data: earnings,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              color: '#3a3a3a'
            },
            ticks: {
              color: '#9ca3af',
              maxTicksLimit: 7
            }
          },
          y: {
            grid: {
              color: '#3a3a3a'
            },
            ticks: {
              color: '#9ca3af',
              callback: function(value) {
                return '$' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
  }
  
  
  // Enhanced hover effects for stat cards
  const statCards = document.querySelectorAll('.stat-card');
  statCards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.2)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3)';
    });
  });
  
  // Enhanced click effects for quick actions
  const quickActions = document.querySelectorAll('.quick-action');
  quickActions.forEach(action => {
    action.addEventListener('click', function(e) {
      // Add a subtle click animation
      this.style.transform = 'scale(0.98)';
      setTimeout(() => {
        this.style.transform = '';
      }, 150);
    });
  });
  
  // Add loading states for better UX
  const statusItems = document.querySelectorAll('.status-item');
  statusItems.forEach(item => {
    item.addEventListener('click', function() {
      // Add subtle feedback for interactive elements
      this.style.transform = 'scale(1.02)';
      setTimeout(() => {
        this.style.transform = 'scale(1)';
      }, 150);
    });
  });
});
</script>
{% endblock %}