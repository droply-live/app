{% extends "base_signed_in.html" %}

{% block title %}Account - Droply{% endblock %}

{% block content %}
<div class="account-page">
  <!-- Account Header -->
  <div class="account-header">
    <h1 class="account-title">Account.</h1>
    <p class="account-subtitle">View your profile and manage your settings</p>
  </div>

  <div class="account-content">
    <!-- Left Column - Account Navigation -->
    <div class="account-sidebar">
      <!-- Profile Summary Card -->
      <div class="profile-summary-card">
        <div class="profile-avatar-placeholder-large"></div>
        <div class="profile-info-large">
          <div class="profile-name-large">{{ current_user.full_name or current_user.username }}</div>
          <div class="profile-joined-large">Joined in {{ current_user.created_at.strftime('%Y') if current_user.created_at else '2025' }}</div>
        </div>
      </div>

      <!-- Details Section -->
      <div class="account-section">
        <div class="section-title details">Details</div>
        <div class="section-items">
          <a href="#" class="section-item" data-tab="personal-info">
            <span>Personal information</span>
            <i class="fas fa-chevron-right"></i>
          </a>
          <a href="#" class="section-item" data-tab="availability">
            <span>Availability</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>

      <!-- Support Section -->
      <div class="account-section">
        <div class="section-title support">Support</div>
        <div class="section-items">
          <a href="#" class="section-item" data-tab="contact">
            <span>Contact us</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>

      <!-- Legal Section -->
      <div class="account-section">
        <div class="section-title support">Legal</div>
        <div class="section-items">
          <a href="#" class="section-item" data-tab="terms-of-service">
            <span>Terms of Service</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>

      <!-- Account Section -->
      <div class="account-section">
        <div class="section-title support">Account</div>
        <div class="section-items">
          <a href="{{ url_for('logout') }}" class="section-item text-danger">
            <span>Log out</span>
            <i class="fas fa-chevron-right"></i>
          </a>
          <a href="#" class="section-item text-danger" data-tab="delete-account">
            <span>Delete account</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Right Column - Content Area -->
    <div class="account-main-content">
      <div id="account-content-area" class="content-placeholder">
        <div class="content-placeholder-text">
          <i class="fas fa-user-circle"></i>
          <h3>Select an option to get started</h3>
          <p>Choose from the menu on the left to view and edit your account details</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionItems = document.querySelectorAll('.section-item');
  const contentArea = document.getElementById('account-content-area');

  sectionItems.forEach(item => {
    item.addEventListener('click', function(e) {
      // Skip logout link - let it navigate normally
      if (this.href && this.href.includes('logout')) {
        return;
      }
      
      e.preventDefault();
      
      // Remove active class from all items
      sectionItems.forEach(i => i.classList.remove('active'));
      
      // Add active class to clicked item
      this.classList.add('active');
      
      // Get the tab data
      const tab = this.getAttribute('data-tab');
      
      // Update content based on selected tab
      updateContent(tab);
    });
  });

  function updateContent(tab) {
    let content = '';
    
    switch(tab) {
      case 'personal-info':
        content = `
          <div class="tab-content">
            <h2>Personal Information</h2>
            <form class="account-form" id="personal-info-form">
              <div class="form-group">
                <label>Full Name</label>
                <input type="text" value="{{ current_user.full_name or '' }}" class="form-control" name="full_name">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" value="{{ current_user.email }}" class="form-control" disabled style="background-color: #f8f9fa; color: #666;">
                <small class="form-text">Email cannot be changed as it's used for authentication</small>
              </div>
              <div class="form-group">
                <label>Profession</label>
                <input type="text" value="{{ current_user.profession or '' }}" class="form-control" name="profession">
              </div>
              <div class="form-group">
                <label>Industry</label>
                <select class="form-control" name="industry">
                  <option value="">Select your industry</option>
                  <option value="technology" {{ 'selected' if current_user.industry == 'technology' else '' }}>Technology</option>
                  <option value="business" {{ 'selected' if current_user.industry == 'business' else '' }}>Business</option>
                  <option value="marketing" {{ 'selected' if current_user.industry == 'marketing' else '' }}>Marketing</option>
                  <option value="finance" {{ 'selected' if current_user.industry == 'finance' else '' }}>Finance</option>
                  <option value="healthcare" {{ 'selected' if current_user.industry == 'healthcare' else '' }}>Healthcare</option>
                  <option value="education" {{ 'selected' if current_user.industry == 'education' else '' }}>Education</option>
                  <option value="consulting" {{ 'selected' if current_user.industry == 'consulting' else '' }}>Consulting</option>
                  <option value="creative" {{ 'selected' if current_user.industry == 'creative' else '' }}>Creative</option>
                  <option value="fitness" {{ 'selected' if current_user.industry == 'fitness' else '' }}>Fitness & Wellness</option>
                  <option value="other" {{ 'selected' if current_user.industry == 'other' else '' }}>Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Bio</label>
                <textarea class="form-control" rows="4" name="bio">{{ current_user.bio or '' }}</textarea>
              </div>
              
              <div class="form-group">
                <label>Hourly Rate (USD)</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" name="hourly_rate" placeholder="0" min="0" value="{{ current_user.hourly_rate or '' }}">
                </div>
                <small class="form-text">Set to 0 if you offer free sessions</small>
              </div>
              
              <!-- Expertise Tags Section -->
              <div class="form-group">
                <label>Your Expertise & Specialties</label>
                <p class="form-text">Your selected expertise tags. Add new ones below.</p>
                
                <!-- Display Current Expertise Tags -->
                <div class="current-expertise-tags" id="currentExpertiseTags">
                  {% set user_tags = current_user.get_specialty_tags() or [] %}
                  {% for tag in user_tags %}
                    <span class="expertise-bubble">
                      {{ tag }}
                      <button type="button" class="remove-tag" onclick="removeExpertiseTag('{{ tag }}')">×</button>
                    </span>
                  {% endfor %}
                </div>
                
                <!-- Add New Expertise -->
                <div class="add-expertise-section">
                  <label>Add New Expertise</label>
                  <div class="custom-input-group">
                    <input type="text" id="newExpertise" class="form-control" placeholder="Enter your specialty">
                    <button type="button" class="btn btn-outline" onclick="addExpertiseTag()">Add</button>
                  </div>
                </div>
                      
              </div>
              
              <div class="auto-save-status" id="autoSaveStatus" style="display: none;">
                <span class="save-indicator">✓ Changes saved automatically</span>
              </div>
            </form>
          </div>
        `;
        break;
        
      case 'availability':
        content = `
          <div class="tab-content">
            <h2>Availability</h2>
            <div class="availability-setup">
              <div class="availability-header">
                <div class="header-info">
                  <h6 class="mb-1">Weekly Schedule</h6>
                  <p class="text-muted small mb-0">Set your time range and activate/deactivate 30-minute sessions</p>
                </div>
                <div class="header-actions">
                  <button type="button" class="btn btn-sm btn-outline-primary" id="quickSetupBtn">
                    <i class="fas fa-magic"></i> Quick Setup
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="copyWeekBtn">
                    <i class="fas fa-copy"></i> Copy Week
                  </button>
                </div>
              </div>
              
              <div class="availability-table">
                <div class="table-header">
                  <div class="day-column">Day</div>
                  <div class="time-column">Time Range</div>
                  <div class="sessions-column">Sessions (30 min each)</div>
                </div>
                
                <div class="table-row" data-day="0">
                  <div class="day-cell">
                    <div class="day-info">
                      <span class="day-name">Monday</span>
                      <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="0" checked>
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="time-cell">
                    <div class="time-range">
                      <input type="time" class="form-control form-control-sm start-time" value="09:00">
                      <span class="time-separator">to</span>
                      <input type="time" class="form-control form-control-sm end-time" value="17:00">
                    </div>
                  </div>
                  <div class="sessions-cell">
                    <div class="sessions-grid" data-day="0">
                      <!-- Sessions will be generated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <div class="table-row" data-day="1">
                  <div class="day-cell">
                    <div class="day-info">
                      <span class="day-name">Tuesday</span>
                      <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="1" checked>
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="time-cell">
                    <div class="time-range">
                      <input type="time" class="form-control form-control-sm start-time" value="09:00">
                      <span class="time-separator">to</span>
                      <input type="time" class="form-control form-control-sm end-time" value="17:00">
                    </div>
                  </div>
                  <div class="sessions-cell">
                    <div class="sessions-grid" data-day="1">
                      <!-- Sessions will be generated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <div class="table-row" data-day="2">
                  <div class="day-cell">
                    <div class="day-info">
                      <span class="day-name">Wednesday</span>
                      <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="2" checked>
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="time-cell">
                    <div class="time-range">
                      <input type="time" class="form-control form-control-sm start-time" value="09:00">
                      <span class="time-separator">to</span>
                      <input type="time" class="form-control form-control-sm end-time" value="17:00">
                    </div>
                  </div>
                  <div class="sessions-cell">
                    <div class="sessions-grid" data-day="2">
                      <!-- Sessions will be generated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <div class="table-row" data-day="3">
                  <div class="day-cell">
                    <div class="day-info">
                      <span class="day-name">Thursday</span>
                      <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="3" checked>
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="time-cell">
                    <div class="time-range">
                      <input type="time" class="form-control form-control-sm start-time" value="09:00">
                      <span class="time-separator">to</span>
                      <input type="time" class="form-control form-control-sm end-time" value="17:00">
                    </div>
                  </div>
                  <div class="sessions-cell">
                    <div class="sessions-grid" data-day="3">
                      <!-- Sessions will be generated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <div class="table-row" data-day="4">
                  <div class="day-cell">
                    <div class="day-info">
                      <span class="day-name">Friday</span>
                      <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="4" checked>
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="time-cell">
                    <div class="time-range">
                      <input type="time" class="form-control form-control-sm start-time" value="09:00">
                      <span class="time-separator">to</span>
                      <input type="time" class="form-control form-control-sm end-time" value="17:00">
                    </div>
                  </div>
                  <div class="sessions-cell">
                    <div class="sessions-grid" data-day="4">
                      <!-- Sessions will be generated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <div class="table-row" data-day="5">
                  <div class="day-cell">
                    <div class="day-info">
                      <span class="day-name">Saturday</span>
                      <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="5">
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="time-cell">
                    <div class="time-range">
                      <input type="time" class="form-control form-control-sm start-time" value="10:00">
                      <span class="time-separator">to</span>
                      <input type="time" class="form-control form-control-sm end-time" value="15:00">
                    </div>
                  </div>
                  <div class="sessions-cell">
                    <div class="sessions-grid" data-day="5">
                      <!-- Sessions will be generated by JavaScript -->
                    </div>
                  </div>
                </div>
                
                <div class="table-row" data-day="6">
                  <div class="day-cell">
                    <div class="day-info">
                      <span class="day-name">Sunday</span>
                      <label class="switch">
                        <input type="checkbox" class="day-toggle" data-day="6">
                        <span class="slider"></span>
                      </label>
                    </div>
                  </div>
                  <div class="time-cell">
                    <div class="time-range">
                      <input type="time" class="form-control form-control-sm start-time" value="10:00">
                      <span class="time-separator">to</span>
                      <input type="time" class="form-control form-control-sm end-time" value="15:00">
                    </div>
                  </div>
                  <div class="sessions-cell">
                    <div class="sessions-grid" data-day="6">
                      <!-- Sessions will be generated by JavaScript -->
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="availability-footer">
                <div class="footer-info">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Each session is 30 minutes. Toggle sessions on/off to set your availability.
                  </small>
                </div>
                <div class="footer-actions">
                  <button type="button" class="btn btn-outline-secondary" id="clearAllBtn">
                    <i class="fas fa-trash"></i> Clear All
                  </button>
                  <button type="button" class="btn btn-primary" id="saveAvailabilityBtn">
                    <i class="fas fa-save"></i> Save Availability
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        break;
        

        
      case 'contact':
        content = `
          <div class="tab-content">
            <h2>Contact Us</h2>
            <div class="contact-info">
              <p>Need help? Reach out to our support team:</p>
              <ul>
                <li><strong>Email:</strong> support@droply.live</li>
                <li><strong>Response time:</strong> Within 24 hours</li>
              </ul>
            </div>
          </div>
        `;
        break;
        

        break;
        
      case 'terms-of-service':
        content = `
          <div class="tab-content">
            <h2>Terms of Service</h2>
            <div class="legal-content">
              <p>By using Droply, you agree to our terms of service. Please read carefully before proceeding.</p>
              <div class="terms-section">
                <h3>1. Service Description</h3>
                <p>Droply connects users with experts for video consultations and advice.</p>
                
                <h3>2. User Responsibilities</h3>
                <p>Users are responsible for providing accurate information and maintaining appropriate conduct during sessions.</p>
                
                <h3>3. Payment Terms</h3>
                <p>All payments are processed securely through Stripe. Refunds are handled on a case-by-case basis.</p>
                
                <h3>4. Privacy</h3>
                <p>We protect your personal information and never sell your data to third parties.</p>
              </div>
            </div>
          </div>
        `;
        break;
        
      case 'delete-account':
        content = `
          <div class="tab-content">
            <h2>Delete Account</h2>
            <div class="delete-account-warning">
              <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>This action cannot be undone</h3>
                <p>Deleting your account will permanently remove all your data, including:</p>
                <ul>
                  <li>Profile information</li>
                  <li>Booking history</li>
                  <li>Payment methods</li>
                  <li>All associated data</li>
                </ul>
                <p><strong>This action is irreversible.</strong></p>
              </div>
              <form class="account-form" action="{{ url_for('delete_account') }}" method="POST" onsubmit="return validateDeleteForm()" id="delete-account-form">
                <div class="form-group">
                  <label>Type "DELETE" to confirm</label>
                  <input type="text" placeholder="DELETE" class="form-control" id="delete-confirmation" name="confirmation" required>
                </div>
                <div class="form-group">
                  <label>Reason for deletion (optional)</label>
                  <textarea class="form-control" rows="3" placeholder="Help us improve by sharing your reason..." name="reason"></textarea>
                </div>
                <button type="submit" class="btn btn-danger" disabled id="delete-account-btn">
                  <span id="delete-btn-text">Delete Account Permanently</span>
                  <span id="delete-btn-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Deleting...
                  </span>
                </button>
              </form>
            </div>
          </div>
        `;
        
        // Add confirmation logic for delete account
        setTimeout(() => {
          const deleteConfirmation = document.getElementById('delete-confirmation');
          const deleteBtn = document.getElementById('delete-account-btn');
          const deleteForm = document.getElementById('delete-account-form');
          
          console.log('Setting up delete account form elements:', {
            deleteConfirmation: !!deleteConfirmation,
            deleteBtn: !!deleteBtn,
            deleteForm: !!deleteForm
          });
          
          if (deleteConfirmation && deleteBtn) {
            deleteConfirmation.addEventListener('input', function() {
              const isEnabled = this.value === 'DELETE';
              deleteBtn.disabled = !isEnabled;
              console.log('Delete button enabled:', isEnabled);
            });
          }
          
          // Add form submit listener for debugging
          if (deleteForm) {
            deleteForm.addEventListener('submit', function(e) {
              console.log('Form submit event triggered');
            });
          }
        }, 100);
        break;
        
      default:
        content = `
          <div class="content-placeholder-text">
            <i class="fas fa-user-circle"></i>
            <h3>Select an option to get started</h3>
            <p>Choose from the menu on the left to view and edit your account details</p>
          </div>
        `;
    }
    
    contentArea.innerHTML = content;
  }
});

// Form validation function
function validateDeleteForm() {
  console.log('validateDeleteForm called');
  const confirmation = document.getElementById('delete-confirmation');
  const deleteForm = document.getElementById('delete-account-form');
  
  console.log('Form elements found:', {
    confirmation: !!confirmation,
    deleteForm: !!deleteForm,
    confirmationValue: confirmation ? confirmation.value : 'No confirmation field'
  });
  
  if (!confirmation || confirmation.value !== 'DELETE') {
    alert('Please type "DELETE" exactly to confirm account deletion.');
    return false;
  }
  
  // Show confirmation dialog
  const confirmed = confirm('Are you absolutely sure you want to permanently delete your account? This action cannot be undone and will cancel all your meetings.');
  if (!confirmed) {
    return false;
  }
  
  // Show loading state
  const deleteBtn = document.getElementById('delete-account-btn');
  const btnText = document.getElementById('delete-btn-text');
  const btnLoading = document.getElementById('delete-btn-loading');
  
  if (deleteBtn && btnText && btnLoading) {
    deleteBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
  }
  
  console.log('Form validation passed, submitting...');
  return true;
}

// Add new expertise tag
function addExpertiseTag() {
  const input = document.getElementById('newExpertise');
  const value = input.value.trim();
  
  if (value) {
    const currentTags = document.getElementById('currentExpertiseTags');
    const newTag = document.createElement('span');
    newTag.className = 'expertise-bubble';
    newTag.innerHTML = `
      ${value}
      <button type="button" class="remove-tag" onclick="removeExpertiseTag('${value}')">×</button>
    `;
    currentTags.appendChild(newTag);
    input.value = '';
    
    // Auto-save after adding tag
    autoSaveProfile();
  }
}

// Remove expertise tag
function removeExpertiseTag(tagName) {
  const bubbles = document.querySelectorAll('.expertise-bubble');
  bubbles.forEach(bubble => {
    if (bubble.textContent.trim().replace('×', '').trim() === tagName) {
      bubble.remove();
      
      // Auto-save after removing tag
      autoSaveProfile();
    }
  });
}

// Auto-save functionality
let saveTimeout;
const autoSaveStatus = document.getElementById('autoSaveStatus');

function showAutoSaveStatus() {
  if (autoSaveStatus) {
    autoSaveStatus.style.display = 'block';
    setTimeout(() => {
      autoSaveStatus.style.display = 'none';
    }, 3000);
  }
}

function autoSaveProfile() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    const form = document.getElementById('personal-info-form');
    if (!form) return;
    
    // Collect form data
    const formData = new FormData(form);
    const expertise = Array.from(document.querySelectorAll('.expertise-bubble'))
      .map(bubble => bubble.textContent.trim().replace('×', '').trim());
    
    // Add expertise to form data
    formData.append('expertise', JSON.stringify(expertise));
    
    // Submit to server
    fetch('/api/profile/update', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showAutoSaveStatus();
      } else {
        console.error('Error:', data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }, 1000); // Save after 1 second of no changes
}

// Handle personal info form changes
document.addEventListener('DOMContentLoaded', function() {
  const personalInfoForm = document.getElementById('personal-info-form');
  if (personalInfoForm) {
    // Auto-save on input changes
    const inputs = personalInfoForm.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
      input.addEventListener('input', autoSaveProfile);
      input.addEventListener('change', autoSaveProfile);
    });
  }
});
</script>

<style>
/* Expertise Tags Styles */
.expertise-categories {
    margin-bottom: 20px;
}

.expertise-category {
    margin-bottom: 20px;
}

.expertise-category h4 {
    font-weight: 600;
    color: #1a3a6d;
    margin-bottom: 10px;
    font-size: 1rem;
}

.expertise-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.expertise-tag {
    cursor: pointer;
    user-select: none;
}

.expertise-tag input {
    display: none;
}

.expertise-tag span {
    display: inline-block;
    padding: 8px 12px;
    background: #f8f9fa;
    border: 2px solid #e3f0ff;
    border-radius: 20px;
    font-size: 0.85rem;
    color: #1a3a6d;
    transition: all 0.2s;
}

.expertise-tag input:checked + span {
    background: #3c78ff;
    color: white;
    border-color: #3c78ff;
}

.expertise-tag:hover span {
    border-color: #3c78ff;
    background: #e3f0ff;
}

.custom-expertise {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e3f0ff;
}

.custom-expertise h4 {
    font-weight: 600;
    color: #1a3a6d;
    margin-bottom: 10px;
    font-size: 1rem;
}

.custom-input-group {
    display: flex;
    gap: 10px;
}

.custom-input-group .form-control {
    flex: 1;
}

.custom-input-group .btn {
    padding: 8px 16px;
    font-size: 0.9rem;
}

.form-text {
    font-size: 0.9rem;
    color: #666;
    margin-top: 5px;
}

/* Current Expertise Bubbles */
.current-expertise-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
    min-height: 40px;
}

.expertise-bubble {
    display: inline-flex;
    align-items: center;
    padding: 8px 12px;
    background: #3c78ff;
    color: white;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    gap: 8px;
}

.remove-tag {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    padding: 0;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.remove-tag:hover {
    background: rgba(255, 255, 255, 0.2);
}

.add-expertise-section {
    margin-top: 20px;
}

.add-expertise-section label {
    display: block;
    font-weight: 600;
    color: #1a3a6d;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.custom-input-group .btn {
    background: #3c78ff;
    color: white;
    border: 2px solid #3c78ff;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.custom-input-group .btn:hover {
    background: #2d5fcc;
    border-color: #2d5fcc;
}

/* Input Group Styles */
.input-group {
    display: flex;
    align-items: stretch;
    width: 100%;
}

.input-group-text {
    padding: 12px 16px;
    background: #f8f9fa;
    border: 2px solid #e3f0ff;
    border-right: none;
    border-radius: 8px 0 0 8px;
    color: #666;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    white-space: nowrap;
}

.input-group .form-control {
    border-left: none;
    border-radius: 0 8px 8px 0;
    flex: 1;
}

/* Auto-save Status */
.auto-save-status {
    margin-top: 15px;
    padding: 10px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    text-align: center;
}

.save-indicator {
    color: #155724;
    font-size: 0.9rem;
    font-weight: 500;
}

/* Availability Setup Styles */
.availability-setup {
  padding: 0.5rem 0;
}

.availability-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e0e0e0;
}

.header-info h6 {
  margin-bottom: 0.25rem;
}

.header-actions {
  display: flex;
  gap: 0.5rem;
}

.availability-table {
  border-collapse: collapse;
  width: 100%;
  margin-bottom: 1.5rem;
}

.table-header {
  background: #f8f9fa;
  border: 1px solid #e0e0e0;
  border-radius: 10px 10px 0 0;
  padding: 0.75rem 1rem;
  font-weight: 600;
  color: #333;
  font-size: 0.9rem;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 0.5rem;
}

.table-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e0e0e0;
  align-items: center;
}

.table-row:last-child {
  border-bottom: none;
}

.day-cell, .time-cell, .sessions-cell {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.day-name {
  font-weight: 600;
  color: #333;
  font-size: 1rem;
}

.day-toggle {
  position: relative;
  width: 40px;
  height: 20px;
}

.day-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 20px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

.day-toggle input:checked + .slider {
  background-color: #3c78ff;
}

.day-toggle input:focus + .slider {
  box-shadow: 0 0 1px #3c78ff;
}

.day-toggle input:checked + .slider:before {
  transform: translateX(20px);
}

.time-range {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.time-range input[type="time"] {
  flex: 1;
  max-width: 80px;
  text-align: center;
}

.time-separator {
  color: #666;
  font-size: 0.875rem;
}

.sessions-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 0.5rem 0;
}

.session-toggle {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.session-toggle input {
  position: relative;
  width: 20px;
  height: 20px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  border: 2px solid #ccc;
  border-radius: 50%;
  background-color: #fff;
  cursor: pointer;
  transition: all 0.2s;
}

.session-toggle input:checked {
  background-color: #3c78ff;
  border-color: #3c78ff;
}

.session-toggle input:checked:after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 10px;
  height: 10px;
  background: white;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

.session-toggle input:hover {
  border-color: #3c78ff;
}

.session-toggle input:focus {
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.availability-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid #e0e0e0;
}

.footer-info {
  flex: 1;
}

.footer-actions {
  display: flex;
  gap: 0.5rem;
}

.footer-actions .btn {
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .availability-table {
    grid-template-columns: 1fr;
  }
  
  .table-header {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .table-row {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .day-cell, .time-cell, .sessions-cell {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .day-toggle {
    width: 100%;
    max-width: 150px;
  }
  
  .time-range input[type="time"] {
    max-width: none;
  }
  
  .sessions-grid {
    justify-content: center;
  }
  
  .availability-footer {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }
  
  .footer-actions {
    justify-content: space-between;
  }
}
</style>

<script>
// Availability functionality
document.addEventListener('DOMContentLoaded', function() {
  // Initialize availability functionality when availability tab is loaded
  function initializeAvailability() {
    console.log('Initializing availability...');
    
    const dayToggles = document.querySelectorAll('.day-toggle');
    const copyScheduleBtn = document.getElementById('copyWeekBtn');
    const clearScheduleBtn = document.getElementById('clearAllBtn');
    const saveAvailabilityBtn = document.getElementById('saveAvailabilityBtn');
    
    console.log(`Found ${dayToggles.length} day toggles`);
    
    if (!dayToggles.length) {
      console.log('No day toggles found - not on availability tab');
      return; // Not on availability tab
    }
    
    // Generate session toggles for each day
    console.log('Generating session toggles...');
    generateSessionToggles();
    
    // Handle time range changes
    document.querySelectorAll('.start-time, .end-time').forEach(input => {
      input.addEventListener('change', function() {
        const day = this.closest('.table-row').getAttribute('data-day');
        console.log(`Time range changed for day ${day}`);
        generateSessionTogglesForDay(day);
      });
    });
    
    // Handle day toggle changes
    dayToggles.forEach(toggle => {
      toggle.addEventListener('change', function() {
        const dayRow = this.closest('.table-row');
        const sessionsGrid = dayRow.querySelector('.sessions-grid');
        
        if (this.checked) {
          dayRow.classList.remove('inactive');
          sessionsGrid.style.display = 'flex';
        } else {
          dayRow.classList.add('inactive');
          sessionsGrid.style.display = 'none';
        }
      });
    });
    
    // Add time slot functionality
    document.querySelectorAll('.add-slot-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const day = this.closest('.table-row').getAttribute('data-day');
        const sessionsGrid = document.querySelector(`.sessions-grid[data-day="${day}"]`);
        
        const newSessionToggle = document.createElement('div');
        newSessionToggle.className = 'session-toggle';
        newSessionToggle.innerHTML = `
          <input type="checkbox" class="session-toggle" data-day="${day}" data-time="09:00">
          <span>09:00</span>
        `;
        
        sessionsGrid.appendChild(newSessionToggle);
        
        // Add remove functionality to new slot
        const removeBtn = newSessionToggle.querySelector('.remove-slot');
        removeBtn.addEventListener('click', function() {
          newSessionToggle.remove();
        });
      });
    });
    
    // Quick Setup functionality
    const quickSetupBtn = document.getElementById('quickSetupBtn');
    if (quickSetupBtn) {
      quickSetupBtn.addEventListener('click', function() {
        if (confirm('This will set up a standard 9 AM - 5 PM schedule for weekdays and 10 AM - 3 PM for weekends. Continue?')) {
          // Set up weekdays (Mon-Fri)
          for (let i = 0; i <= 4; i++) {
            const dayRow = document.querySelector(`.table-row[data-day="${i}"]`);
            const toggle = dayRow.querySelector('.day-toggle');
            const startTimeInput = dayRow.querySelector('.start-time');
            const endTimeInput = dayRow.querySelector('.end-time');
            
            // Enable the day
            toggle.checked = true;
            dayRow.classList.remove('inactive');
            
            // Set time range to 9 AM - 5 PM
            startTimeInput.value = '09:00';
            endTimeInput.value = '17:00';
            
            // Regenerate sessions
            generateSessionTogglesForDay(i);
            
            // Activate all sessions
            const sessions = dayRow.querySelectorAll('.session-toggle input');
            sessions.forEach(session => {
              session.checked = true;
              session.closest('.session-toggle').classList.add('active');
            });
          }
          
          // Set up weekends (Sat-Sun)
          for (let i = 5; i <= 6; i++) {
            const dayRow = document.querySelector(`.table-row[data-day="${i}"]`);
            const toggle = dayRow.querySelector('.day-toggle');
            const startTimeInput = dayRow.querySelector('.start-time');
            const endTimeInput = dayRow.querySelector('.end-time');
            
            // Enable the day
            toggle.checked = true;
            dayRow.classList.remove('inactive');
            
            // Set time range to 10 AM - 3 PM
            startTimeInput.value = '10:00';
            endTimeInput.value = '15:00';
            
            // Regenerate sessions
            generateSessionTogglesForDay(i);
            
            // Activate all sessions
            const sessions = dayRow.querySelectorAll('.session-toggle input');
            sessions.forEach(session => {
              session.checked = true;
              session.closest('.session-toggle').classList.add('active');
            });
          }
        }
      });
    }
    
    // Copy Week functionality
    if (copyScheduleBtn) {
      copyScheduleBtn.addEventListener('click', function() {
        const activeDay = document.querySelector('.table-row:not(.inactive)');
        if (!activeDay) {
          alert('Please select at least one day first');
          return;
        }
        
        const activeDayIndex = parseInt(activeDay.getAttribute('data-day'));
        const activeSessions = activeDay.querySelectorAll('.session-toggle input:checked');
        
        if (activeSessions.length === 0) {
          alert('Please activate at least one session to copy');
          return;
        }
        
        // Copy to all other enabled days
        dayToggles.forEach(toggle => {
          const dayRow = toggle.closest('.table-row');
          const dayIndex = parseInt(dayRow.getAttribute('data-day'));
          
          if (dayIndex !== activeDayIndex && toggle.checked) {
            // Copy the session pattern
            const targetSessions = dayRow.querySelectorAll('.session-toggle input');
            targetSessions.forEach((session, index) => {
              const activeSession = activeSessions[index];
              if (activeSession) {
                session.checked = activeSession.checked;
                const sessionToggle = session.closest('.session-toggle');
                if (activeSession.checked) {
                  sessionToggle.classList.add('active');
                } else {
                  sessionToggle.classList.remove('active');
                }
              }
            });
          }
        });
        
        alert('Session pattern copied to all selected days!');
      });
    }
    
    // Clear all schedule
    if (clearScheduleBtn) {
      clearScheduleBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all availability settings?')) {
          dayToggles.forEach(toggle => {
            toggle.checked = false;
            const dayRow = toggle.closest('.table-row');
            dayRow.classList.add('inactive');
            const sessionsGrid = dayRow.querySelector('.sessions-grid');
            sessionsGrid.style.display = 'none';
          });
        }
      });
    }
    
    // Save availability
    if (saveAvailabilityBtn) {
      saveAvailabilityBtn.addEventListener('click', function() {
        saveAvailabilityRules();
      });
    }
    
    // Initialize day states
    dayToggles.forEach(toggle => {
      const dayRow = toggle.closest('.table-row');
      if (toggle.checked) {
        dayRow.classList.remove('inactive');
        const sessionsGrid = dayRow.querySelector('.sessions-grid');
        sessionsGrid.style.display = 'flex';
      } else {
        dayRow.classList.add('inactive');
        const sessionsGrid = dayRow.querySelector('.sessions-grid');
        sessionsGrid.style.display = 'none';
      }
    });
    
    // Load existing availability rules
    loadAvailabilityRules();
  }
  
  // Generate session toggles for all days
  function generateSessionToggles() {
    for (let day = 0; day <= 6; day++) {
      generateSessionTogglesForDay(day);
    }
  }
  
  // Generate session toggles for a specific day
  function generateSessionTogglesForDay(day) {
    const dayRow = document.querySelector(`.table-row[data-day="${day}"]`);
    if (!dayRow) {
      console.log(`Day row not found for day ${day}`);
      return;
    }
    
    const startTime = dayRow.querySelector('.start-time').value;
    const endTime = dayRow.querySelector('.end-time').value;
    const sessionsGrid = dayRow.querySelector('.sessions-grid');
    
    console.log(`Generating sessions for day ${day}: ${startTime} to ${endTime}`);
    
    if (!startTime || !endTime) {
      console.log('Start or end time not found');
      return;
    }
    
    if (!sessionsGrid) {
      console.log('Sessions grid not found');
      return;
    }
    
    // Clear existing sessions
    sessionsGrid.innerHTML = '';
    
    // Calculate sessions
    const start = new Date(`2000-01-01T${startTime}`);
    const end = new Date(`2000-01-01T${endTime}`);
    const sessionDuration = 30; // 30 minutes
    
    let current = new Date(start);
    let sessionIndex = 0;
    
    console.log(`Creating sessions from ${start.toTimeString()} to ${end.toTimeString()}`);
    
    while (current < end) {
      const sessionTime = current.toTimeString().slice(0, 5);
      const sessionToggle = document.createElement('div');
      sessionToggle.className = 'session-toggle';
      sessionToggle.innerHTML = `
        <input type="checkbox" data-day="${day}" data-time="${sessionTime}" data-index="${sessionIndex}">
        <span>${sessionTime}</span>
      `;
      
      sessionsGrid.appendChild(sessionToggle);
      
      // Add event listener
      const checkbox = sessionToggle.querySelector('input');
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          sessionToggle.classList.add('active');
        } else {
          sessionToggle.classList.remove('active');
        }
      });
      
      // Move to next session
      current.setMinutes(current.getMinutes() + sessionDuration);
      sessionIndex++;
    }
    
    console.log(`Created ${sessionIndex} sessions for day ${day}`);
  }
  
  // Load existing availability rules
  function loadAvailabilityRules() {
    fetch('/api/availability/rules')
      .then(response => response.json())
      .then(rules => {
        rules.forEach(rule => {
          const daySlot = document.querySelector(`.calendar-day[data-day="${rule.weekday}"]`);
          if (daySlot) {
            const checkbox = daySlot.querySelector('.day-toggle');
            const timeSlotsContainer = daySlot.querySelector('.time-slots-container');
            const addSlotBtn = daySlot.querySelector('.add-slot-btn');
            
            // Check the day
            checkbox.checked = true;
            daySlot.classList.remove('inactive');
            daySlot.classList.add('active');
            timeSlotsContainer.style.display = 'flex';
            addSlotBtn.style.display = 'block';
            
            // Set the time
            const startTime = daySlot.querySelector('.start-time');
            const endTime = daySlot.querySelector('.end-time');
            if (startTime && endTime) {
              startTime.value = rule.start;
              endTime.value = rule.end;
            }
          }
        });
      })
      .catch(error => {
        console.error('Error loading availability rules:', error);
      });
  }
  
  // Save availability rules
  function saveAvailabilityRules() {
    const rules = [];
    
    document.querySelectorAll('.table-row').forEach(dayRow => {
      const day = parseInt(dayRow.getAttribute('data-day'));
      const dayToggle = dayRow.querySelector('.day-toggle');
      const startTime = dayRow.querySelector('.start-time').value;
      const endTime = dayRow.querySelector('.end-time').value;
      const activeSessions = dayRow.querySelectorAll('.session-toggle input:checked');
      
      if (dayToggle.checked && startTime && endTime) {
        // Group consecutive active sessions
        const sessionTimes = Array.from(activeSessions).map(input => input.getAttribute('data-time')).sort();
        
        if (sessionTimes.length > 0) {
          let currentStart = sessionTimes[0];
          let currentEnd = sessionTimes[0];
          
          for (let i = 1; i < sessionTimes.length; i++) {
            const currentTime = sessionTimes[i];
            const prevTime = sessionTimes[i - 1];
            
            // Check if sessions are consecutive (30 min apart)
            const current = new Date(`2000-01-01T${currentTime}`);
            const prev = new Date(`2000-01-01T${prevTime}`);
            const diffMinutes = (current - prev) / (1000 * 60);
            
            if (diffMinutes === 30) {
              currentEnd = currentTime;
            } else {
              // End current range and start new one
              rules.push({
                weekday: day,
                start: currentStart,
                end: addMinutes(currentEnd, 30), // Add 30 minutes to get end time
                enabled: true
              });
              currentStart = currentTime;
              currentEnd = currentTime;
            }
          }
          
          // Add the last range
          rules.push({
            weekday: day,
            start: currentStart,
            end: addMinutes(currentEnd, 30),
            enabled: true
          });
        }
      }
    });
    
    // Helper function to add minutes to time string
    function addMinutes(timeStr, minutes) {
      const time = new Date(`2000-01-01T${timeStr}`);
      time.setMinutes(time.getMinutes() + minutes);
      return time.toTimeString().slice(0, 5);
    }
    
    // Save to server
    fetch('/api/availability/rules', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ rules: rules })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Availability saved successfully!');
      } else {
        alert('Error saving availability');
      }
    })
    .catch(error => {
      console.error('Error saving availability rules:', error);
      alert('Error saving availability');
    });
  }
  
  // Initialize availability when tab is loaded
  const originalUpdateContent = window.updateContent;
  window.updateContent = function(tab) {
    originalUpdateContent(tab);
    if (tab === 'availability') {
      setTimeout(initializeAvailability, 100);
    }
  };
  
  // Also initialize when DOM is loaded (in case tab is already active)
  if (document.querySelector('.availability-setup')) {
    setTimeout(initializeAvailability, 100);
  }
  
  // Override the updateContent function to properly handle availability
  if (typeof window.updateContent === 'function') {
    const originalUpdateContent = window.updateContent;
    window.updateContent = function(tab) {
      originalUpdateContent(tab);
      if (tab === 'availability') {
        setTimeout(initializeAvailability, 100);
      }
    };
  } else {
    window.updateContent = function(tab) {
      if (tab === 'availability') {
        setTimeout(initializeAvailability, 100);
      }
    };
  }
});
</script>
{% endblock %} 