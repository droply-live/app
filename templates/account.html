{% extends "base_signed_in.html" %}

{% block title %}Account - Droply{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Account Header -->
  <div class="mb-4">
    <h1 class="h2 mb-1">Account</h1>
    <p class="text-muted mb-0">View your profile and manage your settings</p>
  </div>

  <!-- Tabbed Interface -->
  <div id="account-tabs" class="tabbed-interface">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="personal-info">
        <i class="fas fa-user d-none d-md-inline"></i>
        <span>Profile</span>
      </button>
      <button class="tab-button" data-tab="availability">
        <i class="fas fa-calendar d-none d-md-inline"></i>
        <span>Availability</span>
      </button>
      <button class="tab-button" data-tab="settings">
        <i class="fas fa-cog d-none d-md-inline"></i>
        <span>Settings</span>
      </button>
      <button class="tab-button" data-tab="support">
        <i class="fas fa-question-circle d-none d-md-inline"></i>
        <span>Support</span>
      </button>
    </div>
    <div class="tab-indicator"></div>

    <!-- Tab Content Container -->
    <div class="tab-content-container">
      <!-- Personal Info Tab -->
      <div class="tab-content active" data-tab-content="personal-info">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Update your profile details and preferences</p>
          </div>
          <div class="tab-actions">
            <div id="save-status" class="save-status" style="display: none;">
              <i class="fas fa-check-circle text-success"></i>
              <span>Saved</span>
            </div>
          </div>
        </div>

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-user-circle"></i>
            Profile Details
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="full_name" class="form-control" value="{{ current_user.full_name or '' }}" placeholder="Enter your full name">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
                    <small class="text-muted">Username cannot be changed</small>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" value="{{ current_user.email }}" readonly>
                    <small class="text-muted">Email cannot be changed</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" class="form-control" value="{{ current_user.phone or '' }}" placeholder="Enter your phone number">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label>Bio</label>
                <textarea id="bio" class="form-control" rows="3" placeholder="Tell us about yourself">{{ current_user.bio or '' }}</textarea>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Availability Tab -->
      <div class="tab-content" data-tab-content="availability">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Set when you're available for sessions</p>
          </div>
          <div class="tab-actions">
            <button id="save-availability-btn" class="tab-action-btn primary">
              <i class="fas fa-save"></i>
              Save Availability
            </button>
          </div>
        </div>

        <!-- Google Calendar Integration -->
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fab fa-google"></i>
            Google Calendar Integration
          </h3>
          <div class="card">
            <div class="card-body">
              <div id="calendar-connection-status">
                <div class="alert alert-info" id="calendar-not-connected">
                  <i class="fas fa-info-circle"></i>
                  <strong>Connect your Google Calendar</strong><br>
                  Sync your calendar to automatically block times when you're busy. This ensures clients can only book when you're actually available.
                </div>
                <div class="alert alert-success" id="calendar-connected" style="display: none;">
                  <i class="fas fa-check-circle"></i>
                  <strong>Google Calendar Connected</strong><br>
                  Your calendar is synced and will automatically block busy times.
                </div>
              </div>
              
              <div class="calendar-actions">
                <a href="/auth/google-calendar" class="btn btn-primary" id="connect-calendar-btn">
                  <i class="fab fa-google"></i>
                  Connect Google Calendar
                </a>
                <button class="btn btn-outline-secondary" id="sync-calendar-btn" style="display: none;">
                  <i class="fas fa-sync"></i>
                  Sync Calendar
                </button>
                <form action="/disconnect-google-calendar" method="POST" style="display: inline;" id="disconnect-calendar-form">
                  <button type="submit" class="btn btn-outline-danger" id="disconnect-calendar-btn" style="display: none;">
                    <i class="fas fa-unlink"></i>
                    Disconnect
                  </button>
                </form>
              </div>
              
              <div id="sync-status" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                  <i class="fas fa-spinner fa-spin"></i>
                  Syncing calendar events...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Weekly Schedule -->
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-clock"></i>
            Weekly Schedule
          </h3>
          <div class="card">
            <div class="card-body">
              <p class="text-muted">Configure your availability for each day of the week. Clients will see these times when booking sessions with you.</p>
              
              <div class="availability-schedule">
                <div class="row">
                  <div class="col-md-8">
                    <div class="schedule-grid">
                      <div class="schedule-header">
                        <div class="day-header">Day</div>
                        <div class="time-header">Available Hours</div>
                        <div class="action-header">Action</div>
                      </div>
                      
                      <div class="schedule-row" data-day="0">
                        <div class="day-cell">
                          <div class="day-name">Monday</div>
                        </div>
                        <div class="time-cell">
                          <div class="time-inputs">
                            <input type="time" class="form-control time-start" value="09:00">
                            <span class="time-separator">to</span>
                            <input type="time" class="form-control time-end" value="17:00">
                          </div>
                        </div>
                        <div class="action-cell">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input day-enabled" id="day-0">
                            <label class="form-check-label" for="day-0">Available</label>
                          </div>
                        </div>
                      </div>
                      
                      <div class="schedule-row" data-day="1">
                        <div class="day-cell">
                          <div class="day-name">Tuesday</div>
                        </div>
                        <div class="time-cell">
                          <div class="time-inputs">
                            <input type="time" class="form-control time-start" value="09:00">
                            <span class="time-separator">to</span>
                            <input type="time" class="form-control time-end" value="17:00">
                          </div>
                        </div>
                        <div class="action-cell">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input day-enabled" id="day-1">
                            <label class="form-check-label" for="day-1">Available</label>
                          </div>
                        </div>
                      </div>
                      
                      <div class="schedule-row" data-day="2">
                        <div class="day-cell">
                          <div class="day-name">Wednesday</div>
                        </div>
                        <div class="time-cell">
                          <div class="time-inputs">
                            <input type="time" class="form-control time-start" value="09:00">
                            <span class="time-separator">to</span>
                            <input type="time" class="form-control time-end" value="17:00">
                          </div>
                        </div>
                        <div class="action-cell">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input day-enabled" id="day-2">
                            <label class="form-check-label" for="day-2">Available</label>
                          </div>
                        </div>
                      </div>
                      
                      <div class="schedule-row" data-day="3">
                        <div class="day-cell">
                          <div class="day-name">Thursday</div>
                        </div>
                        <div class="time-cell">
                          <div class="time-inputs">
                            <input type="time" class="form-control time-start" value="09:00">
                            <span class="time-separator">to</span>
                            <input type="time" class="form-control time-end" value="17:00">
                          </div>
                        </div>
                        <div class="action-cell">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input day-enabled" id="day-3">
                            <label class="form-check-label" for="day-3">Available</label>
                          </div>
                        </div>
                      </div>
                      
                      <div class="schedule-row" data-day="4">
                        <div class="day-cell">
                          <div class="day-name">Friday</div>
                        </div>
                        <div class="time-cell">
                          <div class="time-inputs">
                            <input type="time" class="form-control time-start" value="09:00">
                            <span class="time-separator">to</span>
                            <input type="time" class="form-control time-end" value="17:00">
                          </div>
                        </div>
                        <div class="action-cell">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input day-enabled" id="day-4">
                            <label class="form-check-label" for="day-4">Available</label>
                          </div>
                        </div>
                      </div>
                      
                      <div class="schedule-row" data-day="5">
                        <div class="day-cell">
                          <div class="day-name">Saturday</div>
                        </div>
                        <div class="time-cell">
                          <div class="time-inputs">
                            <input type="time" class="form-control time-start" value="10:00">
                            <span class="time-separator">to</span>
                            <input type="time" class="form-control time-end" value="15:00">
                          </div>
                        </div>
                        <div class="action-cell">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input day-enabled" id="day-5">
                            <label class="form-check-label" for="day-5">Available</label>
                          </div>
                        </div>
                      </div>
                      
                      <div class="schedule-row" data-day="6">
                        <div class="day-cell">
                          <div class="day-name">Sunday</div>
                        </div>
                        <div class="time-cell">
                          <div class="time-inputs">
                            <input type="time" class="form-control time-start" value="10:00">
                            <span class="time-separator">to</span>
                            <input type="time" class="form-control time-end" value="15:00">
                          </div>
                        </div>
                        <div class="action-cell">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input day-enabled" id="day-6">
                            <label class="form-check-label" for="day-6">Available</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="availability-preview">
                      <h5>Quick Actions</h5>
                      <div class="quick-actions">
                        <button class="btn btn-outline-primary btn-sm" id="set-weekdays">
                          <i class="fas fa-briefcase"></i>
                          Set Weekdays (9-5)
                        </button>
                        <button class="btn btn-outline-primary btn-sm" id="set-weekends">
                          <i class="fas fa-coffee"></i>
                          Set Weekends (10-3)
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="clear-all">
                          <i class="fas fa-times"></i>
                          Clear All
                        </button>
                      </div>
                      
                      <div class="preview-info mt-3">
                        <h6>Preview</h6>
                        <div id="availability-preview-content">
                          <p class="text-muted">Configure your schedule to see a preview</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content" data-tab-content="settings">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Manage your account preferences and security</p>
          </div>
          <div class="tab-actions">
            <div id="settings-save-status" class="save-status" style="display: none;">
              <i class="fas fa-check-circle text-success"></i>
              <span>Saved</span>
            </div>
          </div>
        </div>

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-cog"></i>
            Preferences
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="form-group">
                <label>Language</label>
                <select id="language" class="form-control">
                  <option value="en" {{ 'selected' if current_user.language == 'en' else '' }}>English</option>
                  <option value="es" {{ 'selected' if current_user.language == 'es' else '' }}>Spanish</option>
                  <option value="fr" {{ 'selected' if current_user.language == 'fr' else '' }}>French</option>
                </select>
              </div>
              <div class="form-group">
                <label>Time Zone</label>
                <select id="timezone" class="form-control">
                  <option value="America/New_York" {{ 'selected' if current_user.timezone == 'America/New_York' else '' }}>Eastern Time (ET)</option>
                  <option value="America/Chicago" {{ 'selected' if current_user.timezone == 'America/Chicago' else '' }}>Central Time (CT)</option>
                  <option value="America/Denver" {{ 'selected' if current_user.timezone == 'America/Denver' else '' }}>Mountain Time (MT)</option>
                  <option value="America/Los_Angeles" {{ 'selected' if current_user.timezone == 'America/Los_Angeles' else '' }}>Pacific Time (PT)</option>
                </select>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="emailNotifications" {{ 'checked' if current_user.email_notifications else '' }}>
                <label class="form-check-label" for="emailNotifications">
                  Receive email notifications
                </label>
              </div>
            </div>
          </div>
        </div>

        {% if current_user.password_hash %}
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-shield-alt"></i>
            Security Settings
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="form-group">
                <label>Current Password</label>
                <input type="password" class="form-control" placeholder="Enter current password">
              </div>
              <div class="form-group">
                <label>New Password</label>
                <input type="password" class="form-control" placeholder="Enter new password">
              </div>
              <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" class="form-control" placeholder="Confirm new password">
              </div>
              <button class="btn btn-primary">
                <i class="fas fa-key"></i>
                Update Password
              </button>
            </div>
          </div>
        </div>
        {% else %}
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-shield-alt"></i>
            Security Settings
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Google Account</strong><br>
                You signed up with Google, so you don't have a password to change. Your account is secured through Google's authentication system.
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-trash"></i>
            Delete Account
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle"></i> Warning</h5>
                <p>This action cannot be undone. All your data, including bookings, earnings, and profile information will be permanently deleted.</p>
              </div>
              
              <form id="deleteAccountForm" action="/delete-account" method="POST" onsubmit="return confirmDelete()">
                <div class="form-group">
                  <label for="confirmation">Type your username "{{ current_user.username }}" to confirm</label>
                  <input type="text" id="confirmation" name="confirmation" class="form-control" placeholder="Type your username to confirm" oninput="toggleDeleteButton()">
                </div>
                
                <button type="submit" id="deleteButton" class="btn btn-secondary" disabled>
                  <i class="fas fa-trash"></i>
                  Permanently Delete Account
                </button>
              </form>
              
            </div>
          </div>
        </div>

      </div>

      <!-- Support Tab -->
      <div class="tab-content" data-tab-content="support">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Get help and support from our team</p>
          </div>
        </div>

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-envelope"></i>
            Send us a Message
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="form-group">
                <label>Subject</label>
                <select class="form-control">
                  <option>General Inquiry</option>
                  <option>Technical Support</option>
                  <option>Billing Question</option>
                  <option>Feature Request</option>
                  <option>Bug Report</option>
                </select>
              </div>
              <div class="form-group">
                <label>Message</label>
                <textarea class="form-control" rows="5" placeholder="Describe your issue or question..."></textarea>
              </div>
              <button class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
                Send Message
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Include tabs CSS and JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/tabs.css') }}">
<script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
<script>
// Simple functions for delete account functionality
function toggleDeleteButton() {
  const confirmationInput = document.getElementById('confirmation');
  const deleteButton = document.getElementById('deleteButton');
  
  if (confirmationInput && deleteButton) {
    if (confirmationInput.value.trim() === '{{ current_user.username }}') {
      deleteButton.disabled = false;
      deleteButton.classList.remove('btn-secondary');
      deleteButton.classList.add('btn-danger');
    } else {
      deleteButton.disabled = true;
      deleteButton.classList.remove('btn-danger');
      deleteButton.classList.add('btn-secondary');
    }
  }
}

function confirmDelete() {
  const confirmationInput = document.getElementById('confirmation');
  
  if (!confirmationInput || confirmationInput.value.trim() !== '{{ current_user.username }}') {
    alert('Please type your username exactly to confirm account deletion.');
    return false;
  }
  
  if (!confirm('Are you absolutely sure you want to permanently delete your account? This action cannot be undone.')) {
    return false;
  }
  
  return true;
}


// Availability Management
function setupAvailabilityManagement() {
  // Check calendar connection status
  checkCalendarStatus();
  
  // Setup event listeners
  setupAvailabilityEventListeners();
  
  // Load existing availability rules
  loadAvailabilityRules();
  
  // Also check calendar status when the availability tab is shown
  const availabilityTab = document.querySelector('[data-tab="availability"]');
  if (availabilityTab) {
    availabilityTab.addEventListener('click', function() {
      // Small delay to ensure tab content is loaded
      setTimeout(checkCalendarStatus, 100);
    });
  }
}

function checkCalendarStatus() {
  console.log('Checking calendar status...');
  fetch('/api/availability/calendar-status')
    .then(response => {
      console.log('Calendar status response:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('Calendar status data:', data);
      const connected = data.connected;
      const notConnectedDiv = document.getElementById('calendar-not-connected');
      const connectedDiv = document.getElementById('calendar-connected');
      const connectBtn = document.getElementById('connect-calendar-btn');
      const syncBtn = document.getElementById('sync-calendar-btn');
      const disconnectBtn = document.getElementById('disconnect-calendar-btn');
      
      if (connected) {
        console.log('Calendar is connected, updating UI...');
        notConnectedDiv.style.display = 'none';
        connectedDiv.style.display = 'block';
        connectBtn.style.display = 'none';
        syncBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'inline-block';
      } else {
        console.log('Calendar is not connected, updating UI...');
        notConnectedDiv.style.display = 'block';
        connectedDiv.style.display = 'none';
        connectBtn.style.display = 'inline-block';
        syncBtn.style.display = 'none';
        disconnectBtn.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error checking calendar status:', error);
    });
}

function setupAvailabilityEventListeners() {
  // Save availability button
  const saveBtn = document.getElementById('save-availability-btn');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveAvailability);
  }
  
  // Sync calendar button
  const syncBtn = document.getElementById('sync-calendar-btn');
  if (syncBtn) {
    syncBtn.addEventListener('click', syncCalendar);
  }
  
  // Quick action buttons
  const setWeekdaysBtn = document.getElementById('set-weekdays');
  if (setWeekdaysBtn) {
    setWeekdaysBtn.addEventListener('click', setWeekdays);
  }
  
  const setWeekendsBtn = document.getElementById('set-weekends');
  if (setWeekendsBtn) {
    setWeekendsBtn.addEventListener('click', setWeekends);
  }
  
  const clearAllBtn = document.getElementById('clear-all');
  if (clearAllBtn) {
    clearAllBtn.addEventListener('click', clearAllDays);
  }
  
  // Day enabled checkboxes
  const dayCheckboxes = document.querySelectorAll('.day-enabled');
  dayCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updatePreview);
  });
  
  // Time inputs
  const timeInputs = document.querySelectorAll('.time-start, .time-end');
  timeInputs.forEach(input => {
    input.addEventListener('change', updatePreview);
  });
}

function loadAvailabilityRules() {
  fetch('/api/availability/rules')
    .then(response => response.json())
    .then(rules => {
      // Clear existing rules
      const dayCheckboxes = document.querySelectorAll('.day-enabled');
      dayCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Apply loaded rules
      rules.forEach(rule => {
        const dayRow = document.querySelector(`[data-day="${rule.weekday}"]`);
        if (dayRow) {
          const checkbox = dayRow.querySelector('.day-enabled');
          const startInput = dayRow.querySelector('.time-start');
          const endInput = dayRow.querySelector('.time-end');
          
          if (checkbox && startInput && endInput) {
            checkbox.checked = true;
            startInput.value = rule.start;
            endInput.value = rule.end;
          }
        }
      });
      
      updatePreview();
    })
    .catch(error => {
      console.error('Error loading availability rules:', error);
    });
}

function saveAvailability() {
  const rules = [];
  
  // Collect all enabled days
  const dayRows = document.querySelectorAll('.schedule-row');
  dayRows.forEach(row => {
    const checkbox = row.querySelector('.day-enabled');
    const startInput = row.querySelector('.time-start');
    const endInput = row.querySelector('.time-end');
    const day = row.getAttribute('data-day');
    
    if (checkbox && checkbox.checked && startInput && endInput) {
      rules.push({
        weekday: parseInt(day),
        start: startInput.value,
        end: endInput.value,
        enabled: true
      });
    }
  });
  
  // Save to server
  fetch('/api/availability/rules', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ rules: rules })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAvailabilitySaveStatus();
    } else {
      console.error('Error saving availability:', data.error);
      alert('Failed to save availability. Please try again.');
    }
  })
  .catch(error => {
    console.error('Error saving availability:', error);
    alert('Failed to save availability. Please try again.');
  });
}

function syncCalendar() {
  const syncStatus = document.getElementById('sync-status');
  const syncBtn = document.getElementById('sync-calendar-btn');
  
  syncStatus.style.display = 'block';
  syncBtn.disabled = true;
  
  fetch('/api/availability/sync-calendar', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    syncStatus.style.display = 'none';
    syncBtn.disabled = false;
    
    if (data.success) {
      alert(`Calendar synced successfully! ${data.message}`);
    } else {
      alert(`Failed to sync calendar: ${data.error}`);
    }
  })
  .catch(error => {
    syncStatus.style.display = 'none';
    syncBtn.disabled = false;
    console.error('Error syncing calendar:', error);
    alert('Failed to sync calendar. Please try again.');
  });
}

function setWeekdays() {
  // Set Monday-Friday to 9:00-17:00
  for (let day = 0; day < 5; day++) {
    const dayRow = document.querySelector(`[data-day="${day}"]`);
    if (dayRow) {
      const checkbox = dayRow.querySelector('.day-enabled');
      const startInput = dayRow.querySelector('.time-start');
      const endInput = dayRow.querySelector('.time-end');
      
      if (checkbox && startInput && endInput) {
        checkbox.checked = true;
        startInput.value = '09:00';
        endInput.value = '17:00';
      }
    }
  }
  updatePreview();
}

function setWeekends() {
  // Set Saturday-Sunday to 10:00-15:00
  for (let day = 5; day < 7; day++) {
    const dayRow = document.querySelector(`[data-day="${day}"]`);
    if (dayRow) {
      const checkbox = dayRow.querySelector('.day-enabled');
      const startInput = dayRow.querySelector('.time-start');
      const endInput = dayRow.querySelector('.time-end');
      
      if (checkbox && startInput && endInput) {
        checkbox.checked = true;
        startInput.value = '10:00';
        endInput.value = '15:00';
      }
    }
  }
  updatePreview();
}

function clearAllDays() {
  const dayCheckboxes = document.querySelectorAll('.day-enabled');
  dayCheckboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updatePreview();
}

function updatePreview() {
  const previewContent = document.getElementById('availability-preview-content');
  const enabledDays = [];
  
  const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  const dayRows = document.querySelectorAll('.schedule-row');
  dayRows.forEach(row => {
    const checkbox = row.querySelector('.day-enabled');
    const startInput = row.querySelector('.time-start');
    const endInput = row.querySelector('.time-end');
    const day = parseInt(row.getAttribute('data-day'));
    
    if (checkbox && checkbox.checked && startInput && endInput) {
      enabledDays.push({
        day: dayNames[day],
        start: startInput.value,
        end: endInput.value
      });
    }
  });
  
  if (enabledDays.length === 0) {
    previewContent.innerHTML = '<p class="text-muted">No days selected</p>';
  } else {
    let html = '<ul class="list-unstyled">';
    enabledDays.forEach(day => {
      html += `<li><strong>${day.day}:</strong> ${day.start} - ${day.end}</li>`;
    });
    html += '</ul>';
    previewContent.innerHTML = html;
  }
}

function showAvailabilitySaveStatus() {
  // Create a temporary status element
  const statusDiv = document.createElement('div');
  statusDiv.className = 'alert alert-success';
  statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Availability saved successfully!';
  statusDiv.style.position = 'fixed';
  statusDiv.style.top = '20px';
  statusDiv.style.right = '20px';
  statusDiv.style.zIndex = '9999';
  
  document.body.appendChild(statusDiv);
  
  // Remove after 3 seconds
  setTimeout(() => {
    document.body.removeChild(statusDiv);
  }, 3000);
}

// Auto-save functionality
let saveTimeout;
let settingsSaveTimeout;
let hasUnsavedChanges = false;
const SAVE_DELAY = 1000; // Save after 1 second of no typing

function showSaveStatus() {
  const saveStatus = document.getElementById('save-status');
  
  saveStatus.style.display = 'flex';
  saveStatus.style.alignItems = 'center';
  saveStatus.style.gap = '8px';
  saveStatus.style.color = '#28a745';
  
  hasUnsavedChanges = false;
  
  // Hide after 2 seconds
  setTimeout(() => {
    saveStatus.style.display = 'none';
  }, 2000);
}

function showSettingsSaveStatus() {
  const saveStatus = document.getElementById('settings-save-status');
  
  saveStatus.style.display = 'flex';
  saveStatus.style.alignItems = 'center';
  saveStatus.style.gap = '8px';
  saveStatus.style.color = '#28a745';
  
  // Hide after 2 seconds
  setTimeout(() => {
    saveStatus.style.display = 'none';
  }, 2000);
}

function saveProfileData() {
  const fullName = document.getElementById('full_name').value;
  const bio = document.getElementById('bio').value;
  
  fetch('/api/profile/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      full_name: fullName,
      bio: bio
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showSaveStatus();
    } else {
      console.error('Error saving profile:', data.error);
    }
  })
  .catch(error => {
    console.error('Error saving profile:', error);
  });
}

function saveSettingsData() {
  const language = document.getElementById('language').value;
  const timezone = document.getElementById('timezone').value;
  const emailNotifications = document.getElementById('emailNotifications').checked;
  
  fetch('/api/profile/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      language: language,
      timezone: timezone,
      email_notifications: emailNotifications
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showSettingsSaveStatus();
    } else {
      console.error('Error saving settings:', data.error);
    }
  })
  .catch(error => {
    console.error('Error saving settings:', error);
  });
}

function setupAutoSave() {
  // Profile fields auto-save
  const profileFields = ['full_name', 'bio'];
  
  profileFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('input', function() {
        // Clear existing timeout
        if (saveTimeout) {
          clearTimeout(saveTimeout);
        }
        
        // Set new timeout
        saveTimeout = setTimeout(saveProfileData, SAVE_DELAY);
      });
    }
  });
  
  // Settings fields auto-save
  const settingsFields = ['language', 'timezone', 'emailNotifications'];
  
  settingsFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('change', function() {
        // Clear existing timeout
        if (settingsSaveTimeout) {
          clearTimeout(settingsSaveTimeout);
        }
        
        // Set new timeout
        settingsSaveTimeout = setTimeout(saveSettingsData, SAVE_DELAY);
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  // Setup auto-save with a delay to ensure DOM is fully ready
  setTimeout(() => {
    setupAutoSave();
    setupAvailabilityManagement();
  }, 100);
});

// Test function - you can call this from browser console
window.testAutoSave = function() {
  console.log('Testing auto-save...');
  const fullNameField = document.getElementById('full_name');
  const bioField = document.getElementById('bio');
  
  console.log('Full name field:', fullNameField);
  console.log('Bio field:', bioField);
  
  if (fullNameField) {
    fullNameField.value = 'Test Name';
    fullNameField.dispatchEvent(new Event('input'));
  }
  
  if (bioField) {
    bioField.value = 'Test Bio';
    bioField.dispatchEvent(new Event('input'));
  }
  
  console.log('Test completed. Check for save messages above.');
};
</script>
{% endblock %} 