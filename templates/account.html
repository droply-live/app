{% extends "base_signed_in.html" %}

{% block title %}Account - Droply{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Account Header -->
  <div class="mb-4">
    <h1 class="h2 mb-1">Account</h1>
    <p class="text-muted mb-0">View your profile and manage your settings</p>
  </div>

  <!-- Tabbed Interface -->
  <div id="account-tabs" class="tabbed-interface">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="personal-info">
        <i class="fas fa-user d-none d-md-inline"></i>
        <span>Profile</span>
      </button>
      <button class="tab-button" data-tab="availability">
        <i class="fas fa-calendar d-none d-md-inline"></i>
        <span>Availability</span>
      </button>
      <button class="tab-button" data-tab="settings">
        <i class="fas fa-cog d-none d-md-inline"></i>
        <span>Settings</span>
      </button>
      <button class="tab-button" data-tab="support">
        <i class="fas fa-question-circle d-none d-md-inline"></i>
        <span>Support</span>
      </button>
    </div>
    <div class="tab-indicator"></div>

    <!-- Tab Content Container -->
    <div class="tab-content-container">
      <!-- Personal Info Tab -->
      <div class="tab-content active" data-tab-content="personal-info">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Update your profile details and preferences</p>
          </div>
          <div class="tab-actions">
            <div id="save-status" class="save-status" style="display: none;">
              <i class="fas fa-check-circle text-success"></i>
              <span>Saved</span>
            </div>
          </div>
        </div>

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-user-circle"></i>
            Profile Details
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="full_name" class="form-control" value="{{ current_user.full_name or '' }}" placeholder="Enter your full name">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
                    <small class="text-muted">Username cannot be changed</small>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" value="{{ current_user.email }}" readonly>
                    <small class="text-muted">Email cannot be changed</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" class="form-control" value="{{ current_user.phone or '' }}" placeholder="Enter your phone number">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label>Bio</label>
                <textarea id="bio" class="form-control" rows="3" placeholder="Tell us about yourself">{{ current_user.bio or '' }}</textarea>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Availability Tab -->
      <div class="tab-content" data-tab-content="availability">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Set when you're available for sessions</p>
          </div>
        </div>

        <!-- Google Calendar Integration -->
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fab fa-google"></i>
            Google Calendar Integration
          </h3>
          <div class="card">
            <div class="card-body">
              <div id="calendar-connection-status">
                <div class="alert alert-info" id="calendar-not-connected">
                  <i class="fas fa-info-circle"></i>
                  <strong>Connect your Google Calendar</strong><br>
                  Sync your calendar to automatically block times when you're busy. This ensures clients can only book when you're actually available.
                </div>
                <div class="alert alert-success" id="calendar-connected" style="display: none;">
                  <i class="fas fa-check-circle"></i>
                  <strong>Google Calendar Connected</strong>
                </div>
              </div>
              
              <div class="calendar-actions">
                <a href="/auth/google-calendar" class="btn btn-primary" id="connect-calendar-btn">
                  <i class="fab fa-google"></i>
                  Connect Google Calendar
                </a>
                <form action="/disconnect-google-calendar" method="POST" style="display: inline;" id="disconnect-calendar-form">
                  <button type="submit" class="btn btn-outline-danger btn-sm" id="disconnect-calendar-btn" style="display: none;">
                    <i class="fas fa-unlink"></i>
                    Disconnect
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Weekly Calendar View -->
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-calendar-week"></i>
            Weekly Calendar & Availability
          </h3>
          <div class="card">
            <div class="card-body">
              <p class="text-muted">View your Google Calendar events and set your availability for each day. Events from your calendar will automatically block those times.</p>
              
              <!-- Calendar Navigation -->
              <div class="calendar-navigation mb-3">
                <div class="d-flex align-items-center justify-content-center">
                  <button class="btn btn-outline-secondary btn-xs me-1" id="prev-week">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <span class="text-muted small mx-2" id="current-week-display">This Week</span>
                  <button class="btn btn-outline-secondary btn-xs ms-1" id="next-week">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                  <button class="btn btn-outline-secondary btn-xs ms-2" id="sync-calendar-events" title="Sync Calendar Events">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>

              <!-- Weekly Calendar Grid -->
              <div class="weekly-calendar">
                <div class="calendar-grid">
                  <!-- Monday Column -->
                  <div class="day-column" data-day="0">
                    <div class="day-header">
                      <div class="day-name">Monday</div>
                      <div class="date-display" id="date-0">-</div>
                    </div>
                    <div class="status-section">
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input day-enabled" id="day-0">
                        <label class="form-check-label" for="day-0">Active</label>
                      </div>
                    </div>
                    <div class="availability-section">
                      <div class="section-label">Available Hours</div>
                      <div class="time-inputs">
                        <input type="time" class="form-control time-start" value="09:00">
                        <span class="time-separator">to</span>
                        <input type="time" class="form-control time-end" value="17:00">
                      </div>
                    </div>
                    <div class="events-section">
                      <div class="section-label">Events</div>
                      <div class="events-list" id="events-0">
                        <div class="no-events">No events</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Tuesday Column -->
                  <div class="day-column" data-day="1">
                    <div class="day-header">
                      <div class="day-name">Tuesday</div>
                      <div class="date-display" id="date-1">-</div>
                    </div>
                    <div class="status-section">
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input day-enabled" id="day-1">
                        <label class="form-check-label" for="day-1">Active</label>
                      </div>
                    </div>
                    <div class="availability-section">
                      <div class="section-label">Available Hours</div>
                      <div class="time-inputs">
                        <input type="time" class="form-control time-start" value="09:00">
                        <span class="time-separator">to</span>
                        <input type="time" class="form-control time-end" value="17:00">
                      </div>
                    </div>
                    <div class="events-section">
                      <div class="section-label">Events</div>
                      <div class="events-list" id="events-1">
                        <div class="no-events">No events</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Wednesday Column -->
                  <div class="day-column" data-day="2">
                    <div class="day-header">
                      <div class="day-name">Wednesday</div>
                      <div class="date-display" id="date-2">-</div>
                    </div>
                    <div class="status-section">
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input day-enabled" id="day-2">
                        <label class="form-check-label" for="day-2">Active</label>
                      </div>
                    </div>
                    <div class="availability-section">
                      <div class="section-label">Available Hours</div>
                      <div class="time-inputs">
                        <input type="time" class="form-control time-start" value="09:00">
                        <span class="time-separator">to</span>
                        <input type="time" class="form-control time-end" value="17:00">
                      </div>
                    </div>
                    <div class="events-section">
                      <div class="section-label">Events</div>
                      <div class="events-list" id="events-2">
                        <div class="no-events">No events</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Thursday Column -->
                  <div class="day-column" data-day="3">
                    <div class="day-header">
                      <div class="day-name">Thursday</div>
                      <div class="date-display" id="date-3">-</div>
                    </div>
                    <div class="status-section">
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input day-enabled" id="day-3">
                        <label class="form-check-label" for="day-3">Active</label>
                      </div>
                    </div>
                    <div class="availability-section">
                      <div class="section-label">Available Hours</div>
                      <div class="time-inputs">
                        <input type="time" class="form-control time-start" value="09:00">
                        <span class="time-separator">to</span>
                        <input type="time" class="form-control time-end" value="17:00">
                      </div>
                    </div>
                    <div class="events-section">
                      <div class="section-label">Events</div>
                      <div class="events-list" id="events-3">
                        <div class="no-events">No events</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Friday Column -->
                  <div class="day-column" data-day="4">
                    <div class="day-header">
                      <div class="day-name">Friday</div>
                      <div class="date-display" id="date-4">-</div>
                    </div>
                    <div class="status-section">
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input day-enabled" id="day-4">
                        <label class="form-check-label" for="day-4">Active</label>
                      </div>
                    </div>
                    <div class="availability-section">
                      <div class="section-label">Available Hours</div>
                      <div class="time-inputs">
                        <input type="time" class="form-control time-start" value="09:00">
                        <span class="time-separator">to</span>
                        <input type="time" class="form-control time-end" value="17:00">
                      </div>
                    </div>
                    <div class="events-section">
                      <div class="section-label">Events</div>
                      <div class="events-list" id="events-4">
                        <div class="no-events">No events</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Saturday Column -->
                  <div class="day-column" data-day="5">
                    <div class="day-header">
                      <div class="day-name">Saturday</div>
                      <div class="date-display" id="date-5">-</div>
                    </div>
                    <div class="status-section">
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input day-enabled" id="day-5">
                        <label class="form-check-label" for="day-5">Active</label>
                      </div>
                    </div>
                    <div class="availability-section">
                      <div class="section-label">Available Hours</div>
                      <div class="time-inputs">
                        <input type="time" class="form-control time-start" value="10:00">
                        <span class="time-separator">to</span>
                        <input type="time" class="form-control time-end" value="15:00">
                      </div>
                    </div>
                    <div class="events-section">
                      <div class="section-label">Events</div>
                      <div class="events-list" id="events-5">
                        <div class="no-events">No events</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Sunday Column -->
                  <div class="day-column" data-day="6">
                    <div class="day-header">
                      <div class="day-name">Sunday</div>
                      <div class="date-display" id="date-6">-</div>
                    </div>
                    <div class="status-section">
                      <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input day-enabled" id="day-6">
                        <label class="form-check-label" for="day-6">Active</label>
                      </div>
                    </div>
                    <div class="availability-section">
                      <div class="section-label">Available Hours</div>
                      <div class="time-inputs">
                        <input type="time" class="form-control time-start" value="10:00">
                        <span class="time-separator">to</span>
                        <input type="time" class="form-control time-end" value="15:00">
                      </div>
                    </div>
                    <div class="events-section">
                      <div class="section-label">Events</div>
                      <div class="events-list" id="events-6">
                        <div class="no-events">No events</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content" data-tab-content="settings">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Manage your account preferences and security</p>
          </div>
          <div class="tab-actions">
            <div id="settings-save-status" class="save-status" style="display: none;">
              <i class="fas fa-check-circle text-success"></i>
              <span>Saved</span>
            </div>
          </div>
        </div>

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-cog"></i>
            Preferences
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="form-group">
                <label>Language</label>
                <select id="language" class="form-control">
                  <option value="en" {{ 'selected' if current_user.language == 'en' else '' }}>English</option>
                  <option value="es" {{ 'selected' if current_user.language == 'es' else '' }}>Spanish</option>
                  <option value="fr" {{ 'selected' if current_user.language == 'fr' else '' }}>French</option>
                </select>
              </div>
              <div class="form-group">
                <label>Time Zone</label>
                <select id="timezone" class="form-control">
                  <option value="America/New_York" {{ 'selected' if current_user.timezone == 'America/New_York' else '' }}>Eastern Time (ET)</option>
                  <option value="America/Chicago" {{ 'selected' if current_user.timezone == 'America/Chicago' else '' }}>Central Time (CT)</option>
                  <option value="America/Denver" {{ 'selected' if current_user.timezone == 'America/Denver' else '' }}>Mountain Time (MT)</option>
                  <option value="America/Los_Angeles" {{ 'selected' if current_user.timezone == 'America/Los_Angeles' else '' }}>Pacific Time (PT)</option>
                </select>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="emailNotifications" {{ 'checked' if current_user.email_notifications else '' }}>
                <label class="form-check-label" for="emailNotifications">
                  Receive email notifications
                </label>
              </div>
            </div>
          </div>
        </div>

        {% if current_user.password_hash %}
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-shield-alt"></i>
            Security Settings
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="form-group">
                <label>Current Password</label>
                <input type="password" class="form-control" placeholder="Enter current password">
              </div>
              <div class="form-group">
                <label>New Password</label>
                <input type="password" class="form-control" placeholder="Enter new password">
              </div>
              <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" class="form-control" placeholder="Confirm new password">
              </div>
              <button class="btn btn-primary">
                <i class="fas fa-key"></i>
                Update Password
              </button>
            </div>
          </div>
        </div>
        {% else %}
        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-shield-alt"></i>
            Security Settings
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Google Account</strong><br>
                You signed up with Google, so you don't have a password to change. Your account is secured through Google's authentication system.
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-trash"></i>
            Delete Account
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle"></i> Warning</h5>
                <p>This action cannot be undone. All your data, including bookings, earnings, and profile information will be permanently deleted.</p>
              </div>
              
              <form id="deleteAccountForm" action="/delete-account" method="POST" onsubmit="return confirmDelete()">
                <div class="form-group">
                  <label for="confirmation">Type your username "{{ current_user.username }}" to confirm</label>
                  <input type="text" id="confirmation" name="confirmation" class="form-control" placeholder="Type your username to confirm" oninput="toggleDeleteButton()">
                </div>
                
                <button type="submit" id="deleteButton" class="btn btn-secondary" disabled>
                  <i class="fas fa-trash"></i>
                  Permanently Delete Account
                </button>
              </form>
              
            </div>
          </div>
        </div>

      </div>

      <!-- Support Tab -->
      <div class="tab-content" data-tab-content="support">
        <div class="tab-header">
          <div>
            <p class="tab-subtitle">Get help and support from our team</p>
          </div>
        </div>

        <div class="tab-section">
          <h3 class="tab-section-title">
            <i class="fas fa-envelope"></i>
            Send us a Message
          </h3>
          <div class="card">
            <div class="card-body">
              <div class="form-group">
                <label>Subject</label>
                <select class="form-control">
                  <option>General Inquiry</option>
                  <option>Technical Support</option>
                  <option>Billing Question</option>
                  <option>Feature Request</option>
                  <option>Bug Report</option>
                </select>
              </div>
              <div class="form-group">
                <label>Message</label>
                <textarea class="form-control" rows="5" placeholder="Describe your issue or question..."></textarea>
              </div>
              <button class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
                Send Message
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Include tabs CSS and JS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/tabs.css') }}">
<script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
<script>
// Simple functions for delete account functionality
function toggleDeleteButton() {
  const confirmationInput = document.getElementById('confirmation');
  const deleteButton = document.getElementById('deleteButton');
  
  if (confirmationInput && deleteButton) {
    if (confirmationInput.value.trim() === '{{ current_user.username }}') {
      deleteButton.disabled = false;
      deleteButton.classList.remove('btn-secondary');
      deleteButton.classList.add('btn-danger');
    } else {
      deleteButton.disabled = true;
      deleteButton.classList.remove('btn-danger');
      deleteButton.classList.add('btn-secondary');
    }
  }
}

function confirmDelete() {
  const confirmationInput = document.getElementById('confirmation');
  
  if (!confirmationInput || confirmationInput.value.trim() !== '{{ current_user.username }}') {
    alert('Please type your username exactly to confirm account deletion.');
    return false;
  }
  
  if (!confirm('Are you absolutely sure you want to permanently delete your account? This action cannot be undone.')) {
    return false;
  }
  
  return true;
}


// Availability Management
function setupAvailabilityManagement() {
  // Check calendar connection status
  checkCalendarStatus();
  
  // Setup event listeners
  setupAvailabilityEventListeners();
  
  // Load existing availability rules
  loadAvailabilityRules();
  
  // Also check calendar status when the availability tab is shown
  const availabilityTab = document.querySelector('[data-tab="availability"]');
  if (availabilityTab) {
    availabilityTab.addEventListener('click', function() {
      // Small delay to ensure tab content is loaded
      setTimeout(checkCalendarStatus, 100);
    });
  }
}

function checkCalendarStatus() {
  console.log('Checking calendar status...');
  fetch('/api/availability/calendar-status')
    .then(response => {
      console.log('Calendar status response:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('Calendar status data:', data);
      const connected = data.connected;
      const notConnectedDiv = document.getElementById('calendar-not-connected');
      const connectedDiv = document.getElementById('calendar-connected');
      const connectBtn = document.getElementById('connect-calendar-btn');
      const disconnectBtn = document.getElementById('disconnect-calendar-btn');
      
      if (connected) {
        console.log('Calendar is connected, updating UI...');
        notConnectedDiv.style.display = 'none';
        connectedDiv.style.display = 'block';
        connectBtn.style.display = 'none';
        disconnectBtn.style.display = 'inline-block';
      } else {
        console.log('Calendar is not connected, updating UI...');
        notConnectedDiv.style.display = 'block';
        connectedDiv.style.display = 'none';
        connectBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error checking calendar status:', error);
    });
}

function setupAvailabilityEventListeners() {
  // Auto-save functionality - no manual save button needed
  
  // Quick action buttons
  const setWeekdaysBtn = document.getElementById('set-weekdays');
  if (setWeekdaysBtn) {
    setWeekdaysBtn.addEventListener('click', setWeekdays);
  }
  
  const setWeekendsBtn = document.getElementById('set-weekends');
  if (setWeekendsBtn) {
    setWeekendsBtn.addEventListener('click', setWeekends);
  }
  
  const clearAllBtn = document.getElementById('clear-all');
  if (clearAllBtn) {
    clearAllBtn.addEventListener('click', clearAllDays);
  }
  
  // Day enabled checkboxes - auto-save on change
  const dayCheckboxes = document.querySelectorAll('.day-enabled');
  dayCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      updatePreview();
      saveAvailability();
    });
  });
  
  // Time inputs - auto-save on change
  const timeInputs = document.querySelectorAll('.time-start, .time-end');
  timeInputs.forEach(input => {
    input.addEventListener('change', () => {
      updatePreview();
      saveAvailability();
    });
  });
}

function loadAvailabilityRules() {
  fetch('/api/availability/rules')
    .then(response => response.json())
    .then(rules => {
      // Clear existing rules
      const dayCheckboxes = document.querySelectorAll('.day-enabled');
      dayCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Apply loaded rules
      rules.forEach(rule => {
        const dayColumn = document.querySelector(`.day-column[data-day="${rule.weekday}"]`);
        if (dayColumn) {
          const checkbox = dayColumn.querySelector('.day-enabled');
          const startInput = dayColumn.querySelector('.time-start');
          const endInput = dayColumn.querySelector('.time-end');
          
          if (checkbox && startInput && endInput) {
            checkbox.checked = true;
            startInput.value = rule.start;
            endInput.value = rule.end;
            // Update label text
            const label = checkbox.nextElementSibling;
            if (label) {
              label.textContent = 'Active';
            }
          }
        }
      });
      
      updatePreview();
    })
    .catch(error => {
      console.error('Error loading availability rules:', error);
    });
}

function saveAvailability() {
  const rules = [];
  
  // Collect all enabled days
  const dayColumns = document.querySelectorAll('.day-column');
  dayColumns.forEach(column => {
    const checkbox = column.querySelector('.day-enabled');
    const startInput = column.querySelector('.time-start');
    const endInput = column.querySelector('.time-end');
    const day = column.getAttribute('data-day');
    
    if (checkbox && checkbox.checked && startInput && endInput) {
      rules.push({
        weekday: parseInt(day),
        start: startInput.value,
        end: endInput.value,
        enabled: true
      });
    }
  });
  
  // Save to server
  fetch('/api/availability/rules', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ rules: rules })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAutoSaveStatus();
    } else {
      console.error('Error auto-saving availability:', data.error);
      showAutoSaveError();
    }
  })
  .catch(error => {
    console.error('Error auto-saving availability:', error);
    showAutoSaveError();
  });
}

function syncCalendar() {
  const syncStatus = document.getElementById('sync-status');
  const syncBtn = document.getElementById('sync-calendar-events');
  
  syncStatus.style.display = 'block';
  if (syncBtn) {
    syncBtn.disabled = true;
  }
  
  fetch('/api/availability/sync-calendar', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    syncStatus.style.display = 'none';
    if (syncBtn) {
      syncBtn.disabled = false;
    }
    
    if (data.success) {
      alert(`Calendar synced successfully! ${data.message}`);
    } else {
      alert(`Failed to sync calendar: ${data.error}`);
    }
  })
  .catch(error => {
    syncStatus.style.display = 'none';
    if (syncBtn) {
      syncBtn.disabled = false;
    }
    console.error('Error syncing calendar:', error);
    alert('Failed to sync calendar. Please try again.');
  });
}

function setWeekdays() {
  // Set Monday-Friday to 9:00-17:00
  for (let day = 0; day < 5; day++) {
    const dayRow = document.querySelector(`[data-day="${day}"]`);
    if (dayRow) {
      const checkbox = dayRow.querySelector('.day-enabled');
      const startInput = dayRow.querySelector('.time-start');
      const endInput = dayRow.querySelector('.time-end');
      
      if (checkbox && startInput && endInput) {
        checkbox.checked = true;
        startInput.value = '09:00';
        endInput.value = '17:00';
      }
    }
  }
  updatePreview();
}

function setWeekends() {
  // Set Saturday-Sunday to 10:00-15:00
  for (let day = 5; day < 7; day++) {
    const dayRow = document.querySelector(`[data-day="${day}"]`);
    if (dayRow) {
      const checkbox = dayRow.querySelector('.day-enabled');
      const startInput = dayRow.querySelector('.time-start');
      const endInput = dayRow.querySelector('.time-end');
      
      if (checkbox && startInput && endInput) {
        checkbox.checked = true;
        startInput.value = '10:00';
        endInput.value = '15:00';
      }
    }
  }
  updatePreview();
}

function clearAllDays() {
  const dayCheckboxes = document.querySelectorAll('.day-enabled');
  dayCheckboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updatePreview();
}

function updatePreview() {
  const previewContent = document.getElementById('availability-preview-content');
  const enabledDays = [];
  
  const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  const dayRows = document.querySelectorAll('.schedule-row');
  dayRows.forEach(row => {
    const checkbox = row.querySelector('.day-enabled');
    const startInput = row.querySelector('.time-start');
    const endInput = row.querySelector('.time-end');
    const day = parseInt(row.getAttribute('data-day'));
    
    if (checkbox && checkbox.checked && startInput && endInput) {
      enabledDays.push({
        day: dayNames[day],
        start: startInput.value,
        end: endInput.value
      });
    }
  });
  
  if (enabledDays.length === 0) {
    previewContent.innerHTML = '<p class="text-muted">No days selected</p>';
  } else {
    let html = '<ul class="list-unstyled">';
    enabledDays.forEach(day => {
      html += `<li><strong>${day.day}:</strong> ${day.start} - ${day.end}</li>`;
    });
    html += '</ul>';
    previewContent.innerHTML = html;
  }
}

function showAutoSaveStatus() {
  // Create a subtle auto-save indicator
  const statusDiv = document.createElement('div');
  statusDiv.className = 'auto-save-indicator';
  statusDiv.innerHTML = '<i class="fas fa-check"></i> Saved';
  statusDiv.style.position = 'fixed';
  statusDiv.style.top = '20px';
  statusDiv.style.right = '20px';
  statusDiv.style.zIndex = '9999';
  statusDiv.style.background = '#10b981';
  statusDiv.style.color = 'white';
  statusDiv.style.padding = '8px 12px';
  statusDiv.style.borderRadius = '6px';
  statusDiv.style.fontSize = '12px';
  statusDiv.style.fontWeight = '500';
  statusDiv.style.opacity = '0';
  statusDiv.style.transition = 'opacity 0.3s ease';
  
  document.body.appendChild(statusDiv);
  
  // Fade in
  setTimeout(() => {
    statusDiv.style.opacity = '1';
  }, 10);
  
  // Fade out and remove after 2 seconds
  setTimeout(() => {
    statusDiv.style.opacity = '0';
    setTimeout(() => {
      if (document.body.contains(statusDiv)) {
        document.body.removeChild(statusDiv);
      }
    }, 300);
  }, 2000);
}

function showAutoSaveError() {
  // Create a subtle error indicator
  const statusDiv = document.createElement('div');
  statusDiv.className = 'auto-save-error';
  statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Save failed';
  statusDiv.style.position = 'fixed';
  statusDiv.style.top = '20px';
  statusDiv.style.right = '20px';
  statusDiv.style.zIndex = '9999';
  statusDiv.style.background = '#ef4444';
  statusDiv.style.color = 'white';
  statusDiv.style.padding = '8px 12px';
  statusDiv.style.borderRadius = '6px';
  statusDiv.style.fontSize = '12px';
  statusDiv.style.fontWeight = '500';
  statusDiv.style.opacity = '0';
  statusDiv.style.transition = 'opacity 0.3s ease';
  
  document.body.appendChild(statusDiv);
  
  // Fade in
  setTimeout(() => {
    statusDiv.style.opacity = '1';
  }, 10);
  
  // Fade out and remove after 3 seconds
  setTimeout(() => {
    statusDiv.style.opacity = '0';
    setTimeout(() => {
      if (document.body.contains(statusDiv)) {
        document.body.removeChild(statusDiv);
      }
    }, 300);
  }, 3000);
}

// Auto-save functionality
let saveTimeout;
let settingsSaveTimeout;
let hasUnsavedChanges = false;
const SAVE_DELAY = 1000; // Save after 1 second of no typing

function showSaveStatus() {
  const saveStatus = document.getElementById('save-status');
  
  saveStatus.style.display = 'flex';
  saveStatus.style.alignItems = 'center';
  saveStatus.style.gap = '8px';
  saveStatus.style.color = '#28a745';
  
  hasUnsavedChanges = false;
  
  // Hide after 2 seconds
  setTimeout(() => {
    saveStatus.style.display = 'none';
  }, 2000);
}

function showSettingsSaveStatus() {
  const saveStatus = document.getElementById('settings-save-status');
  
  saveStatus.style.display = 'flex';
  saveStatus.style.alignItems = 'center';
  saveStatus.style.gap = '8px';
  saveStatus.style.color = '#28a745';
  
  // Hide after 2 seconds
  setTimeout(() => {
    saveStatus.style.display = 'none';
  }, 2000);
}

function saveProfileData() {
  const fullName = document.getElementById('full_name').value;
  const bio = document.getElementById('bio').value;
  
  fetch('/api/profile/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      full_name: fullName,
      bio: bio
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showSaveStatus();
    } else {
      console.error('Error saving profile:', data.error);
    }
  })
  .catch(error => {
    console.error('Error saving profile:', error);
  });
}

function saveSettingsData() {
  const language = document.getElementById('language').value;
  const timezone = document.getElementById('timezone').value;
  const emailNotifications = document.getElementById('emailNotifications').checked;
  
  fetch('/api/profile/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      language: language,
      timezone: timezone,
      email_notifications: emailNotifications
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showSettingsSaveStatus();
    } else {
      console.error('Error saving settings:', data.error);
    }
  })
  .catch(error => {
    console.error('Error saving settings:', error);
  });
}

function setupAutoSave() {
  // Profile fields auto-save
  const profileFields = ['full_name', 'bio'];
  
  profileFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('input', function() {
        // Clear existing timeout
        if (saveTimeout) {
          clearTimeout(saveTimeout);
        }
        
        // Set new timeout
        saveTimeout = setTimeout(saveProfileData, SAVE_DELAY);
      });
    }
  });
  
  // Settings fields auto-save
  const settingsFields = ['language', 'timezone', 'emailNotifications'];
  
  settingsFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('change', function() {
        // Clear existing timeout
        if (settingsSaveTimeout) {
          clearTimeout(settingsSaveTimeout);
        }
        
        // Set new timeout
        settingsSaveTimeout = setTimeout(saveSettingsData, SAVE_DELAY);
      });
    }
  });
}

// Weekly Calendar Management
let currentWeekStart = new Date();
// Set to start of current week (Sunday)
const today = new Date();
const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
currentWeekStart.setDate(today.getDate() - dayOfWeek);
currentWeekStart.setHours(0, 0, 0, 0); // Reset time to start of day

function setupWeeklyCalendar() {
  // Initialize current week
  updateWeekDisplay();
  loadWeekEvents();
  
  // Initialize toggle labels
  initializeToggleLabels();
  
  // Setup event listeners
  setupWeeklyCalendarEventListeners();
}

function initializeToggleLabels() {
  for (let day = 0; day < 7; day++) {
    const checkbox = document.querySelector(`.day-column[data-day="${day}"] .day-enabled`);
    if (checkbox) {
      const label = checkbox.nextElementSibling;
      if (label) {
        label.textContent = checkbox.checked ? 'Active' : 'Inactive';
      }
    }
  }
}

function setupWeeklyCalendarEventListeners() {
  // Week navigation
  const prevWeekBtn = document.getElementById('prev-week');
  const nextWeekBtn = document.getElementById('next-week');
  const syncEventsBtn = document.getElementById('sync-calendar-events');
  
  if (prevWeekBtn) {
    prevWeekBtn.addEventListener('click', () => {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      updateWeekDisplay();
      loadWeekEvents();
    });
  }
  
  if (nextWeekBtn) {
    nextWeekBtn.addEventListener('click', () => {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      updateWeekDisplay();
      loadWeekEvents();
    });
  }
  
  if (syncEventsBtn) {
    syncEventsBtn.addEventListener('click', syncCalendarEvents);
  }
  
  // Availability time inputs
  for (let day = 0; day < 7; day++) {
    const timeStart = document.querySelector(`.day-column[data-day="${day}"] .time-start`);
    const timeEnd = document.querySelector(`.day-column[data-day="${day}"] .time-end`);
    const dayEnabled = document.querySelector(`.day-column[data-day="${day}"] .day-enabled`);
    
    if (timeStart) {
      timeStart.addEventListener('change', () => saveAvailability());
    }
    if (timeEnd) {
      timeEnd.addEventListener('change', () => saveAvailability());
    }
    if (dayEnabled) {
      dayEnabled.addEventListener('change', (e) => {
        const label = e.target.nextElementSibling;
        if (label) {
          label.textContent = e.target.checked ? 'Active' : 'Inactive';
        }
        saveAvailability();
      });
    }
  }
}

function updateWeekDisplay() {
  const weekEnd = new Date(currentWeekStart);
  weekEnd.setDate(weekEnd.getDate() + 6);
  
  const weekDisplay = document.getElementById('current-week-display');
  if (weekDisplay) {
    const startStr = currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const endStr = weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    // Only show year if it's different from current year
    const currentYear = new Date().getFullYear();
    const weekYear = currentWeekStart.getFullYear();
    const yearSuffix = weekYear !== currentYear ? `, ${weekYear}` : '';
    weekDisplay.textContent = `${startStr} - ${endStr}${yearSuffix}`;
  }
  
  // Update date displays for each day
  for (let day = 0; day < 7; day++) {
    const date = new Date(currentWeekStart);
    date.setDate(date.getDate() + day);
    
    const dateDisplay = document.getElementById(`date-${day}`);
    if (dateDisplay) {
      dateDisplay.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
  }
}

function loadWeekEvents() {
  // Check if calendar is connected
  fetch('/api/availability/calendar-status')
    .then(response => response.json())
    .then(data => {
      if (data.connected) {
        fetchWeekEvents();
      } else {
        clearWeekEvents();
      }
    })
    .catch(error => {
      console.error('Error checking calendar status:', error);
      clearWeekEvents();
    });
}

function fetchWeekEvents() {
  const weekEnd = new Date(currentWeekStart);
  weekEnd.setDate(weekEnd.getDate() + 7);
  
  const params = new URLSearchParams({
    start: currentWeekStart.toISOString(),
    end: weekEnd.toISOString()
  });
  
  fetch(`/api/availability/calendar-events?${params}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayWeekEvents(data.events);
      } else {
        console.error('Error fetching events:', data.error);
        clearWeekEvents();
      }
    })
    .catch(error => {
      console.error('Error fetching calendar events:', error);
      clearWeekEvents();
    });
}

function displayWeekEvents(events) {
  // Clear existing events
  clearWeekEvents();
  
  // Group events by day
  const eventsByDay = {};
  for (let day = 0; day < 7; day++) {
    eventsByDay[day] = [];
  }
  
  // Sort events by day
  events.forEach(event => {
    const eventDate = new Date(event.start);
    const dayOfWeek = eventDate.getDay();
    eventsByDay[dayOfWeek].push(event);
  });
  
  // Display events for each day
  for (let day = 0; day < 7; day++) {
    const eventsList = document.getElementById(`events-${day}`);
    if (eventsList && eventsByDay[day].length > 0) {
      eventsList.innerHTML = '';
      eventsByDay[day].forEach(event => {
        const eventElement = createEventElement(event);
        eventsList.appendChild(eventElement);
      });
    }
  }
}

function createEventElement(event) {
  const eventDiv = document.createElement('div');
  eventDiv.className = 'calendar-event';
  
  const startTime = new Date(event.start).toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true 
  });
  
  eventDiv.innerHTML = `
    <span class="event-time">${startTime}</span>
    <span class="event-title">${event.title}</span>
  `;
  
  // Add event type styling
  if (event.title.toLowerCase().includes('meeting')) {
    eventDiv.classList.add('meeting');
  } else if (event.title.toLowerCase().includes('busy')) {
    eventDiv.classList.add('busy');
  } else {
    eventDiv.classList.add('personal');
  }
  
  return eventDiv;
}

function clearWeekEvents() {
  for (let day = 0; day < 7; day++) {
    const eventsList = document.getElementById(`events-${day}`);
    if (eventsList) {
      eventsList.innerHTML = '<div class="no-events">No events</div>';
    }
  }
}

function syncCalendarEvents() {
  const syncBtn = document.getElementById('sync-calendar-events');
  if (syncBtn) {
    syncBtn.disabled = true;
    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  }
  
  fetch('/api/availability/sync-calendar', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      loadWeekEvents();
      showNotification('Calendar events synced successfully!', 'success');
    } else {
      showNotification('Failed to sync calendar events: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Error syncing calendar:', error);
    showNotification('Error syncing calendar events', 'error');
  })
  .finally(() => {
    if (syncBtn) {
      syncBtn.disabled = false;
      syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
    }
  });
}

function showNotification(message, type) {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
  notification.style.position = 'fixed';
  notification.style.top = '20px';
  notification.style.right = '20px';
  notification.style.zIndex = '9999';
  notification.style.minWidth = '300px';
  
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
  // Setup auto-save with a delay to ensure DOM is fully ready
  setTimeout(() => {
    setupAutoSave();
    setupAvailabilityManagement();
    setupWeeklyCalendar();
  }, 100);
});

// Test function - you can call this from browser console
window.testAutoSave = function() {
  console.log('Testing auto-save...');
  const fullNameField = document.getElementById('full_name');
  const bioField = document.getElementById('bio');
  
  console.log('Full name field:', fullNameField);
  console.log('Bio field:', bioField);
  
  if (fullNameField) {
    fullNameField.value = 'Test Name';
    fullNameField.dispatchEvent(new Event('input'));
  }
  
  if (bioField) {
    bioField.value = 'Test Bio';
    bioField.dispatchEvent(new Event('input'));
  }
  
  console.log('Test completed. Check for save messages above.');
};
</script>
{% endblock %} 