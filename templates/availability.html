{% extends "base_signed_in.html" %}

{% block title %}Availability - Droply{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/availability.css') }}">
<style>
  /* Ensure availability page uses transparent backgrounds to show body background */
  .main-content, .content-wrapper {
    background: #2a2a2a !important;
  }
  
  .availability-container {
    background: #2a2a2a !important;
  }

  /* Calendar section improvements */

  .calendar-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    transition: all 0.2s ease;
    color: white;
  }

  .calendar-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.2) !important;
  }

  .calendar-item .calendar-name {
    color: white !important;
  }

  .calendar-item .fab.fa-google {
    color: white !important;
  }

  .calendar-item span {
    color: white !important;
  }

  .calendar-item * {
    color: white !important;
  }

  .calendar-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }

  .calendar-actions .btn:hover {
    transform: translateY(-1px);
  }

  /* Google-style button */
  .google-btn {
    padding: 0.375rem 0.75rem !important;
    font-size: 0.8rem !important;
    min-width: auto !important;
    background-color: white !important;
    color: #5f6368 !important;
    border: 1px solid #dadce0 !important;
    border-radius: 4px !important;
    font-family: 'Google Sans', Roboto, Arial, sans-serif !important;
    font-weight: 500 !important;
    box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15) !important;
    cursor: pointer !important;
    display: inline-flex !important;
    align-items: center !important;
    text-decoration: none !important;
  }

  .google-btn:hover {
    background-color: #f8f9fa !important;
    color: #3c4043 !important;
    border-color: #dadce0 !important;
    box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15) !important;
  }

  .google-btn:focus {
    outline: none !important;
    border-color: #1a73e8 !important;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2) !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="availability-container">
  <!-- Vertical Tab Navigation -->
  <div class="availability-tabs">
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="next-7-days">
        <i class="fas fa-calendar-week"></i>
        <span>Next 7 Days</span>
      </button>
      <button class="tab-button" data-tab="typical-availability">
        <i class="fas fa-clock"></i>
        <span>Typical Availability</span>
      </button>
      <button class="tab-button" data-tab="settings">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Next 7 Days Tab -->
      <div class="tab-panel active" id="next-7-days">
        <div class="tab-header">
          <h3>Next 7 Days Availability</h3>
          <p class="text-muted">Manage your availability for the upcoming week and remove specific hours.</p>
        </div>
        
        <div class="next-7-days-content">
          <!-- Next 7 Days Grid -->
          <div class="next-7-days-grid" id="next-7-days-grid">
            <!-- Days will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Typical Availability Tab -->
      <div class="tab-panel" id="typical-availability">
        <div class="tab-header">
          <h3>Typical Weekly Availability</h3>
          <p class="text-muted">Set your recurring availability patterns for each day of the week.</p>
        </div>
        
        <div class="typical-availability-content">
          <!-- Weekly Hours List -->
          <div class="weekly-hours-list">
            <!-- Sunday -->
            <div class="day-row inactive" data-day="sunday">
              <div class="day-info">
                <span class="day-name">Sunday</span>
              </div>
              <div class="day-schedule">
                <div class="time-inputs-row">
                  <div class="time-input-group">
                    <label class="time-label">Start</label>
                    <input type="time" class="time-input" id="sunday-start" value="09:00" disabled>
                  </div>
                  <div class="time-separator">to</div>
                  <div class="time-input-group">
                    <label class="time-label">End</label>
                    <input type="time" class="time-input" id="sunday-end" value="17:00" disabled>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Monday -->
            <div class="day-row active" data-day="monday">
              <div class="day-info">
                <span class="day-name">Monday</span>
              </div>
              <div class="day-schedule">
                <div class="time-inputs-row">
                  <div class="time-input-group">
                    <label class="time-label">Start</label>
                    <input type="time" class="time-input" id="monday-start" value="09:00">
                  </div>
                  <div class="time-separator">to</div>
                  <div class="time-input-group">
                    <label class="time-label">End</label>
                    <input type="time" class="time-input" id="monday-end" value="17:00">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Tuesday -->
            <div class="day-row active" data-day="tuesday">
              <div class="day-info">
                <span class="day-name">Tuesday</span>
              </div>
              <div class="day-schedule">
                <div class="time-inputs-row">
                  <div class="time-input-group">
                    <label class="time-label">Start</label>
                    <input type="time" class="time-input" id="tuesday-start" value="09:00">
                  </div>
                  <div class="time-separator">to</div>
                  <div class="time-input-group">
                    <label class="time-label">End</label>
                    <input type="time" class="time-input" id="tuesday-end" value="17:00">
                  </div>
                </div>
              </div>
            </div>

            <!-- Wednesday -->
            <div class="day-row active" data-day="wednesday">
              <div class="day-info">
                <span class="day-name">Wednesday</span>
              </div>
              <div class="day-schedule">
                <div class="time-inputs-row">
                  <div class="time-input-group">
                    <label class="time-label">Start</label>
                    <input type="time" class="time-input" id="wednesday-start" value="09:00">
                  </div>
                  <div class="time-separator">to</div>
                  <div class="time-input-group">
                    <label class="time-label">End</label>
                    <input type="time" class="time-input" id="wednesday-end" value="17:00">
                  </div>
                </div>
              </div>
            </div>

            <!-- Thursday -->
            <div class="day-row active" data-day="thursday">
              <div class="day-info">
                <span class="day-name">Thursday</span>
              </div>
              <div class="day-schedule">
                <div class="time-inputs-row">
                  <div class="time-input-group">
                    <label class="time-label">Start</label>
                    <input type="time" class="time-input" id="thursday-start" value="09:00">
                  </div>
                  <div class="time-separator">to</div>
                  <div class="time-input-group">
                    <label class="time-label">End</label>
                    <input type="time" class="time-input" id="thursday-end" value="17:00">
                  </div>
                </div>
              </div>
            </div>

            <!-- Friday -->
            <div class="day-row active" data-day="friday">
              <div class="day-info">
                <span class="day-name">Friday</span>
              </div>
              <div class="day-schedule">
                <div class="time-inputs-row">
                  <div class="time-input-group">
                    <label class="time-label">Start</label>
                    <input type="time" class="time-input" id="friday-start" value="09:00">
                  </div>
                  <div class="time-separator">to</div>
                  <div class="time-input-group">
                    <label class="time-label">End</label>
                    <input type="time" class="time-input" id="friday-end" value="17:00">
                  </div>
                </div>
              </div>
            </div>

            <!-- Saturday -->
            <div class="day-row inactive" data-day="saturday">
              <div class="day-info">
                <span class="day-name">Saturday</span>
              </div>
              <div class="day-schedule">
                <div class="time-inputs-row">
                  <div class="time-input-group">
                    <label class="time-label">Start</label>
                    <input type="time" class="time-input" id="saturday-start" value="09:00" disabled>
                  </div>
                  <div class="time-separator">to</div>
                  <div class="time-input-group">
                    <label class="time-label">End</label>
                    <input type="time" class="time-input" id="saturday-end" value="17:00" disabled>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-panel" id="settings">
        <div class="tab-header">
          <h3>Settings</h3>
          <p class="text-muted">Configure your timezone and calendar integration settings.</p>
        </div>
        
        <div class="settings-content">
          <!-- Timezone Settings -->
          <div class="settings-card">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-globe"></i>
              </div>
              <div class="card-title">Timezone</div>
            </div>
            <div class="card-body">
              <div class="mb-4">
                <select id="timezone-select" class="form-select form-select-lg" style="width: 100%; max-width: 100%;">
                  <option value="">Select your timezone...</option>
                  <!-- Timezone options will be populated by JavaScript -->
                </select>
                <div class="form-text">
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Your availability will be automatically converted to each client's timezone.
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar Settings -->
          <div class="settings-card">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="card-title">Calendar Integration</div>
            </div>
            <div class="card-body">
              <!-- Connected Calendars List -->
              <div id="connected-calendars" class="mb-3" style="display: none;">
                <div class="calendar-list">
                  <!-- Connected calendars will be populated here -->
                </div>
              </div>

              <!-- Connect Button -->
              <div class="text-center">
                <button id="connect-calendar-btn-settings" class="google-btn">
                  <i class="fab fa-google me-1"></i>
                  <span id="connect-btn-text">Connect Calendar</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Save Button -->
    <div class="text-center mt-4">
      <button id="save-availability-btn" class="btn btn-primary btn-lg w-100" disabled>
        <i class="fas fa-save"></i>
        Save Availability
      </button>
    </div>
  </div>
</div>

<!-- Corporate Warning Modal -->
<div class="modal fade" id="unsavedChangesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content corporate-modal">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Unsaved Changes
                </h5>
            </div>
            <div class="modal-body">
                <p class="mb-3">You have unsaved changes to your availability settings.</p>
                <p class="text-muted mb-0">Make sure to click "Save Availability" to save your changes before proceeding.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-2"></i>
                    Go Back
                </button>
                <button type="button" class="btn btn-danger" id="discardChangesBtn">
                    <i class="fas fa-times me-2"></i>
                    Discard Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load data before initializing UI to prevent flashing
    Promise.all([
        loadAvailabilityRulesAsync()
    ]).then(() => {
        // Initialize the availability management system after data is loaded
        initializeAvailabilitySystem();
        
        // Check Google Calendar connection status
        checkCalendarConnectionStatus();
        
        // Setup event listeners
        setupEventListeners();
        
        // Setup tab navigation
        setupTabNavigation();
        
        // Load Next 7 Days data
        loadNext7DaysData();
        
        // Populate timezone options with user's timezone as default
        populateTimezoneOptions();
        
        // Show the content with a smooth fade-in
        document.querySelector('.availability-container').style.opacity = '1';
    });
    
});

function initializeAvailabilitySystem() {
    console.log('Initializing availability system...');
    
    // Store initial state for change detection
    storeInitialState();
    
    // Set up change detection
    setupChangeDetection();
}

function loadAvailabilityRulesAsync() {
    return fetch('/api/availability/rules')
    .then(response => response.json())
    .then(data => {
            // The API returns an array directly, not wrapped in success object
            if (Array.isArray(data)) {
                updateAvailabilityDisplay(data);
                return data;
            }
            return [];
    })
    .catch(error => {
            console.error('Error loading availability rules:', error);
            return [];
        });
}

function loadAvailabilityRules() {
    loadAvailabilityRulesAsync().then(() => {
        // Store initial state after loading data
        setTimeout(() => {
            storeInitialState();
            checkForChanges();
        }, 100);
    });
}


function checkCalendarConnectionStatus() {
    fetch('/api/availability/calendar-status')
    .then(response => response.json())
    .then(data => {
            updateCalendarStatus(data.connected);
    })
    .catch(error => {
            console.error('Error checking calendar status:', error);
        });
}

function updateAvailabilityDisplay(rules) {
    console.log('Updating availability display with rules:', rules);
    
    // First, set all days to inactive
    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    dayNames.forEach((dayName, index) => {
        const dayRow = document.querySelector(`[data-day="${dayName}"]`);
        const daySchedule = dayRow.querySelector('.day-schedule');
        const dayStatus = dayRow.querySelector('.day-status');
        
        // Set row to inactive
        dayRow.classList.remove('active');
        dayRow.classList.add('inactive');
        
        // ALWAYS show time inputs (even for inactive days)
        if (daySchedule) {
            daySchedule.style.display = 'flex';
            const startInput = daySchedule.querySelector(`#${dayName}-start`);
            const endInput = daySchedule.querySelector(`#${dayName}-end`);
            
            if (startInput) {
                startInput.disabled = true;
            }
            if (endInput) {
                endInput.disabled = true;
            }
        }
        
        // Hide any status text
        if (dayStatus) {
            dayStatus.style.display = 'none';
        }
    });
    
    // Apply rules
    rules.forEach(rule => {
        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayName = dayNames[rule.weekday];
        const dayRow = document.querySelector(`[data-day="${dayName}"]`);
        const daySchedule = dayRow.querySelector('.day-schedule');
        const dayStatus = dayRow.querySelector('.day-status');
        
        if (dayRow && rule.is_active) {
            // Set row to active
            dayRow.classList.remove('inactive');
            dayRow.classList.add('active');
            
            // Enable time inputs
            if (daySchedule) {
                daySchedule.style.display = 'flex';
                const startInput = daySchedule.querySelector(`#${dayName}-start`);
                const endInput = daySchedule.querySelector(`#${dayName}-end`);
                
                if (startInput) {
                    startInput.value = rule.start;
                    startInput.disabled = false;
                }
                if (endInput) {
                    endInput.value = rule.end;
                    endInput.disabled = false;
                }
            }
            
            // Hide unavailable text
            if (dayStatus) {
                dayStatus.style.display = 'none';
            }
        }
    });
}

function updateCalendarStatus(connected) {
    const connectBtn = document.getElementById('connect-calendar-btn');
    const connectBtnText = document.getElementById('connect-btn-text');
    const connectedCalendars = document.getElementById('connected-calendars');
    
    if (connected) {
        connectBtnText.textContent = 'Add Another';
        connectBtn.onclick = () => connectCalendar();
        connectedCalendars.style.display = 'block';
        
        // Load connected calendars
        loadConnectedCalendars();
    } else {
        connectBtnText.textContent = 'Connect Calendar';
        connectBtn.onclick = () => connectCalendar();
        connectedCalendars.style.display = 'none';
    }
}

function loadConnectedCalendars() {
    // Fetch connected calendar info from API
    fetch('/api/connected-calendar')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Calendar API response:', data);
            const calendarList = document.querySelector('.calendar-list');
            if (data.connected) {
                calendarList.innerHTML = `
                    <div class="calendar-item d-flex align-items-center justify-content-between p-2 border rounded">
                        <div class="d-flex align-items-center">
                            <i class="fab fa-google text-primary me-2"></i>
                            <span class="calendar-name fw-medium">${data.calendar_name || 'Google Calendar'}</span>
                        </div>
                        <div class="calendar-actions">
                            <button class="btn btn-sm btn-outline-secondary me-1" title="Sync" onclick="syncCalendar()">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" title="Disconnect" onclick="disconnectCalendar()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Show appropriate message based on the error
                let message = data.message || 'No calendar connected';
                let icon = 'fas fa-calendar-times';
                let actionButton = '';
                
                if (data.message && (data.message.includes('expired') || data.message.includes('reconnect'))) {
                    icon = 'fas fa-exclamation-triangle';
                    actionButton = '<button class="btn btn-sm btn-primary ms-2" onclick="connectCalendar()">Reconnect</button>';
                } else if (data.message && data.message.includes('permissions')) {
                    icon = 'fas fa-lock';
                    actionButton = '<button class="btn btn-sm btn-primary ms-2" onclick="connectCalendar()">Grant Access</button>';
                }
                
                calendarList.innerHTML = `
                    <div class="calendar-item text-muted text-center py-2">
                        <i class="${icon} me-2"></i>
                        <span>${message}</span>
                        ${actionButton}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading connected calendars:', error);
            const calendarList = document.querySelector('.calendar-list');
            calendarList.innerHTML = `
                <div class="calendar-item text-muted text-center py-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>Error loading calendar info: ${error.message}</span>
                    <button class="btn btn-sm btn-primary ms-2" onclick="connectCalendar()">Try Again</button>
                </div>
            `;
        });
}

function toggleDay(day, isActive) {
    const dayRow = document.querySelector(`[data-day="${day}"]`);
    const daySchedule = dayRow.querySelector('.day-schedule');
    const dayStatus = dayRow.querySelector('.day-status');
    
    if (isActive) {
        dayRow.classList.remove('inactive');
        dayRow.classList.add('active');
        
        // Enable time inputs
        if (daySchedule) {
            daySchedule.style.display = 'flex';
            const startInput = daySchedule.querySelector(`#${day}-start`);
            const endInput = daySchedule.querySelector(`#${day}-end`);
            
            if (startInput) startInput.disabled = false;
            if (endInput) endInput.disabled = false;
        }
        
        // Hide any status text
        if (dayStatus) {
            dayStatus.style.display = 'none';
        }
    } else {
        dayRow.classList.remove('active');
        dayRow.classList.add('inactive');
        
        // Disable time inputs but keep them visible
        if (daySchedule) {
            daySchedule.style.display = 'flex';
            const startInput = daySchedule.querySelector(`#${day}-start`);
            const endInput = daySchedule.querySelector(`#${day}-end`);
            
            if (startInput) startInput.disabled = true;
            if (endInput) endInput.disabled = true;
        }
        
        // Hide any status text
        if (dayStatus) {
            dayStatus.style.display = 'none';
        }
    }
}

function connectCalendar() {
    window.location.href = '/auth/google-calendar';
}

function disconnectCalendar() {
    if (confirm('Are you sure you want to disconnect your calendar? This will stop syncing your availability with your calendar events.')) {
        fetch('/disconnect-google-calendar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                // Refresh the calendar status
                checkCalendarConnectionStatus();
                alert('Calendar disconnected successfully!');
            } else {
                throw new Error('Failed to disconnect calendar');
            }
        })
        .catch(error => {
            console.error('Error disconnecting calendar:', error);
            alert('Error disconnecting calendar');
        });
    }
}

function syncCalendar() {
    fetch('/api/availability/sync-calendar', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
        }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
            alert('Calendar synced successfully!');
    } else {
            alert('Error syncing calendar: ' + data.message);
    }
  })
  .catch(error => {
        console.error('Error syncing calendar:', error);
        alert('Error syncing calendar');
    });
}

function setupEventListeners() {
    // Save availability button
    document.getElementById('save-availability-btn').addEventListener('click', function() {
        saveAvailabilityRules();
    });
    
    // Day toggle switches - removed, using click handlers instead
    
    // Day info click handlers - clicking on the day-info area toggles the day
    document.querySelectorAll('.day-info').forEach(dayInfo => {
        dayInfo.addEventListener('click', function(e) {
            const dayRow = this.closest('.day-row');
            const day = dayRow.getAttribute('data-day');
            
            // Toggle the day directly
            const isCurrentlyActive = dayRow.classList.contains('active');
            toggleDay(day, !isCurrentlyActive);
            checkForChanges();
        });
    });
    
    // Mobile-specific day activation
    setupMobileDayActivation();
  
    // Time input changes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('time-input')) {
            checkForChanges();
        }
    });
    
    // Make time inputs clickable to open time picker
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('time-input')) {
            e.target.focus();
            e.target.click();
        }
    });
    
    // Navigation warning system
    setupNavigationWarning();
    
    // Modal event handlers
    setupModalHandlers();
}

// Tab Navigation Functions
function setupTabNavigation() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and panels
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanels.forEach(panel => panel.classList.remove('active'));
            
            // Add active class to clicked button and corresponding panel
            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
}

// Next 7 Days Functions
function loadNext7DaysData() {
    fetch('/api/availability/next-7-days')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderNext7DaysGrid(data.days);
                loadCalendarEventsForNext7Days(data.days);
            } else {
                console.error('Error loading Next 7 Days data:', data.error);
                // Fallback to basic implementation
                const today = new Date();
                const next7Days = [];
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    next7Days.push({
                        date: date.toISOString().split('T')[0],
                        day_name: date.toLocaleDateString('en-US', { weekday: 'long' }),
                        typical_availability: { start: '09:00', end: '17:00', enabled: true }
                    });
                }
                
                renderNext7DaysGrid(next7Days);
            }
        })
        .catch(error => {
            console.error('Error loading Next 7 Days data:', error);
        });
}

function renderNext7DaysGrid(days) {
    const grid = document.getElementById('next-7-days-grid');
    grid.innerHTML = '';
    
    days.forEach((dayData, index) => {
        const dayCard = createDayCard(dayData, index);
        grid.appendChild(dayCard);
    });
}

function createDayCard(dayData, index) {
    const dayCard = document.createElement('div');
    dayCard.className = 'day-card';
    dayCard.setAttribute('data-date', dayData.date);
    
    const date = new Date(dayData.date);
    const dateStr = date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
    });
    
    const availability = dayData.typical_availability;
    const startTime = formatTimeForDisplay(parseInt(availability.start.split(':')[0]));
    const endTime = formatTimeForDisplay(parseInt(availability.end.split(':')[0]));
    
    dayCard.innerHTML = `
        <div class="day-card-header">
            <div class="day-name">${dayData.day_name}</div>
            <div class="day-date">${dateStr}</div>
        </div>
        <div class="availability-window">
            <div class="availability-window-header">
                <div class="availability-window-title">Typical Availability</div>
                <div class="availability-window-times">${startTime} - ${endTime}</div>
            </div>
            <div class="time-slots-grid" id="time-slots-${index}">
                <!-- Time slots will be populated here -->
            </div>
        </div>
    `;
    
    // Generate time slots for this day
    generateTimeSlots(dayCard, index, dayData);
    
    return dayCard;
}

function generateTimeSlots(dayCard, dayIndex, dayData) {
    const timeSlotsContainer = dayCard.querySelector('.time-slots-grid');
    const slots = [];
    
    const availability = dayData.typical_availability;
    const startHour = parseInt(availability.start.split(':')[0]);
    const endHour = parseInt(availability.end.split(':')[0]);
    
    // Generate hourly slots based on typical availability
    for (let hour = startHour; hour < endHour; hour++) {
        const timeStr = `${hour.toString().padStart(2, '0')}:00`;
        const displayTime = formatTimeForDisplay(hour);
        
        const slot = document.createElement('div');
        slot.className = 'time-slot available';
        slot.setAttribute('data-time', timeStr);
        slot.setAttribute('data-day-index', dayIndex);
        slot.setAttribute('data-date', dayData.date);
        slot.textContent = displayTime;
        
        // Check if this slot is in removed slots
        const isRemoved = dayData.removed_slots && dayData.removed_slots.some(removed => {
            const removedStart = parseInt(removed.start.split(':')[0]);
            const removedEnd = parseInt(removed.end.split(':')[0]);
            return hour >= removedStart && hour < removedEnd;
        });
        
        if (isRemoved) {
            slot.classList.remove('available');
            slot.classList.add('removed');
        }
        
        // Add click handler for removing/adding slots
        slot.addEventListener('click', function() {
            toggleTimeSlot(this);
        });
        
        slots.push(slot);
    }
    
    timeSlotsContainer.innerHTML = '';
    slots.forEach(slot => timeSlotsContainer.appendChild(slot));
}

function formatTimeForDisplay(hour) {
    if (hour === 0) return '12:00 AM';
    if (hour < 12) return `${hour}:00 AM`;
    if (hour === 12) return '12:00 PM';
    return `${hour - 12}:00 PM`;
}

function toggleTimeSlot(slot) {
    if (slot.classList.contains('booked')) {
        return; // Can't toggle booked slots
    }
    
    if (slot.classList.contains('removed')) {
        slot.classList.remove('removed');
        slot.classList.add('available');
    } else {
        slot.classList.remove('available');
        slot.classList.add('removed');
    }
    
    // Save changes to backend
    saveRemovedSlots(slot);
    checkForChanges();
}

function saveRemovedSlots(changedSlot) {
    const date = changedSlot.getAttribute('data-date');
    const dayCard = changedSlot.closest('.day-card');
    const timeSlots = dayCard.querySelectorAll('.time-slot');
    
    // Collect all removed slots for this date
    const removedSlots = [];
    let currentRemovedSlot = null;
    
    timeSlots.forEach(slot => {
        if (slot.classList.contains('removed')) {
            const time = slot.getAttribute('data-time');
            const hour = parseInt(time.split(':')[0]);
            
            if (!currentRemovedSlot || currentRemovedSlot.endHour !== hour) {
                // Start a new removed slot
                if (currentRemovedSlot) {
                    removedSlots.push(currentRemovedSlot);
                }
                currentRemovedSlot = {
                    start: time,
                    end: `${(hour + 1).toString().padStart(2, '0')}:00`
                };
            } else {
                // Extend current removed slot
                currentRemovedSlot.end = `${(hour + 1).toString().padStart(2, '0')}:00`;
            }
        } else if (currentRemovedSlot) {
            // End current removed slot
            removedSlots.push(currentRemovedSlot);
            currentRemovedSlot = null;
        }
    });
    
    // Add the last removed slot if it exists
    if (currentRemovedSlot) {
        removedSlots.push(currentRemovedSlot);
    }
    
    // Save to backend
    fetch('/api/availability/next-7-days', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            date: date,
            removed_slots: removedSlots
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Error saving removed slots:', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving removed slots:', error);
    });
}

function loadCalendarEventsForNext7Days(days) {
    if (!days || days.length === 0) return;
    
    const startDate = days[0].date;
    const endDate = days[days.length - 1].date;
    
    fetch(`/api/availability/calendar-events?start=${startDate}&end=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.events) {
                markBookedSlots(data.events, days);
            }
        })
        .catch(error => {
            console.error('Error loading calendar events:', error);
        });
}

function markBookedSlots(events, days) {
    events.forEach(event => {
        const eventDate = new Date(event.start.dateTime || event.start.date);
        const eventDateStr = eventDate.toISOString().split('T')[0];
        
        // Find the corresponding day card
        const dayCard = document.querySelector(`[data-date="${eventDateStr}"]`);
        if (dayCard) {
            const eventHour = eventDate.getHours();
            const timeSlot = dayCard.querySelector(`[data-time="${eventHour.toString().padStart(2, '0')}:00"]`);
            
            if (timeSlot) {
                timeSlot.classList.remove('available', 'removed');
                timeSlot.classList.add('booked');
                timeSlot.title = event.summary || 'Booked';
            }
        }
    });
}

function setupNavigationWarning() {
    // Intercept navigation attempts
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && hasUnsavedChanges) {
            e.preventDefault();
            pendingNavigation = link.href;
            showUnsavedChangesModal();
        }
    });
    
    // Intercept form submissions
    document.addEventListener('submit', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            showUnsavedChangesModal();
        }
    });
    
    // Intercept browser back/forward
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
}

function setupModalHandlers() {
    // Discard changes button
    document.getElementById('discardChangesBtn').addEventListener('click', function() {
        hasUnsavedChanges = false;
        if (pendingNavigation) {
            window.location.href = pendingNavigation;
        }
        bootstrap.Modal.getInstance(document.getElementById('unsavedChangesModal')).hide();
    });
}

function showUnsavedChangesModal() {
    const modal = new bootstrap.Modal(document.getElementById('unsavedChangesModal'));
    modal.show();
}

// Store initial state for change detection
let initialState = {};
let hasUnsavedChanges = false;
let pendingNavigation = null;

function storeInitialState() {
    initialState = {
        days: {},
        times: {}
    };
    
    // Store day active states
    document.querySelectorAll('.day-row').forEach(dayRow => {
        const day = dayRow.getAttribute('data-day');
        initialState.days[day] = dayRow.classList.contains('active');
    });
    
    // Store time values
    document.querySelectorAll('.time-input').forEach(input => {
        initialState.times[input.id] = input.value;
    });
    
    hasUnsavedChanges = false;
}

function setupChangeDetection() {
    // Check for changes every 500ms
    setInterval(checkForChanges, 500);
}

function checkForChanges() {
    const saveBtn = document.getElementById('save-availability-btn');
    let hasChanges = false;
    
    // Check day active states
    document.querySelectorAll('.day-row').forEach(dayRow => {
        const day = dayRow.getAttribute('data-day');
        const isCurrentlyActive = dayRow.classList.contains('active');
        if (isCurrentlyActive !== initialState.days[day]) {
            hasChanges = true;
        }
    });
    
    // Check time inputs
    document.querySelectorAll('.time-input').forEach(input => {
        if (input.value !== initialState.times[input.id]) {
            hasChanges = true;
        }
    });
    
    // Update unsaved changes flag
    hasUnsavedChanges = hasChanges;
    
    // Enable/disable save button
    if (hasChanges) {
        saveBtn.disabled = false;
        saveBtn.classList.remove('btn-secondary');
        saveBtn.classList.add('btn-primary');
    } else {
        saveBtn.disabled = true;
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-secondary');
    }
}


function saveAvailabilityRules() {
    const rules = [];
    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    
    dayNames.forEach((dayName, index) => {
        const dayRow = document.querySelector(`[data-day="${dayName}"]`);
        const startInput = document.getElementById(`${dayName}-start`);
        const endInput = document.getElementById(`${dayName}-end`);
        
        // Only include active days with valid times
        if (dayRow && dayRow.classList.contains('active') && startInput && endInput && startInput.value && endInput.value) {
            rules.push({
                weekday: index,
                start: startInput.value,
                end: endInput.value,
                enabled: true  // Changed from is_active to enabled to match API
            });
        }
    });
    
    console.log('Saving availability rules:', rules);
    
    // Show loading state
    const saveBtn = document.getElementById('save-availability-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Saving...';
    saveBtn.disabled = true;
    
    fetch('/api/availability/rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ rules: rules })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update initial state to reflect saved changes
            storeInitialState();
            
            // Show success message
            saveBtn.innerHTML = '<i class="fas fa-check"></i>Saved!';
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('btn-success');
            
            // Reset button after 2 seconds
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-primary');
                checkForChanges(); // This will disable the button if no changes
            }, 2000);
            
            console.log('Availability saved successfully!');
        } else {
            throw new Error(data.message || 'Failed to save availability');
      }
    })
    .catch(error => {
        console.error('Error saving availability:', error);
        
        // Show error state
        saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-danger');
        
        // Reset button after 3 seconds
        setTimeout(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.classList.remove('btn-danger');
            saveBtn.classList.add('btn-primary');
            saveBtn.disabled = false;
        }, 3000);
        
        alert('Error saving availability: ' + error.message);
    });
}

function addTimeSlot(day) {
    const dayRow = document.querySelector(`[data-day="${day}"]`);
    const dayStatus = dayRow.querySelector('.day-status');
    const daySchedule = dayRow.querySelector('.day-schedule');
    
    if (daySchedule) {
        daySchedule.style.display = 'flex';
        daySchedule.innerHTML = `
            <div class="time-label d-md-none">Set your hours:</div>
            <div class="time-slot">
                <input type="time" class="form-control form-control-sm time-input" id="${day}-start" value="09:00" style="width: 100%; max-width: 80px;">
                <span class="time-separator">-</span>
                <input type="time" class="form-control form-control-sm time-input" id="${day}-end" value="17:00" style="width: 100%; max-width: 80px;">
            </div>
        `;
    } else {
        // Create time schedule if it doesn't exist
        const dayInfoRight = dayRow.querySelector('.day-info-right');
        const newSchedule = document.createElement('div');
        newSchedule.className = 'day-schedule';
        newSchedule.innerHTML = `
            <div class="time-slot">
                <div class="time-label">START</div>
                <input type="time" class="time-input" id="${day}-start" value="09:00">
            </div>
            <div class="time-slot">
                <div class="time-label">END</div>
                <input type="time" class="time-input" id="${day}-end" value="17:00">
            </div>
        `;
        dayInfoRight.appendChild(newSchedule);
    }
    
    if (dayStatus) {
        dayStatus.style.display = 'none';
    }
    
    // Update row state
    dayRow.classList.remove('inactive');
    dayRow.classList.add('active');
}


// Populate timezone options
function populateTimezoneOptions() {
    // Get user's current timezone
    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    console.log('User timezone detected:', userTimezone);
    
    const timezones = [
        // North America
        { value: 'America/New_York', label: 'Eastern Time (ET) - New York' },
        { value: 'America/Chicago', label: 'Central Time (CT) - Chicago' },
        { value: 'America/Denver', label: 'Mountain Time (MT) - Denver' },
        { value: 'America/Los_Angeles', label: 'Pacific Time (PT) - Los Angeles' },
        { value: 'America/Toronto', label: 'Eastern Time (ET) - Toronto' },
        { value: 'America/Vancouver', label: 'Pacific Time (PT) - Vancouver' },
        { value: 'America/Montreal', label: 'Eastern Time (ET) - Montreal' },
        { value: 'America/Calgary', label: 'Mountain Time (MT) - Calgary' },
        { value: 'America/Winnipeg', label: 'Central Time (CT) - Winnipeg' },
        { value: 'America/Halifax', label: 'Atlantic Time (AT) - Halifax' },
        { value: 'America/St_Johns', label: 'Newfoundland Time (NT) - St. John\'s' },
        
        // Europe
        { value: 'Europe/London', label: 'Greenwich Mean Time (GMT) - London' },
        { value: 'Europe/Paris', label: 'Central European Time (CET) - Paris' },
        { value: 'Europe/Berlin', label: 'Central European Time (CET) - Berlin' },
        { value: 'Europe/Rome', label: 'Central European Time (CET) - Rome' },
        { value: 'Europe/Madrid', label: 'Central European Time (CET) - Madrid' },
        { value: 'Europe/Amsterdam', label: 'Central European Time (CET) - Amsterdam' },
        { value: 'Europe/Zurich', label: 'Central European Time (CET) - Zurich' },
        { value: 'Europe/Vienna', label: 'Central European Time (CET) - Vienna' },
        { value: 'Europe/Stockholm', label: 'Central European Time (CET) - Stockholm' },
        { value: 'Europe/Oslo', label: 'Central European Time (CET) - Oslo' },
        { value: 'Europe/Copenhagen', label: 'Central European Time (CET) - Copenhagen' },
        { value: 'Europe/Helsinki', label: 'Eastern European Time (EET) - Helsinki' },
        { value: 'Europe/Warsaw', label: 'Central European Time (CET) - Warsaw' },
        { value: 'Europe/Prague', label: 'Central European Time (CET) - Prague' },
        { value: 'Europe/Budapest', label: 'Central European Time (CET) - Budapest' },
        { value: 'Europe/Athens', label: 'Eastern European Time (EET) - Athens' },
        { value: 'Europe/Istanbul', label: 'Turkey Time (TRT) - Istanbul' },
        { value: 'Europe/Moscow', label: 'Moscow Time (MSK) - Moscow' },
        
        // Asia
        { value: 'Asia/Tokyo', label: 'Japan Standard Time (JST) - Tokyo' },
        { value: 'Asia/Shanghai', label: 'China Standard Time (CST) - Shanghai' },
        { value: 'Asia/Hong_Kong', label: 'Hong Kong Time (HKT) - Hong Kong' },
        { value: 'Asia/Singapore', label: 'Singapore Time (SGT) - Singapore' },
        { value: 'Asia/Seoul', label: 'Korea Standard Time (KST) - Seoul' },
        { value: 'Asia/Taipei', label: 'Taiwan Time (CST) - Taipei' },
        { value: 'Asia/Bangkok', label: 'Indochina Time (ICT) - Bangkok' },
        { value: 'Asia/Jakarta', label: 'Western Indonesia Time (WIB) - Jakarta' },
        { value: 'Asia/Manila', label: 'Philippine Time (PHT) - Manila' },
        { value: 'Asia/Kolkata', label: 'India Standard Time (IST) - Mumbai' },
        { value: 'Asia/Dubai', label: 'Gulf Standard Time (GST) - Dubai' },
        { value: 'Asia/Tehran', label: 'Iran Standard Time (IRST) - Tehran' },
        { value: 'Asia/Karachi', label: 'Pakistan Standard Time (PKT) - Karachi' },
        { value: 'Asia/Dhaka', label: 'Bangladesh Standard Time (BST) - Dhaka' },
        
        // Australia & Oceania
        { value: 'Australia/Sydney', label: 'Australian Eastern Time (AEST) - Sydney' },
        { value: 'Australia/Melbourne', label: 'Australian Eastern Time (AEST) - Melbourne' },
        { value: 'Australia/Brisbane', label: 'Australian Eastern Time (AEST) - Brisbane' },
        { value: 'Australia/Perth', label: 'Australian Western Time (AWST) - Perth' },
        { value: 'Australia/Adelaide', label: 'Australian Central Time (ACST) - Adelaide' },
        { value: 'Australia/Darwin', label: 'Australian Central Time (ACST) - Darwin' },
        { value: 'Pacific/Auckland', label: 'New Zealand Time (NZST) - Auckland' },
        { value: 'Pacific/Fiji', label: 'Fiji Time (FJT) - Suva' },
        
        // Africa
        { value: 'Africa/Cairo', label: 'Eastern European Time (EET) - Cairo' },
        { value: 'Africa/Johannesburg', label: 'South Africa Time (SAST) - Johannesburg' },
        { value: 'Africa/Lagos', label: 'West Africa Time (WAT) - Lagos' },
        { value: 'Africa/Casablanca', label: 'Western European Time (WET) - Casablanca' },
        { value: 'Africa/Nairobi', label: 'East Africa Time (EAT) - Nairobi' },
        
        // South America
        { value: 'America/Sao_Paulo', label: 'Brasilia Time (BRT) - São Paulo' },
        { value: 'America/Argentina/Buenos_Aires', label: 'Argentina Time (ART) - Buenos Aires' },
        { value: 'America/Santiago', label: 'Chile Time (CLT) - Santiago' },
        { value: 'America/Lima', label: 'Peru Time (PET) - Lima' },
        { value: 'America/Bogota', label: 'Colombia Time (COT) - Bogotá' },
        { value: 'America/Caracas', label: 'Venezuela Time (VET) - Caracas' },
        { value: 'America/Mexico_City', label: 'Central Time (CT) - Mexico City' },
        
        // UTC
        { value: 'UTC', label: 'Coordinated Universal Time (UTC)' }
    ];
    
    const select = document.getElementById('timezone-select');
    timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz.value;
        option.textContent = tz.label;
        
        // Set user's timezone as selected by default
        if (tz.value === userTimezone) {
            option.selected = true;
        }
        
        select.appendChild(option);
    });
    
    // If no exact match found, try to find a close match
    if (!select.value) {
        const timezoneParts = userTimezone.split('/');
        if (timezoneParts.length > 1) {
            const region = timezoneParts[0];
            const city = timezoneParts[1];
            
            // Try to find a match in the same region
            const regionMatch = timezones.find(tz => tz.value.startsWith(region));
            if (regionMatch) {
                select.value = regionMatch.value;
            }
        }
    }
}


// Mobile feedback function
function showMobileFeedback(message, type) {
    // Remove existing feedback
    const existingFeedback = document.querySelector('.mobile-feedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    // Create feedback element
    const feedback = document.createElement('div');
    feedback.className = `mobile-feedback alert alert-${type} alert-dismissible fade show`;
    feedback.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        max-width: 90%;
        text-align: center;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    feedback.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(feedback);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.remove();
        }
    }, 3000);
}

// Mobile day activation setup
function setupMobileDayActivation() {
    // Only run on mobile devices
    if (window.innerWidth > 768) return;
    
    document.querySelectorAll('.day-row').forEach(dayRow => {
        // Remove any existing click handlers to avoid conflicts
        dayRow.onclick = null;
        
        // Add mobile-specific click handler
        dayRow.addEventListener('click', handleMobileDayClick);
        
        // Add mobile-specific styling
        dayRow.classList.add('mobile-day-row');
    });
}

// Handle mobile day row clicks
function handleMobileDayClick(e) {
    // Don't trigger if clicking on time inputs
    if (e.target.classList.contains('time-input') ||
        e.target.closest('.day-schedule')) {
        return;
    }
    
    const day = this.getAttribute('data-day');
    const toggle = document.getElementById(`${day}-toggle`);
    const mobileStatus = this.querySelector('.mobile-status .status-text');
    
    if (toggle) {
        // Toggle the day
        const isCurrentlyActive = toggle.checked;
        toggle.checked = !isCurrentlyActive;
        
        // Update mobile status text
        if (mobileStatus) {
            if (!isCurrentlyActive) {
                mobileStatus.textContent = 'Active';
                mobileStatus.classList.add('active');
            } else {
                mobileStatus.textContent = 'Tap to activate';
                mobileStatus.classList.remove('active');
            }
        }
        
        // Trigger the change event to update the UI
        toggle.dispatchEvent(new Event('change'));
        checkForChanges();
        
        // Add haptic feedback
        if ('vibrate' in navigator) {
            navigator.vibrate(10);
        }
        
        // Show mobile feedback
        if (!isCurrentlyActive) {
            showMobileFeedback('Day activated! Set your hours below.', 'success');
        } else {
            showMobileFeedback('Day deactivated', 'info');
        }
    }
}

</script>
{% endblock %}
