{% extends "base_signed_in.html" %}

{% block title %}Availability - Droply{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Availability Header -->
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1">
                        <i data-feather="calendar-check" class="me-2"></i>Availability Management
                    </h2>
                    <p class="text-muted mb-0">Set when you're available for sessions and manage your calendar</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Calendar Status - Minimal -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between py-2 px-3 bg-light rounded">
                <div class="d-flex align-items-center">
                    <i class="fab fa-google text-primary me-2" style="font-size: 0.9rem;"></i>
                <div id="calendar-connection-status">
                    <div id="calendar-not-connected" style="display: none;">
                        <small class="text-muted">Calendar not connected</small>
                    </div>
                    <div id="calendar-connected">
                        <small class="text-success">
                            <i class="fas fa-check-circle me-1"></i>
                            Calendar connected
                        </small>
                    </div>
                </div>
                </div>
                <div class="calendar-actions">
                    <a href="/auth/google-calendar" class="btn btn-outline-primary btn-sm" id="connect-calendar-btn" style="display: none; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        <i class="fab fa-google me-1"></i>
                        Connect
                    </a>
                    <form action="/disconnect-google-calendar" method="POST" style="display: inline;" id="disconnect-calendar-form">
                        <button type="submit" class="btn btn-outline-danger btn-sm" id="disconnect-calendar-btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                            <i class="fas fa-unlink me-1"></i>
                            Disconnect
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Calendar View -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-calendar-alt text-primary me-2"></i>
                            Monthly Calendar & Availability
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" id="bulk-settings-btn">
                                <i class="fas fa-cog me-1"></i>Bulk Settings
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="sync-calendar-events" title="Sync Calendar Events">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted">Click on any day to set your availability. Green days are available for booking, gray days are not available.</p>
                    
                    <!-- Calendar Navigation -->
                    <div class="calendar-navigation mb-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <button class="btn btn-outline-secondary" id="prev-month">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h4 class="mb-0" id="current-month-display">September 2025</h4>
                            <button class="btn btn-outline-secondary" id="next-month">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Availability Management Interface -->
                    <div class="availability-interface">
                        <!-- Instructions -->
                        <div class="instructions mb-3">
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Click on any day to set your availability. Green days are available for booking, gray days are not available.
                            </p>
                        </div>
                        
                        <!-- Two Column Layout -->
                        <div class="row">
                            <!-- Calendar Column -->
                            <div class="col-md-8">
                                <div class="availability-calendar">
                                    <div class="calendar-grid" id="calendar-grid">
                                        <!-- Calendar will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Time Slots Column -->
                            <div class="col-md-4">
                                <div class="time-slots-panel" id="time-slots-panel">
                                    <div class="time-slots-header">
                                        <h6 id="time-slots-title">Select a day to set availability</h6>
                                    </div>
                                    <div class="time-slots-content" id="time-slots-content">
                                        <div class="time-slots-placeholder">
                                            <i class="fas fa-calendar-alt"></i>
                                            <p>Click on any day in the calendar to set your availability</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    
                    <!-- Bulk Actions -->
                    <div class="mt-4">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-success btn-sm" id="set-weekdays-btn">
                                <i class="fas fa-calendar-week me-1"></i>SET WEEKDAYS (MON-FRI)
                            </button>
                            <button class="btn btn-outline-success btn-sm" id="set-weekends-btn">
                                <i class="fas fa-calendar-week me-1"></i>SET WEEKENDS (SAT-SUN)
                            </button>
                            <button class="btn btn-outline-danger btn-sm" id="clear-all-btn">
                                <i class="fas fa-times me-1"></i>CLEAR ALL
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Settings Modal -->
    <div class="modal fade" id="bulkSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Availability Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Default Weekday Hours (Monday - Friday)</h6>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="weekday-start" value="09:00">
                            </div>
                            <div class="col-6">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" id="weekday-end" value="17:00">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="weekdays-enabled" checked>
                            <label class="form-check-label" for="weekdays-enabled">Enable weekdays</label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Default Weekend Hours (Saturday - Sunday)</h6>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="weekend-start" value="10:00">
                            </div>
                            <div class="col-6">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" id="weekend-end" value="15:00">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="weekends-enabled">
                            <label class="form-check-label" for="weekends-enabled">Enable weekends</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Timezone</h6>
                        <select class="form-select" id="user-timezone">
                            <option value="America/New_York">Eastern Time (ET)</option>
                            <option value="America/Chicago">Central Time (CT)</option>
                            <option value="America/Denver">Mountain Time (MT)</option>
                            <option value="America/Los_Angeles">Pacific Time (PT)</option>
                            <option value="Europe/London">London (GMT)</option>
                            <option value="Europe/Paris">Paris (CET)</option>
                            <option value="Asia/Tokyo">Tokyo (JST)</option>
                            <option value="Australia/Sydney">Sydney (AEST)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="apply-bulk-settings">Apply Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Slot Selection Modal -->
    <div class="modal fade" id="timeSlotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="timeSlotModalTitle">Set Availability for <span id="selected-date-display"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="day-enabled">
                            <label class="form-check-label" for="day-enabled">Available on this day</label>
                        </div>
                    </div>
                    
                    <div id="time-settings" style="display: none;">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="day-start-time" value="09:00">
                            </div>
                            <div class="col-6">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" id="day-end-time" value="17:00">
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Session Duration</label>
                            <select class="form-select" id="session-duration">
                                <option value="30">30 minutes</option>
                                <option value="60" selected>1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Available Time Slots</label>
                            <div class="time-slots-preview" id="time-slots-preview">
                                <!-- Time slots will be generated here -->
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Booking Preview:</strong> Users will be able to book sessions during these time slots. Each session will be <span id="duration-display">1 hour</span> long.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-day-availability">Save Availability</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Availability Management Styles */
.availability-interface {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.instructions {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #28a745;
}

.availability-calendar {
    margin-top: 1rem;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    max-width: 100%;
}

.day-header {
    text-align: center;
    font-weight: 600;
    color: white;
    background-color: #28a745;
    font-size: 0.85rem;
    padding: 0.75rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 4px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    font-size: 0.9rem;
    color: #6c757d;
    position: relative;
    min-height: 50px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
    background-color: #f8f9fa;
}

.calendar-day:hover {
    background-color: #e9ecef;
    color: #495057;
}

.calendar-day.other-month {
    color: #ccc;
    cursor: default;
    background-color: #f8f9fa;
}

.calendar-day.other-month:hover {
    background-color: #f8f9fa;
    color: #ccc;
}

.calendar-day.available {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
}

.calendar-day.available:hover {
    background-color: #218838;
    color: white;
}

.calendar-day.unavailable {
    background-color: #f8f9fa;
    color: #6c757d;
    border-color: #e9ecef;
}

.calendar-day.unavailable:hover {
    background-color: #e9ecef;
    color: #495057;
}

.day-number {
    font-weight: 600;
    font-size: 1rem;
}

.day-status {
    font-size: 0.7rem;
    font-weight: 500;
    margin-top: 0.25rem;
    padding: 0.125rem 0.25rem;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.day-status.available {
    background-color: #d4edda;
    color: #155724;
}

.day-status.unavailable {
    background-color: #f8d7da;
    color: #721c24;
}

.day-status.no-data {
    background-color: #e2e3e5;
    color: #6c757d;
}

/* Time Slots Panel */
.time-slots-panel {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    height: fit-content;
    min-height: 400px;
}

.time-slots-header {
    background: #28a745;
    color: white;
    padding: 1rem;
    border-radius: 12px 12px 0 0;
}

.time-slots-header h6 {
    margin: 0;
    font-weight: 600;
    font-size: 1rem;
}

.time-slots-content {
    padding: 1.5rem;
}

.time-slots-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 2rem 1rem;
}

.time-slots-placeholder i {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #dee2e6;
}

.time-slots-placeholder p {
    margin: 0;
    font-size: 0.9rem;
}

.time-slot-btn {
    display: block;
    width: 100%;
    background: white;
    border: 2px solid #007bff;
    color: #007bff;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.time-slot-btn:hover {
    background: #f8f9fa;
    border-color: #0056b3;
    color: #0056b3;
}

.time-slot-btn.selected {
    background: #6c757d;
    border-color: #6c757d;
    color: white;
}

.time-slot-btn.selected:hover {
    background: #5a6268;
    border-color: #5a6268;
    color: white;
}

.time-slots-preview {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 0.75rem;
    max-height: 200px;
    overflow-y: auto;
}

.time-slot {
    display: inline-block;
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    margin: 0.125rem;
    border-radius: 4px;
    font-size: 0.8rem;
    border: 1px solid #bbdefb;
}

/* Time Slots Grid */
.time-slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
}

.time-slot-item {
    background: #e8f5e8;
    border: 1px solid #28a745;
    border-radius: 6px;
    padding: 0.75rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.time-slot-item:hover {
    background: #d4edda;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.time-slot-item.booked {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
    cursor: not-allowed;
}

.time-slot-item.booked:hover {
    background: #f5c6cb;
    transform: none;
    box-shadow: none;
}

.time-slot-time {
    font-weight: 600;
    font-size: 0.9rem;
    color: #155724;
}

.time-slot-item.booked .time-slot-time {
    color: #721c24;
}

.time-slot-duration {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.time-slot-item.booked .time-slot-duration {
    color: #721c24;
}

.calendar-navigation {
    text-align: center;
}

/* Modal Styles */
.modal-body .form-label {
    font-weight: 600;
    color: #495057;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .calendar-day {
        min-height: 60px;
        padding: 0.25rem;
    }
    
    .day-number {
        font-size: 0.8rem;
    }
    
    .day-status {
        font-size: 0.6rem;
        padding: 0.1rem 0.2rem;
    }
    
    .calendar-header .day-header {
        padding: 0.75rem 0.25rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 576px) {
    .calendar-day {
        min-height: 50px;
        padding: 0.2rem;
    }
    
    .day-number {
        font-size: 0.75rem;
    }
    
    .day-status {
        font-size: 0.55rem;
    }
    
    .calendar-header .day-header {
        padding: 0.5rem 0.2rem;
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Monthly Calendar Management
let currentDate = new Date();
let selectedDate = null;
let availabilityRules = {};
let timeSlots = {};

// Initialize calendar immediately
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, rendering calendar immediately...');
  
  // Render calendar immediately - no dependencies
  renderCalendar();
  
  // Setup event listeners
  setupEventListeners();
  
  // Load other things in background
  setTimeout(() => {
    checkCalendarStatus();
    loadAvailabilityRules();
  }, 100);
});

function testCalendar() {
  console.log('Testing calendar...');
  renderCalendar();
}

function showFallbackCalendar() {
  const loadingElement = document.getElementById('calendar-loading');
  const fallbackElement = document.getElementById('fallback-calendar');
  
  if (loadingElement) {
    loadingElement.style.display = 'none';
  }
  if (fallbackElement) {
    fallbackElement.style.display = 'block';
  }
}


function renderCalendar() {
  console.log('Rendering calendar...');
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // Update month display
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'];
  const monthDisplay = document.getElementById('current-month-display');
  if (monthDisplay) {
    monthDisplay.textContent = `${monthNames[month]} ${year}`;
  }
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();
  
  const calendarGrid = document.getElementById('calendar-grid');
  if (!calendarGrid) {
    console.error('Calendar grid element not found!');
    return;
  }
  
  calendarGrid.innerHTML = '';
  
  // Add day headers (green background)
  const dayHeaders = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
  dayHeaders.forEach(day => {
    const header = document.createElement('div');
    header.className = 'day-header';
    header.textContent = day;
    calendarGrid.appendChild(header);
  });
  
  // Add empty cells for days before the first day of the month
  for (let i = 0; i < startingDayOfWeek; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.className = 'calendar-day other-month';
    calendarGrid.appendChild(emptyDay);
  }
  
  // Add days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    const date = new Date(year, month, day);
    const today = new Date();
    const isToday = date.toDateString() === today.toDateString();
    
    if (isToday) {
      dayElement.classList.add('today');
    }
    
    dayElement.innerHTML = `
      <div class="day-number">${day}</div>
      <div class="day-status no-data">Not set</div>
    `;
    
    dayElement.addEventListener('click', () => handleDayClick(date, dayElement));
    calendarGrid.appendChild(dayElement);
  }
  
  console.log(`Added ${daysInMonth} days to calendar grid`);
  
  // Update availability status for each day
  updateCalendarAvailability();
  console.log('Calendar rendered successfully');
}


function handleDayClick(date, dayElement) {
  selectedDate = date;
  const dateStr = dayElement.dataset.date;
  
  // Update time slots panel
  const timeSlotsTitle = document.getElementById('time-slots-title');
  const timeSlotsContent = document.getElementById('time-slots-content');
  
  if (timeSlotsTitle) {
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];
    timeSlotsTitle.textContent = `${dayNames[date.getDay()]}, ${monthNames[date.getMonth()]} ${date.getDate()}`;
  }
  
  // Generate time slots
  if (timeSlotsContent) {
    timeSlotsContent.innerHTML = '';
    const timeSlots = ['10:00am', '11:00am', '1:00pm', '2:30pm', '4:00pm'];
    
    timeSlots.forEach((time, index) => {
      const slot = document.createElement('button');
      slot.className = 'time-slot-btn';
      slot.textContent = time;
      slot.type = 'button';
      
      // Add click handler for individual time slots
      slot.addEventListener('click', () => {
        // Toggle selection of this specific time slot
        slot.classList.toggle('selected');
        
        // Update day availability based on selected slots
        const selectedSlots = timeSlotsContent.querySelectorAll('.time-slot-btn.selected');
        if (selectedSlots.length > 0) {
          dayElement.classList.remove('unavailable');
          dayElement.classList.add('available');
          // Update the day status
          const statusElement = dayElement.querySelector('.day-status');
          if (statusElement) {
            statusElement.textContent = 'Available';
            statusElement.className = 'day-status available';
          }
        } else {
          dayElement.classList.remove('available');
          dayElement.classList.add('unavailable');
          // Update the day status
          const statusElement = dayElement.querySelector('.day-status');
          if (statusElement) {
            statusElement.textContent = 'Not available';
            statusElement.className = 'day-status unavailable';
          }
        }
      });
      
      timeSlotsContent.appendChild(slot);
    });
  }
}

function loadTimeSlotsForDate(dateStr) {
  const timeSlotsList = document.getElementById('time-slots-list');
  timeSlotsList.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading time slots...</div>';
  
  fetch(`/api/availability/time-slots?date=${dateStr}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayTimeSlots(data.time_slots);
      } else {
        timeSlotsList.innerHTML = `<div class="text-danger text-center py-3">Error: ${data.error}</div>`;
      }
    })
    .catch(error => {
      console.error('Error loading time slots:', error);
      timeSlotsList.innerHTML = '<div class="text-danger text-center py-3">Error loading time slots</div>';
    });
}

function displayTimeSlots(slots) {
  const timeSlotsList = document.getElementById('time-slots-list');
  
  if (slots.length === 0) {
    timeSlotsList.innerHTML = '<div class="text-muted text-center py-3">No availability set for this day</div>';
    return;
  }
  
  timeSlotsList.innerHTML = '';
  slots.forEach(slot => {
    const slotElement = document.createElement('div');
    slotElement.className = `time-slot-item ${!slot.available ? 'booked' : ''}`;
    
    const startTime = new Date(`2000-01-01T${slot.start}`).toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    
    const endTime = new Date(`2000-01-01T${slot.end}`).toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    
    slotElement.innerHTML = `
      <div class="time-slot-time">${startTime} - ${endTime}</div>
      <div class="time-slot-duration">1 hour</div>
      ${!slot.available ? `<div class="text-danger small">${slot.blocked_reason || 'Blocked'}</div>` : ''}
    `;
    
    if (slot.available) {
      slotElement.addEventListener('click', () => {
        // Handle booking this time slot
        console.log('Booking slot:', slot);
        // You can add booking functionality here
      });
    }
    
    timeSlotsList.appendChild(slotElement);
  });
}

function generateTimeSlots(startTime, endTime, durationMinutes) {
  const slots = [];
  const start = new Date(`2000-01-01T${startTime}`);
  const end = new Date(`2000-01-01T${endTime}`);
  
  let current = new Date(start);
  while (current < end) {
    const timeStr = current.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true 
    });
    slots.push(timeStr);
    current.setMinutes(current.getMinutes() + durationMinutes);
  }
  
  return slots;
}

function updateCalendarAvailability() {
  document.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayElement => {
    const dateStr = dayElement.dataset.date;
    const date = new Date(dateStr);
    const weekday = date.getDay();
    
    const statusElement = dayElement.querySelector('.day-status');
    
    if (availabilityRules[weekday]) {
      dayElement.classList.add('available');
      dayElement.classList.remove('unavailable');
      statusElement.textContent = 'Available';
      statusElement.className = 'day-status available';
    } else {
      dayElement.classList.add('unavailable');
      dayElement.classList.remove('available');
      statusElement.textContent = 'Not available';
      statusElement.className = 'day-status unavailable';
    }
  });
}

function loadAvailabilityRules() {
  fetch('/api/availability/rules')
    .then(response => response.json())
    .then(data => {
      availabilityRules = {};
      data.forEach(rule => {
        availabilityRules[rule.weekday] = rule;
      });
      updateCalendarAvailability();
    })
    .catch(error => {
      console.error('Error loading availability rules:', error);
    });
}

function setupEventListeners() {
  // Month navigation
  document.getElementById('prev-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  });
  
  document.getElementById('next-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  });
  
  // Bulk settings
  document.getElementById('bulk-settings-btn').addEventListener('click', () => {
    new bootstrap.Modal(document.getElementById('bulkSettingsModal')).show();
  });
  
  // Quick actions
  const setWeekdaysBtn = document.getElementById('set-weekdays-btn');
  if (setWeekdaysBtn) {
    setWeekdaysBtn.addEventListener('click', () => {
      setBulkAvailability([1, 2, 3, 4, 5], '09:00', '17:00');
    });
  }
  
  const setWeekendsBtn = document.getElementById('set-weekends-btn');
  if (setWeekendsBtn) {
    setWeekendsBtn.addEventListener('click', () => {
      setBulkAvailability([0, 6], '10:00', '15:00');
    });
  }
  
  const clearAllBtn = document.getElementById('clear-all-btn');
  if (clearAllBtn) {
    clearAllBtn.addEventListener('click', () => {
      clearAllAvailability();
    });
  }
  
  // Apply bulk settings
  document.getElementById('apply-bulk-settings').addEventListener('click', () => {
    applyBulkSettings();
  });
  
  // Edit day availability
  document.getElementById('edit-day-availability').addEventListener('click', () => {
    if (selectedDate) {
      new bootstrap.Modal(document.getElementById('timeSlotModal')).show();
    }
  });
}

function setBulkAvailability(weekdays, startTime, endTime) {
  const rules = weekdays.map(weekday => ({
    weekday: weekday,
    start: startTime,
    end: endTime,
    enabled: true
  }));
  
  // Update local availability rules
  rules.forEach(rule => {
    availabilityRules[rule.weekday] = rule;
  });
  
  // Update calendar display
  updateCalendarAvailability();
  
  // Save to server
  saveAvailabilityRules(rules);
}

function clearAllAvailability() {
  // Clear local availability rules
  availabilityRules = {};
  
  // Update calendar display
  updateCalendarAvailability();
  
  // Save to server
  saveAvailabilityRules([]);
}

function applyBulkSettings() {
  const weekdayEnabled = document.getElementById('weekdays-enabled').checked;
  const weekendEnabled = document.getElementById('weekends-enabled').checked;
  const weekdayStart = document.getElementById('weekday-start').value;
  const weekdayEnd = document.getElementById('weekday-end').value;
  const weekendStart = document.getElementById('weekend-start').value;
  const weekendEnd = document.getElementById('weekend-end').value;
  
  const rules = [];
  
  if (weekdayEnabled) {
    for (let i = 1; i <= 5; i++) {
      rules.push({
        weekday: i,
        start: weekdayStart,
        end: weekdayEnd,
        enabled: true
      });
    }
  }
  
  if (weekendEnabled) {
    rules.push({
      weekday: 0,
      start: weekendStart,
      end: weekendEnd,
      enabled: true
    });
    rules.push({
      weekday: 6,
      start: weekendStart,
      end: weekendEnd,
      enabled: true
    });
  }
  
  saveAvailabilityRules(rules);
  bootstrap.Modal.getInstance(document.getElementById('bulkSettingsModal')).hide();
}

function saveAvailabilityRules(rules) {
  fetch('/api/availability/rules', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ rules: rules })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      loadAvailabilityRules();
      showNotification('Availability updated successfully!', 'success');
    } else {
      showNotification('Error updating availability: ' + data.error, 'error');
    }
  })
  .catch(error => {
    console.error('Error saving availability:', error);
    showNotification('Error saving availability', 'error');
  });
}

function checkCalendarStatus() {
  fetch('/api/availability/calendar-status')
    .then(response => response.json())
    .then(data => {
      const notConnectedDiv = document.getElementById('calendar-not-connected');
      const connectedDiv = document.getElementById('calendar-connected');
      const connectBtn = document.getElementById('connect-calendar-btn');
      const disconnectBtn = document.getElementById('disconnect-calendar-btn');
      
      if (data.connected) {
        notConnectedDiv.style.display = 'none';
        connectedDiv.style.display = 'block';
        connectBtn.style.display = 'none';
        disconnectBtn.style.display = 'inline-block';
      } else {
        notConnectedDiv.style.display = 'block';
        connectedDiv.style.display = 'none';
        connectBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error checking calendar status:', error);
    });
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
  notification.style.position = 'fixed';
  notification.style.top = '20px';
  notification.style.right = '20px';
  notification.style.zIndex = '9999';
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 5000);
}
</script>
{% endblock %}
