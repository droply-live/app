{% extends "base_signed_in.html" %}

{% block title %}Agent Dashboard - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .agent-dashboard {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        border-radius: 12px;
    }

    .dashboard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, {{ primary_color }}, #667eea);
        border-radius: 12px;
        color: white;
    }

    .dashboard-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }

    .system-status {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4ade80;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .dashboard-card {
        background: #2a2a2a;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #444;
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: white;
        margin: 0;
    }

    .card-icon {
        font-size: 24px;
    }

    .agent-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .agent-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #3a3a3a;
        border-radius: 8px;
        border: 1px solid #555;
    }

    .agent-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .agent-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
    }

    .agent-details h4 {
        margin: 0 0 4px 0;
        color: white;
        font-size: 14px;
    }

    .agent-details p {
        margin: 0;
        color: #888;
        font-size: 12px;
    }

    .agent-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-running {
        background: #10b981;
        color: white;
    }

    .status-busy {
        background: #f59e0b;
        color: white;
    }

    .status-error {
        background: #ef4444;
        color: white;
    }

    .status-idle {
        background: #6b7280;
        color: white;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .metric-item {
        text-align: center;
        padding: 15px;
        background: #3a3a3a;
        border-radius: 8px;
        border: 1px solid #555;
    }

    .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: {{ primary_color }};
        margin-bottom: 5px;
    }

    .metric-label {
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .capabilities-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
    }

    .capability-tag {
        padding: 4px 8px;
        background: #3a3a3a;
        color: #e0e0e0;
        border-radius: 12px;
        font-size: 11px;
        border: 1px solid #555;
    }

    .query-examples {
        background: #2a2a2a;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #444;
    }

    .query-examples h3 {
        color: white;
        margin: 0 0 15px 0;
        font-size: 18px;
    }

    .query-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .query-item {
        padding: 12px;
        background: #3a3a3a;
        border-radius: 8px;
        border: 1px solid #555;
        cursor: pointer;
        transition: all 0.2s;
    }

    .query-item:hover {
        background: {{ primary_color }};
        border-color: {{ primary_color }};
    }

    .query-item .query-text {
        color: #e0e0e0;
        margin: 0;
        font-size: 14px;
    }

    .query-item:hover .query-text {
        color: white;
    }

    .refresh-button {
        padding: 8px 16px;
        background: {{ primary_color }};
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .refresh-button:hover {
        background: #5a6fd8;
    }

    .error-message {
        background: #dc2626;
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        
        .dashboard-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="agent-dashboard">
    <div class="dashboard-header">
        <div>
            <h1>ü§ñ {{ app_name }} Agent Dashboard</h1>
            <div class="system-status">
                <span class="status-indicator"></span>
                <span>AI System Online</span>
            </div>
        </div>
        <button class="refresh-button" onclick="refreshDashboard()">Refresh</button>
    </div>

    <div class="dashboard-grid">
        <!-- Agents Status Card -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">ü§ñ Active Agents</h3>
                <span class="card-icon">‚ö°</span>
            </div>
            <div class="agent-list" id="agentList">
                <!-- Agents will be loaded here -->
            </div>
        </div>

        <!-- System Metrics Card -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">üìä System Metrics</h3>
                <span class="card-icon">üìà</span>
            </div>
            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be loaded here -->
            </div>
        </div>

        <!-- Query Examples Card -->
        <div class="query-examples">
            <h3>üí¨ Try These Queries</h3>
            <div class="query-list">
                <div class="query-item" onclick="sendQuery('Show me suppliers who quoted this month but didn\'t win any RFQs')">
                    <p class="query-text">üìä "Show me suppliers who quoted this month but didn't win any RFQs"</p>
                </div>
                <div class="query-item" onclick="sendQuery('Find open POs with overdue delivery by more than 5 days')">
                    <p class="query-text">üì¶ "Find open POs with overdue delivery by more than 5 days"</p>
                </div>
                <div class="query-item" onclick="sendQuery('Show me all expiring contracts in the next 30 days')">
                    <p class="query-text">üìã "Show me all expiring contracts in the next 30 days"</p>
                </div>
                <div class="query-item" onclick="sendQuery('Which suppliers have the best performance ratings?')">
                    <p class="query-text">‚≠ê "Which suppliers have the best performance ratings?"</p>
                </div>
                <div class="query-item" onclick="sendQuery('What are the current order delays?')">
                    <p class="query-text">‚è∞ "What are the current order delays?"</p>
                </div>
                <div class="query-item" onclick="sendQuery('Analyze recent RFQ responses and recommend the best supplier')">
                    <p class="query-text">üí∞ "Analyze recent RFQ responses and recommend the best supplier"</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let systemStatus = null;

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    function loadDashboardData() {
        // Load system status
        fetch('/agents/status')
            .then(response => response.json())
            .then(data => {
                systemStatus = data;
                updateDashboard(data);
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            });
    }

    function updateDashboard(data) {
        updateAgentList(data);
        updateMetrics(data);
    }

    function updateAgentList(data) {
        const agentList = document.getElementById('agentList');
        const agentManagerStatus = data.agent_manager_status || {};
        
        const agents = [
            { id: 'rfq_agent', name: 'RFQ Agent', icon: 'üìã', description: 'Autonomous Sourcing Assistant' },
            { id: 'order_agent', name: 'Order Agent', icon: 'üì¶', description: 'Follow-Up & Delay Tracker' },
            { id: 'supplier_agent', name: 'Supplier Agent', icon: 'üè≠', description: 'Supplier Intelligence Analyst' },
            { id: 'contract_agent', name: 'Contract Agent', icon: 'üìÑ', description: 'Contract Guardian' }
        ];

        agentList.innerHTML = agents.map(agent => {
            const status = agentManagerStatus[agent.id] || 'unknown';
            const statusClass = getStatusClass(status);
            const statusText = getStatusText(status);
            
            return `
                <div class="agent-item">
                    <div class="agent-info">
                        <div class="agent-avatar" style="background: ${getAgentColor(agent.id)}">
                            ${agent.icon}
                        </div>
                        <div class="agent-details">
                            <h4>${agent.name}</h4>
                            <p>${agent.description}</p>
                        </div>
                    </div>
                    <div class="agent-status ${statusClass}">
                        ${statusText}
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateMetrics(data) {
        const metricsGrid = document.getElementById('metricsGrid');
        const agentManagerStatus = data.agent_manager_status || {};
        
        const metrics = [
            { label: 'Total Agents', value: agentManagerStatus.total_agents || 0 },
            { label: 'Running', value: agentManagerStatus.running_agents || 0 },
            { label: 'Busy', value: agentManagerStatus.busy_agents || 0 },
            { label: 'Queued Tasks', value: agentManagerStatus.queued_tasks || 0 },
            { label: 'Worker Threads', value: agentManagerStatus.worker_threads || 0 },
            { label: 'Contexts', value: agentManagerStatus.context_summary?.total_contexts || 0 }
        ];

        metricsGrid.innerHTML = metrics.map(metric => `
            <div class="metric-item">
                <div class="metric-value">${metric.value}</div>
                <div class="metric-label">${metric.label}</div>
            </div>
        `).join('');
    }

    function getStatusClass(status) {
        switch(status) {
            case 'running': return 'status-running';
            case 'busy': return 'status-busy';
            case 'error': return 'status-error';
            default: return 'status-idle';
        }
    }

    function getStatusText(status) {
        switch(status) {
            case 'running': return 'Running';
            case 'busy': return 'Busy';
            case 'error': return 'Error';
            default: return 'Idle';
        }
    }

    function getAgentColor(agentId) {
        const colors = {
            'rfq_agent': '#10b981',
            'order_agent': '#f59e0b',
            'supplier_agent': '#3b82f6',
            'contract_agent': '#8b5cf6'
        };
        return colors[agentId] || '#6b7280';
    }

    function sendQuery(query) {
        // Redirect to chat interface with pre-filled query
        window.location.href = `/agents/chat?query=${encodeURIComponent(query)}`;
    }

    function refreshDashboard() {
        loadDashboardData();
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        document.querySelector('.agent-dashboard').insertBefore(errorDiv, document.querySelector('.dashboard-grid'));
    }

    // Auto-refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
</script>
{% endblock %}








