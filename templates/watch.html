{% extends "base_signed_in.html" %}

{% block title %}Watch - Droply{% endblock %}

{% block body_class %}watch-page{% endblock %}

{% block content %}
<style>
  /* Watch Page Specific Styles */
  .watch-page .main-content {
    margin-left: 280px !important;
    width: calc(100vw - 280px) !important;
    height: 100vh !important;
    padding: 0 !important;
    background: #000 !important;
    position: fixed !important;
    top: 0 !important;
    right: 0 !important;
    z-index: 100 !important;
  }

  .watch-page .sidebar {
    z-index: 1001 !important;
  }

  .watch-container {
    height: 100vh;
    width: 100%;
    position: relative;
    background: #000;
    overflow: hidden;
  }

  .watch-feed {
    height: 100vh;
    overflow-y: auto;
    scroll-snap-type: y mandatory;
    scroll-behavior: smooth;
  }

  .watch-item {
    height: 100vh;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    scroll-snap-align: start;
    position: relative;
    background: #000;
  }

  .video-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }

  .video-player {
    width: 100%;
    height: 100%;
    object-fit: contain; /* This ensures the video is not cropped or compressed */
    background: #000;
  }

  /* For landscape videos, they should cover most of the area */
  .video-player.landscape {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }

  /* For portrait videos (phone), center them with black bars on sides */
  .video-player.portrait {
    object-fit: contain;
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: 100%;
  }

  /* TikTok/Reels Style Layout */
  .video-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    padding: 0;
    z-index: 10;
    pointer-events: none;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  .video-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 20px;
    height: 100%;
    pointer-events: auto;
  }

  .video-info {
    flex: 1;
    max-width: calc(100% - 100px);
    margin-right: 20px;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .author-info:hover {
    transform: scale(1.02);
  }

  .author-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #fff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  }

  .author-details {
    flex: 1;
  }

  .author-name {
    font-size: 18px;
    font-weight: 700;
    color: white;
    margin-bottom: 4px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .author-title {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 8px;
  }

  .follow-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .follow-btn:hover {
    background: #ff3742;
    transform: scale(1.05);
  }

  .follow-btn.following {
    background: rgba(255, 255, 255, 0.2);
    color: white;
  }

  .video-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    line-height: 1.3;
    color: white;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .video-description {
    font-size: 14px;
    color: #ddd;
    margin-bottom: 12px;
    line-height: 1.4;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .video-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 4px;
    color: #ccc;
    font-size: 13px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .stat i {
    font-size: 14px;
  }

  /* Right Side Action Buttons (TikTok Style) */
  .video-actions {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
    z-index: 10;
  }

  .action-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    position: relative;
  }

  .action-button:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.1);
  }

  .action-button i {
    font-size: 24px;
    color: white;
    margin-bottom: 2px;
  }

  .action-button .action-label {
    font-size: 10px;
    color: white;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .action-button.liked {
    background: #ff4757;
    border-color: #ff4757;
  }

  .action-button.liked i {
    color: white;
  }

  /* Primary Action Button (Book Now) */
  .action-button.primary {
    background: #10b981;
    border-color: #10b981;
    width: 70px;
    height: 70px;
  }

  .action-button.primary:hover {
    background: #059669;
    border-color: #059669;
  }

  .action-button.primary i {
    font-size: 28px;
  }

  .action-button.primary .action-label {
    font-size: 11px;
    font-weight: 700;
  }


  /* Hide scrollbar */
  .watch-feed::-webkit-scrollbar {
    display: none;
  }

  .watch-feed {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .video-content {
      padding: 15px;
    }

    .video-info {
      max-width: calc(100% - 80px);
      margin-right: 15px;
    }

    .author-avatar {
      width: 45px;
      height: 45px;
    }

    .author-name {
      font-size: 16px;
    }

    .video-title {
      font-size: 15px;
    }

    .video-description {
      font-size: 13px;
    }

    .action-button {
      width: 50px;
      height: 50px;
    }

    .action-button.primary {
      width: 60px;
      height: 60px;
    }

    .action-button i {
      font-size: 20px;
    }

    .action-button.primary i {
      font-size: 24px;
    }

    .action-button .action-label {
      font-size: 9px;
    }

  }

  /* Video loading state */
  .video-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 18px;
  }

  .video-loading i {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Ensure proper video aspect ratio handling */
  .video-player {
    max-width: 100%;
    max-height: 100%;
  }

  /* Mobile responsive - full width when sidebar is hidden */
  @media (max-width: 768px) {
    .watch-page .main-content {
      margin-left: 0 !important;
      width: 100vw !important;
      left: 0 !important;
      right: auto !important;
    }

    .watch-container {
      width: 100vw;
    }

    .watch-item {
      width: 100vw;
    }

    .video-player.landscape {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }

    .video-player.portrait {
      width: auto;
      height: 100vh;
      max-width: 100vw;
      object-fit: contain;
    }
  }

  /* Desktop - account for sidebar width */
  @media (min-width: 769px) {
    .video-player.landscape {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-player.portrait {
      width: auto;
      height: 100%;
      max-width: 100%;
      object-fit: contain;
    }
  }
</style>

<!-- Watch Container -->
<div class="watch-container">
  <div class="watch-feed" id="watchFeed">
    {% for video in videos %}
    <div class="watch-item" data-video-id="{{ video.id }}">
      <div class="video-container">
        <video class="video-player" preload="metadata" poster="{{ video.thumbnail }}" muted>
          <source src="{{ video.video_url }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        
        <div class="video-overlay">
          <div class="video-content">
            <!-- Left side - Video info and author -->
            <div class="video-info">
              <div class="author-info" onclick="viewProfile('{{ video.author }}')">
                <img src="{{ video.author_avatar }}" alt="{{ video.author }}" class="author-avatar">
                <div class="author-details">
                  <div class="author-name">{{ video.author }}</div>
                  <div class="author-title">Expert</div>
                  <button class="follow-btn" onclick="toggleFollow('{{ video.author }}', event)">Follow</button>
                </div>
              </div>
              
              <h2 class="video-title">{{ video.title }}</h2>
              <p class="video-description">{{ video.description }}</p>
              
              <div class="video-stats">
                <div class="stat">
                  <i class="fas fa-eye"></i>
                  <span>{{ video.views }}</span>
                </div>
                <div class="stat">
                  <i class="fas fa-clock"></i>
                  <span>{{ video.duration }}</span>
                </div>
              </div>
            </div>
            
            <!-- Right side - Action buttons -->
            <div class="video-actions">
              <button class="action-button primary" onclick="bookExpert('{{ video.author }}')" title="Book Now">
                <i class="fas fa-calendar-plus"></i>
                <span class="action-label">Book</span>
              </button>
              <button class="action-button" onclick="toggleLike({{ video.id }})" title="Like">
                <i class="fas fa-heart"></i>
                <span class="action-label">Like</span>
              </button>
              <button class="action-button" onclick="shareVideo({{ video.id }})" title="Share">
                <i class="fas fa-share"></i>
                <span class="action-label">Share</span>
              </button>
              <button class="action-button" onclick="messageExpert('{{ video.author }}')" title="Message">
                <i class="fas fa-comment"></i>
                <span class="action-label">Message</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</div>

<script>
  let currentIndex = 0;
  let autoScrollInterval;
  const totalVideos = {{ videos|length }};
  let currentVideo = null;

  // Initialize
  updateScrollIndicator();
  startAutoScroll();
  setupVideoPlayers();

  // Setup video players with proper aspect ratio detection
  function setupVideoPlayers() {
    const videos = document.querySelectorAll('.video-player');
    videos.forEach((video, index) => {
      video.addEventListener('loadedmetadata', () => {
        console.log(`Video ${index + 1} loaded`);
        detectVideoOrientation(video);
      });
      
      video.addEventListener('error', (e) => {
        console.error(`Video ${index + 1} failed to load:`, e);
      });
    });
  }

  // Detect if video is landscape or portrait and apply appropriate styling
  function detectVideoOrientation(video) {
    const aspectRatio = video.videoWidth / video.videoHeight;
    
    // Remove existing orientation classes
    video.classList.remove('landscape', 'portrait');
    
    if (aspectRatio > 1) {
      // Landscape video
      video.classList.add('landscape');
    } else {
      // Portrait video
      video.classList.add('portrait');
    }
  }

  // Auto scroll functionality
  function startAutoScroll() {
    if (autoScrollInterval) clearInterval(autoScrollInterval);
    autoScrollInterval = setInterval(() => {
      const nextIndex = currentIndex < totalVideos - 1 ? currentIndex + 1 : 0;
      scrollToVideo(nextIndex);
    }, 8000); // Auto scroll every 8 seconds
  }


  // Scroll functions
  function scrollToVideo(index) {
    currentIndex = index;
    const item = document.querySelector(`[data-video-id="${index + 1}"]`);
    if (item) {
      item.scrollIntoView({ behavior: 'smooth' });
      updateScrollIndicator();
      playCurrentVideo();
    }
  }


  function updateScrollIndicator() {
    const dots = document.querySelectorAll('.scroll-dot');
    dots.forEach((dot, index) => {
      dot.classList.toggle('active', index === currentIndex);
    });
  }

  // Video control functions
  function playCurrentVideo() {
    // Pause all videos
    const allVideos = document.querySelectorAll('.video-player');
    allVideos.forEach(video => {
      video.pause();
    });
    
    // Play current video
    const currentVideoElement = document.querySelector(`[data-video-id="${currentIndex + 1}"] .video-player`);
    if (currentVideoElement) {
      currentVideo = currentVideoElement;
      currentVideo.play().catch(e => {
        console.log('Autoplay prevented:', e);
      });
    }
  }

  function pauseCurrentVideo() {
    if (currentVideo) {
      currentVideo.pause();
    }
  }

  // Handle scroll events
  const feed = document.getElementById('watchFeed');
  feed.addEventListener('scroll', () => {
    const scrollTop = feed.scrollTop;
    const itemHeight = window.innerHeight;
    const newIndex = Math.round(scrollTop / itemHeight);
    
    if (newIndex !== currentIndex && newIndex >= 0 && newIndex < totalVideos) {
      currentIndex = newIndex;
      updateScrollIndicator();
      playCurrentVideo();
    }
  });


  // Touch/swipe support for mobile
  let startY = 0;
  let endY = 0;

  feed.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
  });

  feed.addEventListener('touchend', (e) => {
    endY = e.changedTouches[0].clientY;
    const diff = startY - endY;
    
    if (Math.abs(diff) > 50) { // Minimum swipe distance
      if (diff > 0) {
        // Scroll down - let the natural scroll behavior handle this
        const currentScroll = feed.scrollTop;
        const itemHeight = window.innerHeight;
        const nextIndex = Math.min(currentIndex + 1, totalVideos - 1);
        feed.scrollTo({ top: nextIndex * itemHeight, behavior: 'smooth' });
      } else {
        // Scroll up - let the natural scroll behavior handle this
        const currentScroll = feed.scrollTop;
        const itemHeight = window.innerHeight;
        const prevIndex = Math.max(currentIndex - 1, 0);
        feed.scrollTo({ top: prevIndex * itemHeight, behavior: 'smooth' });
      }
    }
  });

  // Enhanced Video Interaction Functions
  function toggleLike(videoId) {
    const button = document.querySelector(`[data-video-id="${videoId}"] .action-button`);
    button.classList.toggle('liked');
    
    // Add animation effect
    if (button.classList.contains('liked')) {
      button.style.transform = 'scale(1.2)';
      setTimeout(() => {
        button.style.transform = 'scale(1)';
      }, 200);
    }
    
    // Here you would typically send a request to the server
    console.log(`Liked video ${videoId}`);
  }

  function shareVideo(videoId) {
    if (navigator.share) {
      navigator.share({
        title: 'Check out this video on Droply',
        url: window.location.href
      });
    } else {
      // Fallback to copying URL
      navigator.clipboard.writeText(window.location.href);
      showNotification('Link copied to clipboard!');
    }
  }

  function bookExpert(authorName) {
    // Redirect to booking page with author name
    window.location.href = `/search?expert=${encodeURIComponent(authorName)}`;
  }

  function messageExpert(authorName) {
    // Redirect to messaging with the expert
    window.location.href = `/messages?expert=${encodeURIComponent(authorName)}`;
  }

  function viewProfile(authorName) {
    // Redirect to expert's profile page
    window.location.href = `/profile/${encodeURIComponent(authorName)}`;
  }

  function toggleFollow(authorName, event) {
    event.stopPropagation(); // Prevent profile click
    const button = event.target;
    const isFollowing = button.classList.contains('following');
    
    if (isFollowing) {
      button.classList.remove('following');
      button.textContent = 'Follow';
      showNotification(`Unfollowed ${authorName}`);
    } else {
      button.classList.add('following');
      button.textContent = 'Following';
      showNotification(`Following ${authorName}`);
    }
    
    // Here you would typically send a request to the server
    console.log(`${isFollowing ? 'Unfollowed' : 'Following'} ${authorName}`);
  }

  function showNotification(message) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Pause auto-scroll when user is interacting
  feed.addEventListener('mouseenter', () => {
    clearInterval(autoScrollInterval);
  });

  feed.addEventListener('mouseleave', () => {
    startAutoScroll();
  });

  // Handle visibility change (pause when tab is not active)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      clearInterval(autoScrollInterval);
      pauseCurrentVideo();
    } else {
      startAutoScroll();
      playCurrentVideo();
    }
  });

  // Initialize first video
  setTimeout(() => {
    playCurrentVideo();
  }, 500);
</script>
{% endblock %}