{% extends "base_signed_in.html" %}

{% block title %}Book {{ expert.full_name }} - Droply{% endblock %}

{% block content %}
<!-- Calendar Booking Page -->
<div class="calendar-booking-page">
  <!-- Breadcrumbs -->
  <div class="breadcrumbs">
    <div class="breadcrumb-container">
      <a href="{{ url_for('dashboard') }}" class="breadcrumb-link">Droply</a>
      <span class="breadcrumb-separator">/</span>
      <a href="{{ url_for('search') }}" class="breadcrumb-link">User Marketplace</a>
      <span class="breadcrumb-separator">/</span>
      <a href="{{ url_for('user_profile', username=expert.username) }}" class="breadcrumb-link">{{ expert.full_name }}</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current">Book Session</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="booking-layout">
      <!-- Left Column - Calendar -->
      <div class="calendar-section">
        <div class="calendar-container">
          <!-- Calendar Navigation -->
          <div class="calendar-nav">
            <button class="nav-btn prev-month" onclick="changeMonth(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="current-month" id="currentMonth">September 2025</h3>
            <button class="nav-btn next-month" onclick="changeMonth(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <!-- Calendar Grid -->
          <div class="booking-calendar-grid">
            <!-- Day of week headers -->
            <div class="booking-calendar-headers">
              <div class="booking-day-header">Sun</div>
              <div class="booking-day-header">Mon</div>
              <div class="booking-day-header">Tue</div>
              <div class="booking-day-header">Wed</div>
              <div class="booking-day-header">Thu</div>
              <div class="booking-day-header">Fri</div>
              <div class="booking-day-header">Sat</div>
            </div>
            <div class="booking-calendar-days" id="calendarDays">
              <!-- Calendar days will be populated by JavaScript -->
            </div>
          </div>

          <!-- Time Zone Information -->
          <div class="timezone-section">
            <div class="timezone-info">
              <i class="fas fa-clock"></i>
              <span>Times shown in <strong>{{ user_timezone or 'America/Toronto' }}</strong></span>
            </div>
            <div class="timezone-note">
              <small>You can change your timezone and availability in your <a href="{{ url_for('availability') }}">availability settings</a></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Time Slots -->
      <div class="times-section">
        <div class="times-container">
          <h3 class="selected-date" id="selectedDate">Select a date to see available times</h3>
          
          {% if has_availability %}
            <!-- Book Now Button for Immediate Meeting - Only show in development -->
            {% if expert.is_available and (config.get('FLASK_ENV') == 'development' or config.get('ENVIRONMENT') == 'development') %}
            <div class="book-now-section">
              <a href="{{ url_for('book_immediate_meeting', username=expert.username) }}" 
                 class="book-now-btn">
                <div class="book-now-icon">
                  <i class="fas fa-bolt"></i>
                </div>
                <div class="book-now-content">
                  <div class="book-now-title">Book Now (Dev Only)</div>
                  <div class="book-now-subtitle">Start meeting in 5 minutes â€¢ Payment required</div>
                </div>
              </a>
            </div>
            {% endif %}
            
            <div class="time-slots" id="timeSlots">
              <div class="no-date-selected">
                <div class="no-date-icon">
                  <i class="fas fa-calendar-day"></i>
                </div>
                <p>Choose a date from the calendar to see available times</p>
              </div>
            </div>
          {% else %}
            <div class="no-availability">
              <div class="no-availability-icon">
                <i class="fas fa-calendar-plus"></i>
              </div>
              <h3>No availability set</h3>
              <p>This expert hasn't set up their availability yet. They need to configure their calendar before you can book a session.</p>
              <a href="{{ url_for('user_profile', username=expert.username) }}" class="btn-secondary">
                Back to Profile
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden data for JavaScript -->
<script>
  window.availableTimes = {{ available_times | tojson }};
  window.expertUsername = "{{ expert.username }}";
  window.expertName = "{{ expert.full_name }}";
</script>

<style>
/* Calendar Booking Page Styles */
.calendar-booking-page {
  min-height: 100vh;
  background: #f8f9fa;
}

/* Breadcrumbs */
.breadcrumbs {
  background: white;
  border-bottom: 1px solid #e5e5e5;
  padding: 1rem 0;
}

.breadcrumb-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
}

.breadcrumb-link {
  color: #666;
  text-decoration: none;
}

.breadcrumb-link:hover {
  color: #059669;
  text-decoration: none;
}

.breadcrumb-separator {
  color: #ccc;
}

.breadcrumb-current {
  color: #1a1a1a;
  font-weight: 500;
}

/* Main Content */
.main-content {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

.booking-layout {
  display: grid;
  grid-template-columns: 1.5fr 2fr;
  gap: 2rem;
  align-items: start;
}

/* Calendar Section */
.calendar-section {
  background: white;
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.calendar-container {
  max-width: 100%;
}

/* Calendar Navigation */
.calendar-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
}

.nav-btn {
  background: #f8f9fa;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #666;
}

.nav-btn:hover {
  background: #059669;
  border-color: #059669;
  color: white;
}

.current-month {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0;
}

/* Calendar Grid */
.booking-calendar-grid {
  margin-bottom: 2rem;
  min-height: 400px;
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  overflow: hidden;
}

/* Day headers */
.booking-calendar-headers {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0;
  padding: 0;
  margin-bottom: 0;
}

.booking-day-header {
  text-align: center;
  font-size: 0.875rem;
  font-weight: 600;
  color: #666;
  padding: 0.75rem 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background-color: #f8f9fa;
  border-bottom: 1px solid #e5e5e5;
  border-right: 1px solid #e5e5e5;
}

.booking-day-header:last-child {
  border-right: none;
}

.booking-calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0;
  padding: 0;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 0;
  font-size: 1rem;
  font-weight: 500;
  transition: all 0.2s ease;
  position: relative;
  min-height: 50px;
  border-right: 1px solid #e5e5e5;
  border-bottom: 1px solid #e5e5e5;
}

.calendar-day:nth-child(7n) {
  border-right: none;
}

.calendar-day:hover {
  background: #f0fdf4;
  color: #059669;
}

.calendar-day.other-month {
  color: #ccc;
  cursor: default;
}

.calendar-day.other-month:hover {
  background: transparent;
  color: #ccc;
}

.calendar-day.past {
  color: #ccc;
  cursor: not-allowed;
  background: #f8f9fa;
}

.calendar-day.past:hover {
  background: #f8f9fa;
  color: #ccc;
}

.calendar-day.available {
  color: #1a1a1a;
  background: #f8f9fa;
}

.calendar-day.available:hover {
  background: #e0f2fe;
  color: #059669;
}

.calendar-day.selected {
  background: #059669;
  color: white;
}

.calendar-day.selected:hover {
  background: #047857;
}

.calendar-day.today {
  border: 2px solid #059669;
}

.calendar-day.today.selected {
  border-color: white;
}

/* Time Zone Section */
.timezone-section {
  border-top: 1px solid #e5e5e5;
  padding-top: 1.5rem;
}

.timezone-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  color: #666;
}

.timezone-note {
  color: #888;
}

.timezone-note a {
  color: #059669;
  text-decoration: none;
}

.timezone-note a:hover {
  text-decoration: underline;
}

/* Times Section */
.times-section {
  background: white;
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  min-height: 500px;
}

/* Book Now Section */
.book-now-section {
  margin-bottom: 2rem;
}

.book-now-btn {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  color: white;
  border: none;
  border-radius: 12px;
  text-decoration: none;
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
}

.book-now-btn:hover {
  background: linear-gradient(135deg, #047857 0%, #065f46 100%);
  color: white;
  text-decoration: none;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
}

.book-now-icon {
  font-size: 1.5rem;
  color: #fbbf24;
}

.book-now-content {
  flex: 1;
}

.book-now-title {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.book-now-subtitle {
  font-size: 0.875rem;
  opacity: 0.9;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0 0 2rem 0;
}

.selected-date {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1a1a1a;
  margin: 0 0 1.5rem 0;
}

.time-slots {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.time-slot {
  display: block;
  padding: 1rem;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  text-align: center;
  background: white;
  width: 100%;
  cursor: pointer;
}

.time-slot:hover {
  border-color: #059669;
  background: #f0fdf4;
  color: inherit;
  text-decoration: none;
}

.time-slot.selected {
  background: #059669;
  border-color: #059669;
  color: white;
}

.time-slot.selected:hover {
  background: #047857;
  border-color: #047857;
}

.time-time {
  font-size: 1rem;
  font-weight: 600;
  color: inherit;
}

.time-slot-container {
  display: flex;
  width: 100%;
  transition: all 0.2s ease;
}

.time-slot-container.selected .time-slot {
  background: #f8f9fa;
  border-color: #e5e5e5;
  color: #333;
  cursor: default;
  pointer-events: none;
  border-right: 1px solid #e5e5e5;
}

.time-slot-container.selected .time-slot:hover {
  background: #f8f9fa;
  border-color: #e5e5e5;
}

.confirm-btn {
  padding: 1rem 1.5rem;
  background: #059669;
  color: white;
  border: 1px solid #059669;
  border-radius: 0 8px 8px 0;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  flex: 1;
  min-width: 80px;
}

.confirm-btn:hover {
  background: #047857;
  border-color: #047857;
}

.no-date-selected {
  text-align: center;
  padding: 2rem;
  color: #666;
}

.no-date-icon {
  font-size: 3rem;
  color: #ccc;
  margin-bottom: 1rem;
}

/* No Times State */
.no-times {
  text-align: center;
  padding: 3rem 2rem;
}

.no-times-icon {
  font-size: 4rem;
  color: #ccc;
  margin-bottom: 1rem;
}

.no-times h3 {
  color: #1a1a1a;
  margin-bottom: 0.5rem;
}

.no-times p {
  color: #666;
  margin-bottom: 2rem;
}

/* No Availability State */
.no-availability {
  text-align: center;
  padding: 3rem 2rem;
}

.no-availability-icon {
  font-size: 4rem;
  color: #059669;
  margin-bottom: 1rem;
}

.no-availability h3 {
  color: #1a1a1a;
  margin-bottom: 0.5rem;
}

.no-availability p {
  color: #666;
  margin-bottom: 2rem;
}

.btn-secondary {
  padding: 0.75rem 1.5rem;
  background: #6b7280;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  display: inline-block;
}

.btn-secondary:hover {
  background: #4b5563;
  color: white;
  text-decoration: none;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .booking-layout {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
  
  .calendar-grid {
    min-height: 350px;
  }
  
  .times-section {
    min-height: 400px;
  }
}

@media (max-width: 768px) {
  .main-content {
    padding: 1rem;
  }
  
  .breadcrumb-container {
    padding: 0 1rem;
  }
  
  .calendar-section,
  .times-section {
    padding: 1.5rem;
  }
  
  .calendar-day {
    font-size: 0.9rem;
    min-height: 40px;
  }
  
  .booking-calendar-days {
    gap: 0;
    padding: 0;
  }
  
  .booking-calendar-headers {
    gap: 0;
    padding: 0;
    margin-bottom: 0;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
  }
  
  .booking-day-header {
    font-size: 0.75rem;
    padding: 0.25rem 0;
  }
}

@media (max-width: 480px) {
  .calendar-nav {
    margin-bottom: 1rem;
  }
  
  .current-month {
    font-size: 1rem;
  }
  
  .nav-btn {
    width: 35px;
    height: 35px;
  }
  
  .calendar-day {
    font-size: 0.8rem;
    min-height: 35px;
  }
}
</style>

<script>
// Calendar functionality
let currentDate = new Date();
let selectedDate = null;
let availableTimesData = window.availableTimes || [];

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
  renderCalendar();
  updateTimeSlots();
});

// Change month
function changeMonth(direction) {
  currentDate.setMonth(currentDate.getMonth() + direction);
  renderCalendar();
}

// Render calendar
function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // Update month display
  const monthNames = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();
  
  // Clear calendar
  const calendarDays = document.getElementById('calendarDays');
  calendarDays.innerHTML = '';
  
  // Add empty cells for days before the first day of the month
  for (let i = 0; i < startingDayOfWeek; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.className = 'calendar-day other-month';
    const prevMonth = new Date(year, month, -startingDayOfWeek + i + 1);
    emptyDay.textContent = prevMonth.getDate();
    calendarDays.appendChild(emptyDay);
  }
  
  // Add days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;
    
    const date = new Date(year, month, day);
    const dateString = formatDateForComparison(date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Check if this date is in the past
    const isPast = date < today;
    
    if (isPast) {
      dayElement.classList.add('past');
    } else {
      // Check if this date has available times
      const hasAvailableTimes = availableTimesData.some(time => {
        const timeDate = new Date(time.datetime);
        return timeDate.toISOString().split('T')[0] === dateString;
      });
      
      if (hasAvailableTimes) {
        dayElement.classList.add('available');
      }
      
      // Add click event only for non-past dates
      dayElement.addEventListener('click', function() {
        if (hasAvailableTimes) {
          selectDate(date, dayElement);
        }
      });
    }
    
    // Check if it's today
    if (date.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }
    
    calendarDays.appendChild(dayElement);
  }
  
  // Add empty cells for days after the last day of the month
  const totalCells = calendarDays.children.length;
  const remainingCells = 42 - totalCells; // 6 rows Ã— 7 days
  for (let i = 0; i < remainingCells; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.className = 'calendar-day other-month';
    const nextMonth = new Date(year, month + 1, i + 1);
    emptyDay.textContent = nextMonth.getDate();
    calendarDays.appendChild(emptyDay);
  }
}

// Select date
function selectDate(date, element) {
  // Remove previous selection
  const previousSelected = document.querySelector('.calendar-day.selected');
  if (previousSelected) {
    previousSelected.classList.remove('selected');
  }
  
  // Add selection to clicked date
  element.classList.add('selected');
  selectedDate = date;
  
  // Update time slots
  updateTimeSlots();
}

// Update time slots for selected date
function updateTimeSlots() {
  const timeSlotsContainer = document.getElementById('timeSlots');
  const selectedDateElement = document.getElementById('selectedDate');
  
  if (!selectedDate) {
    selectedDateElement.textContent = 'Select a date to see available times';
    timeSlotsContainer.innerHTML = `
      <div class="no-date-selected">
        <div class="no-date-icon">
          <i class="fas fa-calendar-day"></i>
        </div>
        <p>Choose a date from the calendar to see available times</p>
      </div>
    `;
    return;
  }
  
  const dateString = formatDateForComparison(selectedDate);
  const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
  const monthName = selectedDate.toLocaleDateString('en-US', { month: 'long' });
  const day = selectedDate.getDate();
  
  selectedDateElement.textContent = `${dayName}, ${monthName} ${day}`;
  
  // Find available times for this date
  const timesForDate = availableTimesData.filter(time => {
    const timeDate = new Date(time.datetime);
    return timeDate.toISOString().split('T')[0] === dateString;
  });
  
  if (timesForDate.length === 0) {
    timeSlotsContainer.innerHTML = `
      <div class="no-date-selected">
        <div class="no-date-icon">
          <i class="fas fa-calendar-times"></i>
        </div>
        <p>No available times for this date</p>
      </div>
    `;
    return;
  }
  
  // Create time slots
  timeSlotsContainer.innerHTML = '';
  timesForDate.forEach(time => {
    const timeSlotContainer = document.createElement('div');
    timeSlotContainer.className = 'time-slot-container';
    
    const timeSlot = document.createElement('button');
    timeSlot.className = 'time-slot';
    timeSlot.innerHTML = `<div class="time-time">${time.formatted_time}</div>`;
    timeSlot.onclick = () => selectTimeSlot(time, timeSlotContainer);
    
    // Store the time data on the container for reset purposes
    timeSlotContainer.timeData = time;
    
    timeSlotContainer.appendChild(timeSlot);
    timeSlotsContainer.appendChild(timeSlotContainer);
  });
}

// Select a time slot and show confirmation
function selectTimeSlot(time, container) {
  // Remove any existing selected state from other time slots
  document.querySelectorAll('.time-slot-container').forEach(c => {
    c.classList.remove('selected');
    // Reset to original state
    const timeSlot = c.querySelector('.time-slot');
    const confirmBtn = c.querySelector('.confirm-btn');
    if (confirmBtn) {
      confirmBtn.remove();
    }
    timeSlot.style.width = '100%';
    timeSlot.style.borderRadius = '8px';
    timeSlot.style.borderRight = '1px solid #e5e5e5';
    timeSlot.style.cursor = 'pointer';
    timeSlot.style.pointerEvents = 'auto';
    timeSlot.style.background = 'white';
    timeSlot.style.color = 'inherit';
    // Re-add click handler
    timeSlot.onclick = () => selectTimeSlot(c.timeData, c);
  });
  
  // Add selected state to current container
  container.classList.add('selected');
  
  // Create confirm button
  const confirmBtn = document.createElement('button');
  confirmBtn.className = 'confirm-btn';
  confirmBtn.textContent = 'Confirm';
  confirmBtn.onclick = (e) => {
    e.stopPropagation();
    window.location.href = `/booking/confirm?expert=${window.expertUsername}&datetime=${time.iso_datetime}&duration=30`;
  };
  
  // Adjust time slot styling and make it non-interactive
  const timeSlot = container.querySelector('.time-slot');
  timeSlot.style.width = '60%';
  timeSlot.style.borderRadius = '8px 0 0 8px';
  timeSlot.style.borderRight = '1px solid #e5e5e5';
  timeSlot.style.cursor = 'default';
  timeSlot.style.pointerEvents = 'none';
  timeSlot.style.background = '#f8f9fa';
  timeSlot.style.color = '#333';
  // Remove click handler
  timeSlot.onclick = null;
  
  // Add confirm button
  container.appendChild(confirmBtn);
}

// Format date for comparison with available times
function formatDateForComparison(date) {
  return date.toISOString().split('T')[0];
}

// Format date for display
function formatDateForDisplay(date) {
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
</script>
{% endblock %} 