{% extends "base.html" %}

{% block title %}{{ user.full_name or user.username }} - Droply{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <!-- Left: Mobile Profile UI -->
    <div class="col-lg-5 col-md-7 mb-4">
      <div class="card p-4" style="border-radius: 18px; background: #fff; box-shadow: 0 4px 24px 0 rgba(60,120,255,0.08);">
        <div id="mobileProfilePreview" style="width: 280px; height: 500px; border-radius: 28px; background: {{ user.background_color or '#f7faff' }}; box-shadow: 0 4px 24px 0 rgba(60,120,255,0.08); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 24px 12px; margin: 0 auto;">
          <!-- Profile Picture -->
          <div style="width: 100px; height: 100px; border-radius: 50%; background: #e3f0ff; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
            {% if user.profile_picture %}
            <img src="{{ user.profile_picture }}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
            {% else %}
            <i data-feather="user" style="width: 50px; height: 50px; color: #1a3a6d;"></i>
            {% endif %}
          </div>
          
          <!-- Name and Title -->
          <div class="fw-bold mb-1" style="font-size: 1.1rem;">{{ user.full_name or user.username }}</div>
          <div class="text-muted mb-2" style="font-size: 0.9rem;">{{ user.profession|title if user.profession else 'Professional' }}</div>
          
          <!-- Rating -->
          <div class="mb-3">
            <span class="fw-bold">{{ user.rating or '0.0' }}</span>
            <span style="color: #FFD600;">⭐</span>
            {% if user.rating_count and user.rating_count > 0 %}
            <span class="text-muted ms-1">({{ user.rating_count }})</span>
            {% endif %}
          </div>
          
          <!-- Bio -->
          <div class="mb-3" style="font-size: 0.85rem; color: #4a6fa1; text-align: center;">{{ user.bio or 'No bio yet.' }}</div>
          
          <!-- Hourly Rate -->
          {% if user.hourly_rate and user.hourly_rate > 0 %}
          <div class="mb-3"><span class="badge bg-primary">${{ user.hourly_rate }}/hr</span></div>
          {% endif %}
          
          <!-- Specialty Tags -->
          <div class="mb-3" style="text-align: center;">
            {% if user.specialty_tags %}
              {% for tag in user.get_specialty_tags() %}
              <span class="badge bg-light text-dark me-1 mb-1" style="font-size: 0.65rem; padding: 0.25rem 0.4rem;">{{ tag|title }}</span>
              {% endfor %}
            {% endif %}
          </div>
          
          <!-- Social Media Links -->
          <div class="d-flex gap-2 mb-3">
            {% if user.linkedin_url %}<a href="{{ user.linkedin_url }}" target="_blank"><i data-feather="linkedin"></i></a>{% endif %}
            {% if user.twitter_url %}<a href="{{ user.twitter_url }}" target="_blank"><i data-feather="twitter"></i></a>{% endif %}
            {% if user.github_url %}<a href="{{ user.github_url }}" target="_blank"><i data-feather="github"></i></a>{% endif %}
            {% if user.instagram_url %}<a href="{{ user.instagram_url }}" target="_blank"><i data-feather="instagram"></i></a>{% endif %}
            {% if user.facebook_url %}<a href="{{ user.facebook_url }}" target="_blank"><i data-feather="facebook"></i></a>{% endif %}
            {% if user.snapchat_url %}<a href="{{ user.snapchat_url }}" target="_blank"><i data-feather="user"></i></a>{% endif %}
            {% if user.website_url %}<a href="{{ user.website_url }}" target="_blank"><i data-feather="globe"></i></a>{% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Right: Booking & Availability -->
    <div class="col-lg-5 col-md-7 mb-4">
      <div class="card booking-card p-4 mb-3" style="border-radius: 18px; background: #fff; box-shadow: 0 4px 24px 0 rgba(60,120,255,0.08);">
        <div class="fw-bold mb-2">Book a video call</div>
        <div class="mb-2">1:1 Video Consultation</div>
        <div class="mb-2 text-muted">Book a 1:1 live video consultation & get personalized advice</div>
        {% if user.hourly_rate and user.hourly_rate > 0 %}
        <div class="mb-2"><span class="fw-bold">Starting at ${{ user.hourly_rate }}</span> <span class="ms-2">⭐ {{ user.rating or '0.0' }} {% if user.rating_count and user.rating_count > 0 %}({{ user.rating_count }}){% endif %}</span></div>
        {% else %}
        <div class="mb-2"><span class="fw-bold">Rate not set</span> <span class="ms-2">⭐ {{ user.rating or '0.0' }} {% if user.rating_count and user.rating_count > 0 %}({{ user.rating_count }}){% endif %}</span></div>
        {% endif %}
        
        <!-- Availability Status -->
        <div class="mb-2 text-muted">
          {% if user.is_available %}
            <span class="text-success">● Available for bookings</span>
          {% else %}
            <span class="text-danger">● Currently unavailable</span>
          {% endif %}
        </div>
        
        <button class="btn btn-primary w-100" id="see-times-btn" {% if not user.is_available %}disabled{% endif %}>See times</button>
      </div>
    </div>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="bookingModalLabel">Book a video call</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="btn-group w-100" role="group" aria-label="Session duration">
            <button type="button" class="btn btn-outline-primary duration-btn active" data-duration="15">Quick – 15 Min</button>
            <button type="button" class="btn btn-outline-primary duration-btn" data-duration="30">Regular – 30 Min</button>
            <button type="button" class="btn btn-outline-primary duration-btn" data-duration="45">Extra – 45 Min</button>
            <button type="button" class="btn btn-outline-primary duration-btn" data-duration="60">All Access – 60 Min</button>
          </div>
        </div>
        <div id="available-times-section">
          <!-- Times will be rendered here by JS -->
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-primary w-100" id="booking-next-btn">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="loginModalLabel">Create an account, or log in</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="login-form">
          <div class="mb-3">
            <label for="login-phone" class="form-label">Mobile number</label>
            <div class="input-group">
              <span class="input-group-text">+1</span>
              <input type="tel" class="form-control" id="login-phone" placeholder="Enter mobile number" required>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Continue</button>
        </form>
        <div class="mt-3 text-muted small">By continuing you agree to our <a href="#">Terms</a> and <a href="#">Privacy Policy</a>.</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Assume this is set by the backend (true/false)
window.isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};

document.addEventListener('DOMContentLoaded', function() {
  feather.replace();

  // Open booking modal
  const seeTimesBtn = document.getElementById('see-times-btn');
  if (seeTimesBtn) {
    seeTimesBtn.onclick = function() {
      var bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
      bookingModal.show();
      renderAvailableTimes(15); // default duration
    };
  }

  // Duration selection
  document.querySelectorAll('.duration-btn').forEach(btn => {
    btn.onclick = function() {
      document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      renderAvailableTimes(parseInt(this.dataset.duration));
    };
  });

  // Render available times based on actual availability
  function renderAvailableTimes(duration) {
    const section = document.getElementById('available-times-section');
    
    // Fetch actual availability from the backend
    fetch(`/api/availability/times?username={{ user.username }}`)
      .then(response => response.json())
      .then(data => {
        if (data.available && data.times && data.times.length > 0) {
          // Group times by day
          const timesByDay = {};
          data.times.forEach(timeSlot => {
            const dayKey = timeSlot.day_name;
            if (!timesByDay[dayKey]) {
              timesByDay[dayKey] = [];
            }
            timesByDay[dayKey].push(timeSlot);
          });
          
          let html = '<div class="mb-2 fw-bold">Available Times</div>';
          
          // Show each day's times
          Object.keys(timesByDay).forEach(day => {
            html += `<div class="mb-2 fw-bold">${day}</div>`;
            html += '<div class="d-flex flex-wrap gap-2 mb-3">';
            timesByDay[day].forEach(timeSlot => {
              html += `<button class="btn btn-outline-primary time-btn" data-datetime="${timeSlot.datetime}">${timeSlot.formatted}</button>`;
            });
            html += '</div>';
          });
          
          section.innerHTML = html;
        } else if (!data.available) {
          section.innerHTML = `
            <div class='alert alert-warning'>
              ${data.message || 'User is currently unavailable for bookings.'}
            </div>
          `;
        } else {
          section.innerHTML = `
            <div class='alert alert-info'>
              No available times found. Please try again later.
            </div>
          `;
        }
        
        // Time selection
        section.querySelectorAll('.time-btn').forEach(btn => {
          btn.onclick = function() {
            section.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
          };
        });
      })
      .catch(error => {
        console.error('Error fetching availability:', error);
        section.innerHTML = `
          <div class='alert alert-warning'>
            Unable to load availability. Please try again later.
          </div>
        `;
      });
  }

  // Booking Next button
  document.getElementById('booking-next-btn').onclick = function() {
    if (!window.isAuthenticated) {
      var loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      loginModal.show();
    } else {
      // Get selected time and duration
      const selectedTimeBtn = document.querySelector('.time-btn.active');
      const selectedDurationBtn = document.querySelector('.duration-btn.active');
      
      if (!selectedTimeBtn) {
        alert('Please select a time slot first.');
        return;
      }
      
      const selectedDateTime = selectedTimeBtn.dataset.datetime;
      const selectedDuration = selectedDurationBtn ? selectedDurationBtn.dataset.duration : 30;
      
      // Redirect to booking confirmation
      const confirmUrl = `/booking/confirm?expert={{ user.username }}&datetime=${selectedDateTime}&duration=${selectedDuration}`;
      window.location.href = confirmUrl;
    }
  };
});
</script>
{% endblock %} 