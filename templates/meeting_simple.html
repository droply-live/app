{% extends "base_signed_in.html" %}

{% block title %}Video Meeting - Droply{% endblock %}

{% block head %}
{{ super() }}
<!-- Feather Icons -->
<script src="https://unpkg.com/feather-icons"></script>
<style>
.meeting-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.meeting-header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.meeting-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.meeting-participants {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.participant-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
}

.connection-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.connection-status.connected {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.connection-status.connecting {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}

.connection-status.disconnected {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.meeting-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    padding-top: 100px; /* Make room for notice */
    min-height: 400px;
}

.meeting-notice {
    position: absolute;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 1rem 2rem;
    border-radius: 10px;
    backdrop-filter: blur(10px);
    z-index: 10;
    text-align: center;
    max-width: 600px;
}

.video-grid {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    padding: 2rem;
    align-items: center;
    justify-items: center;
    min-height: 300px;
    background: #f8f9fa;
    border-radius: 12px;
    margin: 1rem;
}

.video-container {
    position: relative;
    width: 100%;
    max-width: 500px;
    aspect-ratio: 16/9;
    border-radius: 12px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.video-element {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
    border-radius: 8px;
}

.video-overlay {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 14px;
    backdrop-filter: blur(10px);
}

.video-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #666;
    z-index: 5;
}

.meeting-footer {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    padding: 1rem 2rem;
    display: flex !important;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    min-height: 80px;
}

.control-btn {
    background: #f8f9fa;
    border: 1px solid #e5e5e5;
    color: #333;
    padding: 1rem;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.control-btn:hover {
    background: #e9ecef;
    transform: scale(1.05);
}

.control-btn.danger {
    background: #ef4444;
    color: white;
    border-color: #dc2626;
}

.control-btn.danger:hover {
    background: #dc2626;
    transform: scale(1.05);
}

.control-btn.secondary {
    background: #f8f9fa;
    color: #333;
}

.control-btn.secondary:hover {
    background: #e9ecef;
}

.control-btn.muted {
    background: #ef4444;
    color: white;
    border-color: #dc2626;
}

.control-btn.video-off {
    background: #ef4444;
    color: white;
    border-color: #dc2626;
}
</style>
{% endblock %}

{% block content %}
<div class="meeting-container">
    <!-- Meeting Header -->
    <div class="meeting-header">
        <div class="meeting-info">
            <div class="meeting-participants">
                <div class="participant-avatar">
                    {{ current_user.full_name[0] if current_user.full_name else current_user.username[0] }}
                </div>
                <span>{{ current_user.full_name or current_user.username }}</span>
                <span>•</span>
                <div class="participant-avatar">
                    {{ other_user.full_name[0] if other_user.full_name else other_user.username[0] }}
                </div>
                <span>{{ other_user.full_name or other_user.username }}</span>
            </div>
        </div>
        <div class="connection-status" id="connectionStatus">
            <i data-feather="loader" class="me-1"></i>Connecting...
        </div>
    </div>

    <!-- Meeting Main -->
    <div class="meeting-main">
        <div class="meeting-notice">
            <i data-feather="info" class="me-2"></i>
            <strong>Simple Video Call Mode:</strong> This is a basic video call using WebRTC. 
            For enhanced features like screen sharing and recording, please configure Daily.co API.
        </div>
        
        <div class="video-grid" id="video-grid">
            <div class="video-container">
                <video id="localVideo" class="video-element" autoplay muted playsinline style="background: #000;"></video>
                <div class="video-overlay">
                    {{ current_user.full_name or current_user.username }} (You)
                </div>
                <div class="video-placeholder" id="local-placeholder" style="display: none;">
                    <i class="fas fa-video" style="font-size: 3rem; color: #666;"></i>
                    <p>Your Camera</p>
                </div>
            </div>
            <div class="video-container">
                <video id="remoteVideo" class="video-element" autoplay playsinline style="background: #000;"></video>
                <div class="video-overlay">
                    {{ other_user.full_name or other_user.username }}
                </div>
                <div class="video-placeholder" id="remote-placeholder">
                    <i class="fas fa-user" style="font-size: 3rem; color: #666;"></i>
                    <p>Waiting for {{ other_user.full_name or other_user.username }}...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Meeting Footer -->
    <div class="meeting-footer" id="meeting-footer">
        <button class="control-btn secondary" onclick="toggleMute()" id="muteBtn">
            <i data-feather="mic"></i>
        </button>
        <button class="control-btn secondary" onclick="toggleVideo()" id="videoBtn">
            <i data-feather="video"></i>
        </button>
        <button class="control-btn danger" onclick="leaveMeeting()">
            <i data-feather="phone-off"></i>
        </button>
    </div>
    
    <!-- Debug info -->
    <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 9999;">
        <div>Controls Status: <span id="controls-status">Loading...</span></div>
        <div>Video Status: <span id="video-status">Loading...</span></div>
    </div>
</div>

<script>
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let isMuted = false;
let isVideoOn = true;

// Simple WebRTC configuration
const configuration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

async function initializeCall() {
    try {
        console.log('=== INITIALIZING VIDEO CALL ===');
        
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('getUserMedia not supported');
        }
        
        console.log('Requesting camera and microphone access...');
        
        // Get user media
        localStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
            audio: true
        });
        
        console.log('✓ Got local stream:', localStream);
        console.log('✓ Video tracks:', localStream.getVideoTracks().length);
        console.log('✓ Audio tracks:', localStream.getAudioTracks().length);
        
        // Show local video
        const localVideo = document.getElementById('localVideo');
        if (localVideo) {
            localVideo.srcObject = localStream;
            localVideo.muted = true; // Mute to prevent echo
            localVideo.playsInline = true;
            
            localVideo.onloadedmetadata = () => {
                console.log('✓ Local video metadata loaded');
                localVideo.play().catch(e => console.log('Play error:', e));
            };
            
            localVideo.onplay = () => {
                console.log('✓ Local video is playing');
            };
            
            console.log('✓ Local video element configured');
        }
        
        // Show placeholder for remote video
        const remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo) {
            // Don't modify the video element, show placeholder instead
            const placeholder = document.getElementById('remote-placeholder');
            if (placeholder) {
                placeholder.style.display = 'block';
            }
            console.log('✓ Remote video placeholder shown');
        }
        
        document.getElementById('video-status').textContent = 'Local Video Active';
        updateConnectionStatus('connected');
        
        console.log('✓ Video call initialized successfully');
        
    } catch (error) {
        console.error('✗ Error initializing video call:', error);
        document.getElementById('video-status').textContent = 'Camera/Mic Error';
        updateConnectionStatus('error');
        
        // Show detailed error message
        let errorMsg = 'Camera/Microphone access denied';
        if (error.name === 'NotAllowedError') {
            errorMsg = 'Please allow camera and microphone permissions';
        } else if (error.name === 'NotFoundError') {
            errorMsg = 'No camera or microphone found';
        } else if (error.name === 'NotSupportedError') {
            errorMsg = 'Camera/microphone not supported';
        }
        
        const remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo) {
            remoteVideo.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 2rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h4>Camera/Microphone Error</h4>
                <p>${errorMsg}</p>
                <small>Check browser permissions and try refreshing the page</small>
            </div>`;
        }
        
        // Also show in local video area
        const localVideo = document.getElementById('localVideo');
        if (localVideo) {
            localVideo.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 2rem;">
                <i class="fas fa-video-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h4>No Camera Access</h4>
                <p>Please allow camera permissions to start the call</p>
            </div>`;
        }
    }
}

function simulateAnswer() {
    // This is a simplified simulation - in a real app, you'd exchange offers/answers via signaling server
    console.log('Simulating answer from other participant...');
    updateConnectionStatus('connected');
    
    // Show a message about the simulation
    const notice = document.querySelector('.meeting-notice');
    notice.innerHTML = `
        <i data-feather="info" class="me-2"></i>
        <strong>Demo Mode:</strong> This is a simulation. In a real call, you would be connected to {{ other_user.full_name or other_user.username }}. 
        Your microphone and camera are working - try the controls below!
    `;
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
}

function updateConnectionStatus(status) {
    const statusEl = document.getElementById('connectionStatus');
    statusEl.className = `connection-status ${status}`;
    
    if (status === 'connected') {
        statusEl.innerHTML = '<i data-feather="wifi" class="me-1"></i>Connected';
    } else if (status === 'connecting') {
        statusEl.innerHTML = '<i data-feather="loader" class="me-1"></i>Connecting...';
    } else {
        statusEl.innerHTML = '<i data-feather="wifi-off" class="me-1"></i>Disconnected';
    }
    
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
}

function toggleMute() {
    if (localStream) {
        isMuted = !isMuted;
        localStream.getAudioTracks().forEach(track => {
            track.enabled = !isMuted;
        });
        
        const muteBtn = document.getElementById('muteBtn');
        if (isMuted) {
            muteBtn.innerHTML = '<i data-feather="mic-off"></i>';
            muteBtn.classList.add('muted');
        } else {
            muteBtn.innerHTML = '<i data-feather="mic"></i>';
            muteBtn.classList.remove('muted');
        }
        if (typeof feather !== 'undefined') {
        feather.replace();
    }
    }
}

function toggleVideo() {
    if (localStream) {
        isVideoOn = !isVideoOn;
        localStream.getVideoTracks().forEach(track => {
            track.enabled = isVideoOn;
        });
        
        const videoBtn = document.getElementById('videoBtn');
        if (!isVideoOn) {
            videoBtn.innerHTML = '<i data-feather="video-off"></i>';
            videoBtn.classList.add('video-off');
        } else {
            videoBtn.innerHTML = '<i data-feather="video"></i>';
            videoBtn.classList.remove('video-off');
        }
        if (typeof feather !== 'undefined') {
        feather.replace();
    }
    }
}

function leaveMeeting() {
    if (confirm('Are you sure you want to leave this meeting?')) {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        if (peerConnection) {
            peerConnection.close();
        }
        window.location.href = '{{ url_for("bookings") }}';
    }
}

function showError(message) {
    alert(message);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== VIDEO CALL DEBUG ===');
    console.log('Page loaded, initializing call...');
    
    // Always show controls first
    const footer = document.querySelector('.meeting-footer');
    if (footer) {
        footer.style.display = 'flex';
        console.log('✓ Controls should be visible');
        document.getElementById('controls-status').textContent = 'Visible';
    } else {
        console.error('✗ Controls not found!');
        document.getElementById('controls-status').textContent = 'Not Found';
    }
    
    // Check video elements
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const videoGrid = document.getElementById('video-grid');
    
    console.log('✓ Local video element:', !!localVideo);
    console.log('✓ Remote video element:', !!remoteVideo);
    console.log('✓ Video grid element:', !!videoGrid);
    
    if (videoGrid) {
        console.log('✓ Video grid is visible');
    } else {
        console.error('✗ Video grid not found!');
    }
    
    if (localVideo) {
        localVideo.style.border = '3px solid #007bff';
        console.log('✓ Local video styled with blue border');
    }
    if (remoteVideo) {
        remoteVideo.style.border = '3px solid #28a745';
        console.log('✓ Remote video styled with green border');
    }
    
    // Replace feather icons if available
    if (typeof feather !== 'undefined') {
        if (typeof feather !== 'undefined') {
        feather.replace();
    }
    } else {
        console.log('Feather icons not loaded, using fallback icons');
    }
    
    // Try to initialize video with better error handling
    setTimeout(() => {
        console.log('Starting video initialization...');
        initializeCall();
    }, 1000);
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    if (peerConnection) {
        peerConnection.close();
    }
});
</script>
{% endblock %} 