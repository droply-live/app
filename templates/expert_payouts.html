{% extends "base_signed_in.html" %}

{% block title %}Earnings - Droply{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Earnings Header -->
  <div class="mb-4">
    <h1 class="h2 mb-1">Earnings</h1>
    <p class="text-muted mb-0">Track your revenue and manage your payouts</p>
  </div>

  <!-- Tabbed Interface -->
  <div id="earnings-tabs" class="tabbed-interface">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="overview">
        <i class="fas fa-chart-line d-none d-md-inline"></i>
        <span>Overview</span>
      </button>
      <button class="tab-button" data-tab="withdraw">
        <i class="fas fa-dollar-sign d-none d-md-inline"></i>
        <span>Withdraw</span>
        {% set available_balance = (payouts|selectattr('status', 'equalto', 'pending')|sum(attribute='amount')) %}
        {% if available_balance > 0 %}
          <span class="badge badge-success">${{ "%.2f"|format(available_balance / 100) }}</span>
        {% endif %}
      </button>
      <button class="tab-button" data-tab="settings">
        <i class="fas fa-cog d-none d-md-inline"></i>
        <span>Settings</span>
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      <div id="overview" class="tab-pane active">
        <div class="row">
          <!-- Earnings Summary Cards -->
          <div class="col-md-4 mb-4">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-dollar-sign fa-2x text-success mb-3"></i>
                <h4>${{ "%.2f"|format((payouts|selectattr('status', 'equalto', 'paid')|sum(attribute='amount')) / 100) }}</h4>
                <p class="text-muted">Total Earned</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                <h4>${{ "%.2f"|format((payouts|selectattr('status', 'equalto', 'pending')|sum(attribute='amount')) / 100) }}</h4>
                <p class="text-muted">Available to Withdraw</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-calendar fa-2x text-primary mb-3"></i>
                <h4>{{ payouts|length }}</h4>
                <p class="text-muted">Total Sessions</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Recent Activity</h5>
            <p class="text-muted">Your latest earnings and transactions</p>
            
            {% if payouts %}
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Session</th>
                      <th>Amount</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for payout in payouts[:5] %}
                    <tr>
                      <td>{{ payout.created_at|format_datetime }}</td>
                      <td>{{ payout.description or 'Session' }}</td>
                      <td>${{ "%.2f"|format(payout.amount / 100) }}</td>
                      <td>
                        <span class="badge badge-{{ 'success' if payout.status == 'paid' else 'warning' if payout.status == 'pending' else 'danger' }}">
                          {{ payout.status|title }}
                        </span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-4">
                <i class="fas fa-dollar-sign fa-3x text-muted mb-3"></i>
                <h5>No Earnings Yet</h5>
                <p class="text-muted">Your earnings will appear here once you start completing sessions.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Withdraw Tab -->
      <div id="withdraw" class="tab-pane">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Withdraw Funds</h5>
                <p class="text-muted">Transfer your earnings to your connected payment method</p>
                
                {% set available_balance = (payouts|selectattr('status', 'equalto', 'pending')|sum(attribute='amount')) %}
                {% if available_balance > 0 %}
                  <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Available Balance</h6>
                    <h3 class="text-primary mb-0">${{ "%.2f"|format(available_balance / 100) }}</h3>
                    <small class="text-muted">Ready to withdraw</small>
                  </div>
                  
                  <form action="{{ url_for('request_payout') }}" method="POST">
                    <div class="form-group">
                      <label for="withdraw_amount">Withdrawal Amount</label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" 
                               class="form-control" 
                               id="withdraw_amount" 
                               name="amount" 
                               value="{{ "%.2f"|format(available_balance / 100) }}"
                               max="{{ "%.2f"|format(available_balance / 100) }}"
                               min="10"
                               step="0.01"
                               required>
                      </div>
                      <small class="text-muted">Minimum withdrawal: $10.00</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-dollar-sign"></i>
                      Request Withdrawal
                    </button>
                  </form>
                {% else %}
                  <div class="text-center py-4">
                    <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                    <h5>No Funds Available</h5>
                    <p class="text-muted">You need to complete sessions to earn money for withdrawal.</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Withdrawal Info</h6>
                <ul class="list-unstyled">
                  <li><i class="fas fa-clock text-warning"></i> Processing: 2-5 business days</li>
                  <li><i class="fas fa-percentage text-info"></i> Fee: 2.9% + $0.30</li>
                  <li><i class="fas fa-dollar-sign text-success"></i> Minimum: $10.00</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settings" class="tab-pane">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Payment Settings</h5>
            <p class="text-muted">Configure your Stripe Connect account to receive payments</p>
            
            {% if current_user.stripe_account_id %}
              <div class="alert alert-success">
                <h6><i class="fas fa-check-circle"></i> Stripe Connected</h6>
                <p class="mb-0">Your account is connected to Stripe and ready to receive payments.</p>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h6>Account Status</h6>
                      <p class="mb-2">
                        <span class="badge badge-success">Active</span>
                        <small class="text-muted">Verified and ready</small>
                      </p>
                                             <a href="{{ url_for('expert_stripe_onboarding') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-external-link-alt"></i>
                        View Stripe Dashboard
                      </a>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h6>Payment Method</h6>
                      <p class="mb-2">
                        <i class="fas fa-credit-card"></i>
                        <span>Connected to Stripe</span>
                      </p>
                      <button class="btn btn-outline-secondary btn-sm" onclick="updateStripeSettings()">
                        <i class="fas fa-cog"></i>
                        Update Settings
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle"></i> Setup Required</h6>
                <p class="mb-0">You need to connect your Stripe account to receive payments.</p>
              </div>
              
              <div class="text-center py-4">
                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                <h5>Connect Your Payment Method</h5>
                <p class="text-muted">Set up Stripe Connect to start receiving payments for your sessions.</p>
                
                                 <a href="{{ url_for('expert_stripe_onboarding') }}" class="btn btn-primary btn-lg">
                  <i class="fas fa-link"></i>
                  Connect Stripe Account
                </a>
                
                <div class="mt-3">
                  <small class="text-muted">
                    <i class="fas fa-shield-alt"></i>
                    Secure payment processing powered by Stripe
                  </small>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Hamburger Menu -->
<div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
<div class="mobile-nav-menu" id="mobileNavMenu">
  <div class="mobile-nav-header">
    <h5>Navigation</h5>
    <button class="mobile-nav-close" id="mobileNavClose">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="mobile-nav-content">
    <a href="{{ url_for('dashboard') }}" class="mobile-nav-item">
      <i class="fas fa-home"></i>
      <span>Dashboard</span>
    </a>
    <a href="{{ url_for('bookings') }}" class="mobile-nav-item">
      <i class="fas fa-calendar-check"></i>
      <span>Bookings</span>
    </a>
    <a href="{{ url_for('account') }}" class="mobile-nav-item">
      <i class="fas fa-user"></i>
      <span>Account</span>
    </a>
    <a href="{{ url_for('expert_payouts') }}" class="mobile-nav-item active">
      <i class="fas fa-dollar-sign"></i>
      <span>Earnings</span>
    </a>
    <a href="{{ url_for('logout') }}" class="mobile-nav-item">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </a>
  </div>
</div>

<!-- Hamburger Button -->
<button class="mobile-hamburger" id="mobileHamburger">
  <span></span>
  <span></span>
  <span></span>
</button>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
<script src="{{ url_for('static', filename='js/mobile-enhancements.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tabs
  initializeTabs('earnings-tabs');
  
  // Initialize mobile navigation
  initializeMobileNavigation();
  
  // Handle withdrawal amount validation
  const withdrawAmount = document.getElementById('withdraw_amount');
  if (withdrawAmount) {
    withdrawAmount.addEventListener('input', function() {
      const maxAmount = parseFloat(this.getAttribute('max'));
      const currentAmount = parseFloat(this.value);
      
      if (currentAmount > maxAmount) {
        this.value = maxAmount.toFixed(2);
      }
    });
  }
});

function updateStripeSettings() {
  window.location.href = "{{ url_for('expert_stripe_onboarding') }}";
}
</script>
{% endblock %} 